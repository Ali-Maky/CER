<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CER Impact Dashboard | Secure</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  
  <style>
    /* --- THEME VARIABLES --- */
    :root { 
        --bg-main: #040011; 
        --bg-card: #0c071d; 
        --bg-card-soft: #120a2a;
        --accent: #d946ef; 
        --accent-hover: #c026d3;
        --text-main: #f9fafb; 
        --text-muted: #9ca3af; 
        --border: rgba(255,255,255,0.1);
        --success: #4ade80; 
        --danger: #f87171; 
        --warning: #facc15; 
    }
    
    * { box-sizing: border-box; }
    body { margin: 0; padding: 0; background: radial-gradient(circle at top left, #321b5d 0, #040011 45%, #02000a 100%); color: var(--text-main); font-family: 'Segoe UI', system-ui, sans-serif; min-height: 100vh; }
    
    /* --- LOGIN SCREEN --- */
    #authScreen { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; width: 100%; position: fixed; top: 0; left: 0; z-index: 2000; background: var(--bg-main); }
    .auth-box { background: var(--bg-card); padding: 40px; border-radius: 20px; border: 1px solid var(--border); width: 90%; max-width: 400px; text-align: center; box-shadow: 0 0 50px rgba(217,70,239,0.1); }
    .auth-logo { width: 60px; height: 60px; border-radius: 50%; background: var(--accent); margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; font-size: 32px; font-weight: bold; color: #fff; box-shadow: 0 0 20px var(--accent); }
    .auth-input { width: 100%; padding: 14px; margin-bottom: 12px; background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 8px; color: #fff; outline: none; transition: 0.3s; }
    .auth-input:focus { border-color: var(--accent); background: rgba(255,255,255,0.1); }
    .auth-btn { width: 100%; padding: 14px; background: var(--accent); color: #fff; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.2s; font-size: 16px; margin-top: 10px; }
    .auth-btn:hover { background: var(--accent-hover); transform: translateY(-2px); }
    .auth-link { margin-top: 20px; font-size: 13px; color: var(--text-muted); cursor: pointer; text-decoration: underline; }
    .auth-link:hover { color: #fff; }

    /* --- DASHBOARD LAYOUT --- */
    #mainApp { display: none; padding: 24px; max-width: 1800px; margin: 0 auto; }
    .top-nav { display: flex; align-items: center; justify-content: space-between; margin-bottom: 30px; flex-wrap: wrap; gap: 20px; }
    .nav-left { display: flex; align-items: center; gap: 12px; }
    .status-badge { padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
    .s-pending { background: rgba(250,204,21,0.15); color: var(--warning); border: 1px solid rgba(250,204,21,0.3); }
    .s-viewer { background: rgba(56,189,248,0.15); color: #38bdf8; border: 1px solid rgba(56,189,248,0.3); }
    .s-admin { background: rgba(217,70,239,0.15); color: var(--accent); border: 1px solid rgba(217,70,239,0.3); }

    .nav-right { display: flex; align-items: center; gap: 10px; }
    .btn-nav { background: rgba(255,255,255,0.05); color: var(--text-muted); border: 1px solid var(--border); padding: 8px 16px; border-radius: 8px; cursor: pointer; transition: 0.2s; font-size: 13px; font-weight: 500; display: flex; align-items: center; gap: 6px; }
    .btn-nav:hover { background: rgba(255,255,255,0.1); color: #fff; border-color: rgba(255,255,255,0.2); }
    .btn-primary { background: var(--accent); color: #fff; border: none; }
    .btn-primary:hover { background: var(--accent-hover); }

    /* --- ADMIN PANEL --- */
    #adminPanel { display: none; background: var(--bg-card); padding: 24px; border-radius: 20px; border: 1px solid var(--border); margin-bottom: 30px; box-shadow: 0 20px 40px rgba(0,0,0,0.3); }
    .admin-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); padding-bottom: 15px; margin-bottom: 20px; }
    .admin-tabs { display: flex; gap: 10px; }
    .tab-btn { background: transparent; border: none; color: var(--text-muted); padding: 8px 12px; cursor: pointer; font-weight: 600; border-radius: 6px; transition: 0.2s; }
    .tab-btn.active { background: rgba(217,70,239,0.1); color: var(--accent); }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    .user-row { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(255,255,255,0.02); border-radius: 8px; margin-bottom: 8px; border: 1px solid var(--border); }
    .btn-action { padding: 4px 10px; border-radius: 6px; border: none; cursor: pointer; font-size: 11px; font-weight: 700; margin-left: 8px; }
    .btn-approve { background: var(--success); color: #052e16; }
    .btn-reject { background: var(--danger); color: #450a0a; }

    /* --- DASHBOARD CARDS & GRIDS --- */
    .grid { display: grid; gap: 20px; margin-bottom: 20px; }
    .grid-4 { grid-template-columns: repeat(4, 1fr); }
    .grid-3 { grid-template-columns: repeat(3, 1fr); }
    .grid-2 { grid-template-columns: repeat(2, 1fr); }
    @media (max-width: 1200px) { .grid-4 { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 900px) { .grid-3 { grid-template-columns: 1fr; } .grid-2 { grid-template-columns: 1fr; } }
    @media (max-width: 600px) { .grid-4 { grid-template-columns: 1fr; } }

    .card { background: linear-gradient(145deg, var(--bg-card) 0, var(--bg-card-soft) 100%); border-radius: 16px; padding: 20px; border: 1px solid var(--border); box-shadow: 0 10px 30px rgba(0,0,0,0.2); display: flex; flex-direction: column; }
    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .card-title { font-size: 11px; letter-spacing: 1px; text-transform: uppercase; color: var(--text-muted); font-weight: 600; }
    .kpi-big { font-size: 36px; font-weight: 800; color: #fff; margin-bottom: 5px; }
    .kpi-delta { font-size: 12px; font-weight: 500; }
    .delta-up { color: var(--success); }
    .delta-down { color: var(--danger); }
    .chart-box { height: 250px; position: relative; width: 100%; }

    /* --- CONTROLS --- */
    .pill-select { background: rgba(255,255,255,0.05); border: 1px solid var(--border); color: #fff; padding: 6px 12px; border-radius: 20px; outline: none; font-size: 12px; cursor: pointer; }
    .pill-select option { background: var(--bg-card); color: #fff; }

    /* --- TOAST NOTIFICATION --- */
    #toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 8px; padding: 16px; position: fixed; z-index: 9999; bottom: 30px; left: 50%; transform: translateX(-50%); border: 1px solid var(--accent); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
    #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
    @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
    @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
  </style>
</head>
<body>

  <div id="authScreen">
    <div class="auth-box">
        <div class="auth-logo">Z</div>
        <h2 id="authTitle" style="margin:0 0 10px 0;">Sign In</h2>
        <p id="authSub" style="color:var(--text-muted); margin-bottom:30px;">Corporate Entrepreneurship Responsibility</p>
        
        <input type="email" id="email" class="auth-input" placeholder="Email Address">
        <input type="password" id="password" class="auth-input" placeholder="Password">
        
        <button id="mainAuthBtn" class="auth-btn" onclick="handleLogin()">Sign In</button>
        <div id="authMsg" style="margin-top:20px; font-size:13px; min-height:20px;"></div>
        
        <div class="auth-link" onclick="toggleAuthMode()" id="toggleAuthText">No account? Request Access</div>
    </div>
  </div>

  <div id="mainApp">
    
    <div class="top-nav">
      <div class="nav-left">
        <div style="font-weight:800; font-size:20px; color:#fff;">CER <span style="font-weight:400; color:var(--text-muted);">Impact Dashboard</span></div>
        <div id="roleBadge" class="status-badge s-viewer">Viewer</div>
      </div>
      <div class="nav-right">
        <div class="pill-select-wrapper">
            Year: <select id="viewYear" class="pill-select" onchange="fetchAllData()">
                <option value="2026">2026</option>
                <option value="2025" selected>2025</option>
                <option value="2024">2024</option>
            </select>
        </div>
        <button id="btnAdminPanel" class="btn-nav btn-primary" style="display:none;" onclick="toggleAdminPanel()">
            <span class="material-icons" style="font-size:16px;">admin_panel_settings</span> Admin
        </button>
        <button class="btn-nav" onclick="handleLogout()">Sign Out</button>
      </div>
    </div>

    <div id="adminPanel">
        <div class="admin-header">
            <h3 style="margin:0;">Admin Console</h3>
            <div class="admin-tabs">
                <button class="tab-btn active" onclick="showAdminTab('users', this)">User Approvals</button>
                <button class="tab-btn" onclick="showAdminTab('ai', this)">AI Report</button>
            </div>
        </div>

        <div id="adminTabUsers" class="tab-content active">
            <div id="userList">Loading requests...</div>
        </div>

        <div id="adminTabAI" class="tab-content">
            <div style="background:rgba(217,70,239,0.05); padding:20px; border-radius:10px; border:1px solid rgba(217,70,239,0.2); display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <h4 style="margin:0 0 5px 0; color:var(--accent);">Generate Annual Summary</h4>
                    <p style="margin:0; font-size:12px; color:var(--text-muted);">Uses Gemini 2.0 to analyze current data and write an executive summary.</p>
                </div>
                <button id="btnGenSummary" class="btn-nav btn-primary" onclick="generateAndSaveSummary()">✨ Generate Report</button>
            </div>
        </div>
    </div>

    <div style="display:flex; justify-content:flex-end; margin-bottom:20px; gap:10px;">
        <select id="quarterFilter" class="pill-select" onchange="applyFilters()">
            <option value="all">All Year</option>
            <option value="q1">Q1</option>
            <option value="q2">Q2</option>
            <option value="q3">Q3</option>
            <option value="q4">Q4</option>
        </select>
        <select id="currencySelector" class="pill-select" onchange="applyFilters()">
            <option value="IQD">IQD (د.ع)</option>
            <option value="USD">USD ($)</option>
        </select>
    </div>

    <div class="grid grid-4">
        <div class="card">
            <div class="card-header"><div class="card-title">Activities</div><span class="material-icons" style="color:var(--accent); font-size:16px;">event</span></div>
            <div id="kpiActivities" class="kpi-big">...</div>
            <div id="kpiActivitiesDelta" class="kpi-delta"></div>
            <div style="font-size:11px; color:var(--accent); margin-top:6px;"><span id="kpiZainRate">0%</span> Zain Led</div>
        </div>
        <div class="card">
            <div class="card-header"><div class="card-title">Participants</div><span class="material-icons" style="color:var(--success); font-size:16px;">groups</span></div>
            <div id="kpiAudience" class="kpi-big">...</div>
            <div id="kpiAudienceDelta" class="kpi-delta"></div>
        </div>
        <div class="card">
            <div class="card-header"><div class="card-title">Total Investment</div><span class="material-icons" style="color:var(--warning); font-size:16px;">payments</span></div>
            <div id="kpiBudget" class="kpi-big" style="font-size:24px;">...</div>
            <div id="kpiBudgetDelta" class="kpi-delta"></div>
        </div>
        <div class="card">
            <div class="card-header"><div class="card-title">Cities Covered</div><span class="material-icons" style="color:#38bdf8; font-size:16px;">public</span></div>
            <div id="kpiCities" class="kpi-big">...</div>
            <div id="kpiCitiesDelta" class="kpi-delta"></div>
        </div>
    </div>

    <div class="grid grid-2">
        <div class="card">
            <div class="card-header">
                <div class="card-title">Activities Timeline</div>
                <select id="actChartFilter" class="pill-select" onchange="updateActivitiesChart()"></select>
            </div>
            <div class="chart-box"><canvas id="activitiesChart"></canvas></div>
        </div>
        <div class="card">
            <div class="card-header">
                <div class="card-title">Gender Distribution</div>
                <select id="genderYearFilter" class="pill-select" onchange="updateGenderChart()"><option value="all">All Years</option></select>
            </div>
            <div style="display:flex; align-items:center; height:100%;">
                <div style="flex:1; position:relative; height:200px;"><canvas id="genderChart"></canvas></div>
                <div id="genderLegend" style="width:120px; font-size:12px;"></div>
            </div>
        </div>
    </div>

    <div id="rowSocial" class="grid grid-4">
        <div class="card"><div class="card-title">Social Reach</div><div id="kpiSocialReach" class="kpi-big" style="font-size:24px;">...</div></div>
        <div class="card"><div class="card-title">Engagement</div><div id="kpiSocialEngagement" class="kpi-big" style="font-size:24px;">...</div></div>
        <div class="card"><div class="card-title">Interaction</div><div id="kpiSocialInteraction" class="kpi-big" style="font-size:24px;">...</div></div>
        <div class="card"><div class="card-title">Impressions</div><div id="kpiSocialImpression" class="kpi-big" style="font-size:24px;">...</div></div>
    </div>

    <div id="trendChartsRow" class="grid grid-2">
        <div class="card">
            <div class="card-header"><div class="card-title">Female Participation Trend</div></div>
            <div class="chart-box"><canvas id="genderLineChart"></canvas></div>
        </div>
        <div class="card">
            <div class="card-header"><div class="card-title">Activity Growth Trend</div></div>
            <div class="chart-box"><canvas id="activitiesTrendChart"></canvas></div>
        </div>
    </div>

  </div> <div id="toast">Notification</div>

<script>
  // ⚠️ 1. CONFIGURATION: PASTE KEYS HERE
  const supabaseUrl = 'https://xeohzbdgjgusavfonfkf.supabase.co'; 
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhlb2h6YmRnamd1c2F2Zm9uZmtmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5NjU5NzAsImV4cCI6MjA4MTU0MTk3MH0.5gO_0YgVdk9OFfrJuUrewhierc2wE7lVUst9vYd_DH4';
  const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

  // Constants
  const COLS_LOGISTICS = { name: "Activity Name", start_date: "Start Date", city: "City", audience: "Total Audience", budget: "Total Budget", status: "Status", year: "Year", is_zain: "is_zain_implemented" };
  const COLS_SOCIAL = { year: "Year", reach: "Reach", engagement: "Engagement", interaction: "Interaction", impression: "Impression" };
  const IQD_RATE = 1320;

  // State
  let isSignUp = false;
  let userRole = 'pending';
  let allLogistics = [], currentLogistics = [], comparisonLogistics = [], yearlyMetricsArray = [], rawSocial = [], rawRegistration = [];
  
  // Charts
  let activitiesChartInstance = null, genderChartInstance = null, genderLineChartInstance = null, activitiesTrendChartInstance = null;

  // --- AUTH SYSTEM ---
  function toggleAuthMode() {
      isSignUp = !isSignUp;
      document.getElementById('authTitle').innerText = isSignUp ? "Request Access" : "Sign In";
      document.getElementById('mainAuthBtn').innerText = isSignUp ? "Submit Request" : "Sign In";
      document.getElementById('toggleAuthText').innerText = isSignUp ? "Already have an account? Sign In" : "No account? Request Access";
      document.getElementById('authMsg').innerText = "";
  }

  async function handleLogin() {
      const email = document.getElementById('email').value;
      const pass = document.getElementById('password').value;
      const msg = document.getElementById('authMsg');
      
      msg.style.color = "#fff"; msg.innerText = "Verifying...";

      if(isSignUp) {
          const { data, error } = await supabaseClient.auth.signUp({ email, password: pass });
          if(error) { msg.style.color = "var(--danger)"; msg.innerText = error.message; }
          else { msg.style.color = "var(--success)"; msg.innerText = "Account created. Please wait for Admin approval."; }
      } else {
          const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password: pass });
          if(error) { msg.style.color = "var(--danger)"; msg.innerText = "Invalid credentials."; }
          else { checkUserRole(data.user.id); }
      }
  }

  async function checkUserRole(uid) {
      const { data, error } = await supabaseClient.from('profiles').select('role').eq('id', uid).single();
      
      if(error || !data) {
          document.getElementById('authMsg').innerText = "Profile not found. Contact Admin.";
          return;
      }

      if(data.role === 'pending') {
          document.getElementById('authMsg').style.color = "var(--warning)";
          document.getElementById('authMsg').innerText = "Your account is pending Admin approval.";
          await supabaseClient.auth.signOut();
      } else {
          // Access Granted
          userRole = data.role;
          document.getElementById('authScreen').style.display = 'none';
          document.getElementById('mainApp').style.display = 'block';
          
          document.getElementById('roleBadge').innerText = userRole.toUpperCase();
          document.getElementById('roleBadge').className = `status-badge s-${userRole}`;
          
          if(userRole === 'admin') {
              document.getElementById('btnAdminPanel').style.display = 'flex';
              fetchUsersList();
          }
          
          fetchAllData();
      }
  }

  async function handleLogout() {
      await supabaseClient.auth.signOut();
      location.reload();
  }

  // --- ADMIN SYSTEM ---
  function toggleAdminPanel() {
      const p = document.getElementById('adminPanel');
      p.style.display = p.style.display === 'none' ? 'block' : 'none';
  }
  function showAdminTab(tab, btn) {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      btn.classList.add('active');
      if(tab === 'users') document.getElementById('adminTabUsers').classList.add('active');
      if(tab === 'ai') document.getElementById('adminTabAI').classList.add('active');
  }

  async function fetchUsersList() {
      const { data, error } = await supabaseClient.from('profiles').select('*').order('created_at', {ascending: false});
      if(data) {
          let html = '';
          data.forEach(user => {
              if(user.role === 'admin') return; 
              html += `
              <div class="user-row">
                  <div>
                      <div style="font-size:13px; font-weight:600; color:#fff;">${user.email}</div>
                      <div class="status-badge s-${user.role}" style="display:inline-block; margin-top:4px;">${user.role}</div>
                  </div>
                  <div>
                      ${user.role === 'pending' ? `<button class="btn-action btn-approve" onclick="updateUserRole('${user.id}','viewer')">Approve</button>` : ''}
                      ${user.role === 'viewer' ? `<button class="btn-action btn-reject" onclick="updateUserRole('${user.id}','pending')">Revoke</button>` : ''}
                  </div>
              </div>`;
          });
          document.getElementById('userList').innerHTML = html || '<div style="color:#666; font-size:12px;">No pending requests.</div>';
      }
  }

  async function updateUserRole(uid, newRole) {
      const { error } = await supabaseClient.from('profiles').update({ role: newRole }).eq('id', uid);
      if(!error) { showToast("User Updated"); fetchUsersList(); }
  }

  // --- DATA LOADING ---
  async function fetchAllData() {
      try {
          const selectedYear = parseInt(document.getElementById("viewYear").value) || 2025;
          const prevYear = selectedYear - 1;

          const { data: allLogs, error } = await supabaseClient.from('logistics_all').select('*');
          if(error) throw error;
          
          allLogistics = allLogs || [];
          currentLogistics = allLogistics.filter(row => row.Year == selectedYear);
          comparisonLogistics = allLogistics.filter(row => row.Year == prevYear);

          // Metrics & Social
          const { data: metrics } = await supabaseClient.from('yearly_metrics').select('*');
          yearlyMetricsArray = metrics || [];

          if(rawSocial.length === 0) {
              const { data: soc } = await supabaseClient.from('social_media').select('*').range(0,5000);
              rawSocial = soc || [];
              const d1 = await fetchAllRows('registration', '2025');
              const d2 = await fetchAllRows('the_station_database', '2023');
              const d3 = await fetchAllRows('makers_of_baghdad_database', '2025');
              rawRegistration = [...d1, ...d2, ...d3];
              populateYearFilters();
          }

          updateActivitiesChart();
          applyFilters();
          updateGenderChart();
          renderGenderLineChart();
          renderActivitiesTrendChart();

      } catch (err) { console.error("Data Error:", err); }
  }

  // --- DASHBOARD LOGIC ---
  function applyFilters() {
    const qFilter = document.getElementById("quarterFilter").value;
    const isAll = (qFilter === "all");
    
    // Toggle Trend Charts
    const trendRow = document.getElementById("trendChartsRow");
    if(trendRow) trendRow.style.display = isAll ? "grid" : "none";

    const mCurr = computeMetrics(currentLogistics, qFilter);
    const mPrev = (comparisonLogistics.length > 0) ? computeMetrics(comparisonLogistics, qFilter) : { activities:0, audience:0, budget:0, cities:0 };
    
    // Update KPIs
    document.getElementById("kpiActivities").textContent = mCurr.activities.toLocaleString();
    document.getElementById("kpiAudience").textContent = mCurr.audience.toLocaleString();
    document.getElementById("kpiCities").textContent = mCurr.cities.toLocaleString();
    
    const zainRate = mCurr.activities > 0 ? ((mCurr.zainLed / mCurr.activities) * 100).toFixed(1) : 0;
    document.getElementById("kpiZainRate").textContent = zainRate + "%";

    // Budget
    const currency = document.getElementById("currencySelector").value;
    document.getElementById("kpiBudget").textContent = formatMoney(mCurr.budget, currency);

    // Deltas
    setDelta("kpiActivitiesDelta", mCurr.activities, mPrev.activities);
    setDelta("kpiAudienceDelta", mCurr.audience, mPrev.audience);
    setDelta("kpiBudgetDelta", mCurr.budget, mPrev.budget);
    setDelta("kpiCitiesDelta", mCurr.cities, mPrev.cities);

    // Social
    updateSocialKPIs(document.getElementById("viewYear").value);
  }

  function computeMetrics(data, quarterFilter) {
    let activities = 0, totalAudience = 0, totalBudget = 0, zainLed = 0; 
    const citySet = new Set(); 
    const selectedYear = parseInt(document.getElementById("viewYear").value) || 2025;
    
    data.forEach(row => {
      const status = String(row[COLS_LOGISTICS.status] || "").toLowerCase();
      if (status.includes("cancel") || status.includes("postpon")) return;
      if (quarterFilter !== "all") { 
          const dObj = parseCustomDate(row[COLS_LOGISTICS.start_date], selectedYear); 
          if (!dObj || getQuarter(dObj) !== quarterFilter) return; 
      }
      
      const city = String(row[COLS_LOGISTICS.city] || "").trim().toLowerCase();
      const isOnline = city.includes("online") || city.includes("virtual") || city.includes("zoom");

      activities++; 
      if(!isOnline) totalAudience += toNumberSmart(row[COLS_LOGISTICS.audience]);
      totalBudget += toNumberSmart(row[COLS_LOGISTICS.budget]);
      if (row[COLS_LOGISTICS.is_zain] === true) zainLed++;
      if (city && city !== "city" && !isOnline) citySet.add(city);
    }); 
    return { activities, audience: totalAudience, budget: totalBudget, cities: citySet.size, zainLed };
  }

  function updateSocialKPIs(selectedYear) {
      let reach=0, engage=0, interact=0, impress=0;
      rawSocial.forEach(row => { 
        if (String(row[COLS_SOCIAL.year]).trim() == selectedYear) { 
           reach += toNumberSmart(row[COLS_SOCIAL.reach]); 
           engage += toNumberSmart(row[COLS_SOCIAL.engagement]); 
           interact += toNumberSmart(row[COLS_SOCIAL.interaction]); 
           impress += toNumberSmart(row[COLS_SOCIAL.impression]); 
        } 
      });
      document.getElementById("kpiSocialReach").textContent = reach.toLocaleString();
      document.getElementById("kpiSocialEngagement").textContent = engage.toLocaleString();
      document.getElementById("kpiSocialInteraction").textContent = interact.toLocaleString();
      document.getElementById("kpiSocialImpression").textContent = impress.toLocaleString();
  }

  // --- CHART RENDERERS ---
  function updateActivitiesChart() {
      const filter = document.getElementById("actChartFilter").value;
      const mCounts = Array(12).fill(0);
      let dataset = (filter === "all") ? allLogistics : allLogistics.filter(row => row.Year == filter);
      dataset.forEach(row => { const d = parseCustomDate(row[COLS_LOGISTICS.start_date], row.Year); if(d) mCounts[d.getMonth()]++; });
      
      if (activitiesChartInstance) activitiesChartInstance.destroy();
      const ctx = document.getElementById("activitiesChart");
      activitiesChartInstance = new Chart(ctx, { type: "bar", data: { labels: ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"], datasets:[{ label: filter, data: mCounts, backgroundColor:"#d946ef", borderRadius:4 }] }, options: { maintainAspectRatio: false, plugins: { legend: { display:false } }, scales:{ y:{ grid:{ color:"#333"} }, x:{ grid:{ display:false } } } } });
  }

  function updateGenderChart() {
      const yearFilter = document.getElementById("genderYearFilter").value;
      let male=0, female=0;
      rawRegistration.forEach(row => { 
          if (yearFilter !== "all" && row._derivedYear !== yearFilter) return; 
          const g = String(getSmartValue(row, ["Gender", "Sex"])).toLowerCase(); 
          if (g.includes("female") || g === "f") female++; else if (g.includes("male") || g === "m") male++; 
      });
      
      const total = male + female;
      const fPct = total > 0 ? ((female/total)*100).toFixed(1) : 0;
      document.getElementById("genderLegend").innerHTML = `<div style="margin-bottom:5px; color:#f472b6;">Female: ${fPct}%</div><div style="color:#38bdf8;">Male: ${(100-fPct).toFixed(1)}%</div>`;

      if (genderChartInstance) genderChartInstance.destroy();
      genderChartInstance = new Chart(document.getElementById("genderChart"), { type: "doughnut", data: { labels: ["Male","Female"], datasets:[{ data:[male, female], backgroundColor:["#38bdf8", "#f472b6"], borderWidth:0, cutout:'70%' }] }, options: { maintainAspectRatio: false, plugins: { legend: { display: false } } } });
  }

  function renderGenderLineChart() {
      const yearStats = {};
      rawRegistration.forEach(row => {
          const y = row._derivedYear;
          if(!yearStats[y]) yearStats[y] = { m:0, f:0 };
          const g = String(getSmartValue(row, ["Gender", "Sex"])).toLowerCase();
          if (g.includes("female") || g === "f") yearStats[y].f++; else yearStats[y].m++;
      });
      const years = Object.keys(yearStats).sort();
      const pct = years.map(y => (yearStats[y].f / (yearStats[y].f + yearStats[y].m)) * 100);
      
      if (genderLineChartInstance) genderLineChartInstance.destroy();
      genderLineChartInstance = new Chart(document.getElementById("genderLineChart"), { type: 'line', data: { labels: years, datasets: [{ label: 'Female %', data: pct, borderColor: '#f472b6', backgroundColor: 'rgba(244, 114, 182, 0.2)', fill: true }] }, options: { maintainAspectRatio: false, plugins:{legend:{display:false}}, scales:{y:{grid:{color:'#333'}}} } });
  }

  function renderActivitiesTrendChart() {
      const yearCounts = {};
      allLogistics.forEach(row => { const y = row.Year; if(y) yearCounts[y] = (yearCounts[y] || 0) + 1; });
      const years = Object.keys(yearCounts).sort();
      const counts = years.map(y => yearCounts[y]);
      
      if (activitiesTrendChartInstance) activitiesTrendChartInstance.destroy();
      activitiesTrendChartInstance = new Chart(document.getElementById("activitiesTrendChart"), { type: 'line', data: { labels: years, datasets: [{ label: 'Activities', data: counts, borderColor: '#d946ef', backgroundColor: 'rgba(217, 70, 239, 0.1)', fill: true }] }, options: { maintainAspectRatio: false, plugins:{legend:{display:false}}, scales:{y:{grid:{color:'#333'}}} } });
  }

  // --- AI GENERATOR ---
  async function generateAndSaveSummary() {
    const year = document.getElementById("viewYear").value;
    const btn = document.getElementById("btnGenSummary");
    let apiKey = localStorage.getItem("gemini_api_key");
    if (!apiKey) { apiKey = prompt("Please enter Gemini API Key (Admin Only):"); if (!apiKey) return; localStorage.setItem("gemini_api_key", apiKey); }
    
    // Data Prep
    const actCount = currentLogistics.length; 
    const totalAud = currentLogistics.reduce((acc, r) => acc + toNumberSmart(r[COLS_LOGISTICS.audience]||0), 0);
    const totalSpent = currentLogistics.reduce((acc, r) => acc + toNumberSmart(r[COLS_LOGISTICS.budget]||0), 0);
    const zainCount = currentLogistics.filter(r => r[COLS_LOGISTICS.is_zain]===true).length;
    const zainRate = actCount > 0 ? ((zainCount/actCount)*100).toFixed(0) : 0;
    
    btn.innerText = "Generating..."; btn.disabled = true;

    try {
        const prompt = `Act as the Head of Innovation & Entrepreneurship at Zain Iraq. Write a powerful executive summary for ${year}. DEFINITION: CER = Corporate Entrepreneurship Responsibility (NOT Social). Data: ${actCount} activities, ${totalAud} participants, ${totalSpent} IQD investment, ${zainRate}% direct implementation. Focus on ecosystem building and ROI.`;
        
        // Correct Model: gemini-2.0-flash
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
        
        if (!response.ok) throw new Error("AI Request Failed");
        const data = await response.json();
        const aiText = data.candidates[0].content.parts[0].text;
        
        const { error } = await supabaseClient.from('yearly_metrics').update({ executive_summary: aiText }).eq('year', year);
        if(error) throw error;
        
        showToast("Report Updated!");
    } catch (err) { alert(err.message); } finally { btn.innerText = "✨ Generate Report"; btn.disabled = false; }
  }

  // --- HELPERS ---
  function setDelta(id, curr, prev) {
      const el = document.getElementById(id);
      if(!prev || prev === 0) { el.innerText = "—"; el.className = "kpi-delta"; return; }
      const d = ((curr - prev) / prev) * 100;
      el.innerText = `${d > 0 ? "▲" : "▼"} ${Math.abs(d).toFixed(1)}% vs Prev`;
      el.className = `kpi-delta ${d > 0 ? "delta-up" : "delta-down"}`;
  }
  function formatMoney(amount, currency) { 
      if (!amount) amount = 0; 
      if (currency === "IQD") return amount.toLocaleString() + " د.ع"; 
      else return "$" + (amount / IQD_RATE).toLocaleString(undefined, {maximumFractionDigits: 0}); 
  }
  function toNumberSmart(v) { if (!v) return 0; let s = String(v).trim().replace(/,/g, ""); return Number(s) || 0; }
  function parseCustomDate(val, targetYear) { if (!val) return null; let text = String(val).trim(); if (/^\d{1,2}-[a-zA-Z]{3}$/.test(text)) text = `${text}-${targetYear}`; let d = new Date(text); if (isNaN(d.getTime()) || d.getFullYear() === 2001) d = new Date(`${text} ${targetYear}`); if (isNaN(d.getTime())) return null; return d; }
  function getQuarter(dateObj) { const m = dateObj.getMonth(); if (m < 3) return "q1"; if (m < 6) return "q2"; if (m < 9) return "q3"; return "q4"; }
  function showToast(msg) { const x = document.getElementById("toast"); x.innerText = msg; x.className = "show"; setTimeout(() => { x.className = ""; }, 3000); }
  function populateYearFilters() { const uniqueYears = new Set(); rawRegistration.forEach(r => { if(r._derivedYear) uniqueYears.add(r._derivedYear); }); const actSelect = document.getElementById("actChartFilter"); actSelect.innerHTML = '<option value="all">All Years</option>'; Array.from(uniqueYears).sort().forEach(y => { const opt = document.createElement("option"); opt.value = y; opt.textContent = y; actSelect.appendChild(opt); }); }
  async function fetchAllRows(table, defaultYear) { let allData = []; let page = 0; const pageSize = 5000; while (true) { try { const { data, error } = await supabaseClient.from(table).select('*').range(page * pageSize, (page + 1) * pageSize - 1); if (error) throw error; if (!data || data.length === 0) break; const tagged = data.map(row => { let y = getSmartValue(row, ["Year", "year"]); if (!y) y = defaultYear; return { ...row, _derivedYear: String(y) }; }); allData = allData.concat(tagged); if (data.length < pageSize) break; page++; } catch (err) { console.warn(`Skipping table '${table}':`, err.message); break; } } return allData; }
  function getSmartValue(row, possibleNames) { if (!row) return ""; const keys = Object.keys(row); for (let name of possibleNames) if (row[name] !== undefined) return row[name]; for (let key of keys) { const lowerKey = key.toLowerCase(); for (let name of possibleNames) if (lowerKey === name.toLowerCase()) return row[key]; } return ""; }

  // Init
  const style = document.createElement('style'); style.innerHTML = `@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }`; document.head.appendChild(style);
</script>
</body>
</html>
