<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CER Impact Dashboard | Secure</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  
  <style>
    /* --- THEME VARIABLES --- */
    :root { 
        --bg-main: #040011; 
        --bg-card: #0c071d; 
        --bg-card-soft: #120a2a;
        --accent: #d946ef; 
        --accent-hover: #c026d3;
        --text-main: #f9fafb; 
        --text-muted: #9ca3af; 
        --border: rgba(255,255,255,0.1);
        --success: #4ade80; 
        --danger: #f87171; 
        --warning: #facc15; 
    }
    
    * { box-sizing: border-box; }
    body { margin: 0; padding: 0; background: radial-gradient(circle at top left, #321b5d 0, #040011 45%, #02000a 100%); color: var(--text-main); font-family: 'Segoe UI', system-ui, sans-serif; min-height: 100vh; }
    
    /* --- LOGIN SCREEN --- */
    #authScreen { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; width: 100%; position: fixed; top: 0; left: 0; z-index: 2000; background: var(--bg-main); }
    .auth-box { background: var(--bg-card); padding: 40px; border-radius: 20px; border: 1px solid var(--border); width: 90%; max-width: 400px; text-align: center; box-shadow: 0 0 50px rgba(217,70,239,0.1); }
    .auth-logo { width: 60px; height: 60px; border-radius: 50%; background: var(--accent); margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; font-size: 32px; font-weight: bold; color: #fff; box-shadow: 0 0 20px var(--accent); }
    .auth-input { width: 100%; padding: 14px; margin-bottom: 12px; background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 8px; color: #fff; outline: none; transition: 0.3s; }
    .auth-input:focus { border-color: var(--accent); background: rgba(255,255,255,0.1); }
    .auth-btn { width: 100%; padding: 14px; background: var(--accent); color: #fff; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.2s; font-size: 16px; margin-top: 10px; }
    .auth-btn:hover { background: var(--accent-hover); transform: translateY(-2px); }
    .auth-link { margin-top: 20px; font-size: 13px; color: var(--text-muted); cursor: pointer; text-decoration: underline; }
    .auth-link:hover { color: #fff; }

    /* --- DASHBOARD LAYOUT --- */
    #mainApp { display: none; padding: 24px; max-width: 1800px; margin: 0 auto; }
    .top-nav { display: flex; align-items: center; justify-content: space-between; margin-bottom: 30px; flex-wrap: wrap; gap: 20px; }
    .nav-left { display: flex; align-items: center; gap: 12px; }
    .status-badge { padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
    .s-pending { background: rgba(250,204,21,0.15); color: var(--warning); border: 1px solid rgba(250,204,21,0.3); }
    .s-viewer { background: rgba(56,189,248,0.15); color: #38bdf8; border: 1px solid rgba(56,189,248,0.3); }
    .s-admin { background: rgba(217,70,239,0.15); color: var(--accent); border: 1px solid rgba(217,70,239,0.3); }

    .nav-right { display: flex; align-items: center; gap: 10px; }
    .btn-nav { background: rgba(255,255,255,0.05); color: var(--text-muted); border: 1px solid var(--border); padding: 8px 16px; border-radius: 8px; cursor: pointer; transition: 0.2s; font-size: 13px; font-weight: 500; display: flex; align-items: center; gap: 6px; }
    .btn-nav:hover { background: rgba(255,255,255,0.1); color: #fff; border-color: rgba(255,255,255,0.2); }
    .btn-primary { background: var(--accent); color: #fff; border: none; }
    .btn-primary:hover { background: var(--accent-hover); }

    /* --- ADMIN PANEL --- */
    #adminPanel { display: none; background: var(--bg-card); padding: 24px; border-radius: 20px; border: 1px solid var(--border); margin-bottom: 30px; box-shadow: 0 20px 40px rgba(0,0,0,0.3); }
    .admin-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); padding-bottom: 15px; margin-bottom: 20px; }
    .admin-tabs { display: flex; gap: 10px; flex-wrap: wrap; }
    .tab-btn { background: transparent; border: none; color: var(--text-muted); padding: 8px 12px; cursor: pointer; font-weight: 600; border-radius: 6px; transition: 0.2s; }
    .tab-btn.active { background: rgba(217,70,239,0.1); color: var(--accent); }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    /* Forms & Tables */
    .form-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; align-items: end; margin-bottom: 15px; }
    @media(max-width: 800px) { .form-grid { grid-template-columns: 1fr; } }
    .form-group { display: flex; flex-direction: column; gap: 5px; }
    .form-label { font-size: 11px; color: var(--text-muted); }
    .form-input { background: rgba(255,255,255,0.05); border: 1px solid var(--border); color: #fff; padding: 10px; border-radius: 6px; outline: none; }
    .data-table-wrapper { overflow-x: auto; background: rgba(0,0,0,0.2); border-radius: 12px; max-height: 500px; }
    table { width: 100%; border-collapse: collapse; font-size: 13px; text-align: left; }
    th { background: rgba(255,255,255,0.05); color: var(--text-muted); padding: 12px; position: sticky; top: 0; backdrop-filter: blur(5px); }
    td { padding: 12px; border-bottom: 1px solid var(--border); }
    
    .user-row { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(255,255,255,0.02); border-radius: 8px; margin-bottom: 8px; border: 1px solid var(--border); }
    .btn-action { padding: 4px 10px; border-radius: 6px; border: none; cursor: pointer; font-size: 11px; font-weight: 700; margin-left: 8px; }
    .btn-approve { background: var(--success); color: #052e16; }
    .btn-reject { background: var(--danger); color: #450a0a; }

    /* --- DASHBOARD CARDS & GRIDS --- */
    .grid { display: grid; gap: 20px; margin-bottom: 20px; }
    .grid-4 { grid-template-columns: repeat(4, 1fr); }
    .grid-3 { grid-template-columns: repeat(3, 1fr); }
    .grid-2 { grid-template-columns: repeat(2, 1fr); }
    @media (max-width: 1200px) { .grid-4 { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 900px) { .grid-3 { grid-template-columns: 1fr; } .grid-2 { grid-template-columns: 1fr; } }
    @media (max-width: 600px) { .grid-4 { grid-template-columns: 1fr; } }

    .card { background: linear-gradient(145deg, var(--bg-card) 0, var(--bg-card-soft) 100%); border-radius: 16px; padding: 20px; border: 1px solid var(--border); box-shadow: 0 10px 30px rgba(0,0,0,0.2); display: flex; flex-direction: column; }
    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .card-title { font-size: 11px; letter-spacing: 1px; text-transform: uppercase; color: var(--text-muted); font-weight: 600; }
    .kpi-big { font-size: 36px; font-weight: 800; color: #fff; margin-bottom: 5px; }
    .kpi-delta { font-size: 12px; font-weight: 500; }
    .delta-up { color: var(--success); }
    .delta-down { color: var(--danger); }
    .chart-box { height: 250px; position: relative; width: 100%; }

    /* Budget & SIM Specifics */
    .budget-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 10px; }
    .budget-sub-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px; }
    .budget-sub-value { font-size: 18px; font-weight: 600; color: #fff; }
    .budget-progress-bg { width: 100%; height: 6px; background: rgba(255,255,255,0.1); border-radius: 999px; margin-top: 8px; overflow: hidden; }
    .budget-progress-fill { height: 100%; background: var(--success); border-radius: 999px; width: 0%; transition: width 1s ease; }
    .donut-layout { display: flex; align-items: center; gap: 20px; height: 100%; }
    .donut-chart { flex: 1; height: 200px; position: relative; }
    .donut-legend { width: 120px; font-size: 12px; display: flex; flex-direction: column; gap: 8px; }
    
    /* --- CONTROLS --- */
    .pill-select { background: rgba(255,255,255,0.05); border: 1px solid var(--border); color: #fff; padding: 6px 12px; border-radius: 20px; outline: none; font-size: 12px; cursor: pointer; }
    .pill-select option { background: var(--bg-card); color: #fff; }

    /* --- TOAST NOTIFICATION --- */
    #toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 8px; padding: 16px; position: fixed; z-index: 9999; bottom: 30px; left: 50%; transform: translateX(-50%); border: 1px solid var(--accent); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
    #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
    @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
    @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
  </style>
</head>
<body>

  <div id="authScreen">
    <div class="auth-box">
        <div class="auth-logo">Z</div>
        <h2 id="authTitle" style="margin:0 0 10px 0;">Sign In</h2>
        <p id="authSub" style="color:var(--text-muted); margin-bottom:30px;">Corporate Entrepreneurship Responsibility</p>
        
        <input type="email" id="email" class="auth-input" placeholder="Email Address">
        <input type="password" id="password" class="auth-input" placeholder="Password">
        
        <button id="mainAuthBtn" class="auth-btn" onclick="handleLogin()">Sign In</button>
        <div id="authMsg" style="margin-top:20px; font-size:13px; min-height:20px;"></div>
        
        <div class="auth-link" onclick="toggleAuthMode()" id="toggleAuthText">No account? Request Access</div>
    </div>
  </div>

  <div id="mainApp">
    
    <div class="top-nav">
      <div class="nav-left">
        <div style="font-weight:800; font-size:20px; color:#fff;">CER <span style="font-weight:400; color:var(--text-muted);">Impact Dashboard</span></div>
        <div id="roleBadge" class="status-badge s-viewer">Viewer</div>
      </div>
      <div class="nav-right">
        <div class="pill-select-wrapper">
            Year: <select id="viewYear" class="pill-select" onchange="fetchAllData()">
                <option value="2026">2026</option>
                <option value="2025" selected>2025</option>
                <option value="2024">2024</option>
            </select>
        </div>
        <button id="btnAdminPanel" class="btn-nav btn-primary" style="display:none;" onclick="toggleAdminPanel()">
            <span class="material-icons" style="font-size:16px;">admin_panel_settings</span> Admin
        </button>
        <button class="btn-nav" onclick="handleLogout()">Sign Out</button>
      </div>
    </div>

    <div id="adminPanel">
        <div class="admin-header">
            <h3 style="margin:0;">Admin Console</h3>
            <div class="admin-tabs">
                <button class="tab-btn active" onclick="showAdminTab('data', this)">Activities Log</button>
                <button class="tab-btn" onclick="showAdminTab('metrics', this)">Yearly Metrics</button>
                <button class="tab-btn" onclick="showAdminTab('users', this)">User Approvals</button>
                <button class="tab-btn" onclick="showAdminTab('ai', this)">AI Report</button>
            </div>
        </div>

        <div id="adminTabData" class="tab-content active">
            <input type="hidden" id="editId" value="">
            <div class="form-grid">
                <div class="form-group"><label class="form-label">Activity Name</label><input type="text" id="inpName" class="form-input"></div>
                <div class="form-group"><label class="form-label">Date</label><input type="date" id="inpDate" class="form-input"></div>
                <div class="form-group"><label class="form-label">City</label><input type="text" id="inpCity" class="form-input"></div>
                <div class="form-group"><label class="form-label">Audience</label><input type="number" id="inpAudience" class="form-input"></div>
                <div class="form-group"><label class="form-label">Budget (IQD)</label><input type="number" id="inpBudget" class="form-input"></div>
                <div class="form-group"><label class="form-label">Status</label><select id="inpStatus" class="form-input"><option value="Completed">Completed</option><option value="Planned">Planned</option></select></div>
                <div class="form-group" style="padding-bottom:10px;"><label><input type="checkbox" id="inpZainImplemented"> Zain Implemented?</label></div>
                <div class="form-group"><button class="btn-nav btn-primary" onclick="saveActivity()">Save Activity</button></div>
            </div>
            <div class="data-table-wrapper">
                <table id="dataTable">
                    <thead><tr><th>Date</th><th>Name</th><th>City</th><th>Audience</th><th>Action</th></tr></thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>

        <div id="adminTabMetrics" class="tab-content">
            <div class="form-grid">
                <div class="form-group"><label class="form-label">Year</label><input type="number" id="inpMetaYear" class="form-input" placeholder="2025"></div>
                <div class="form-group"><label class="form-label">Jobs Created</label><input type="number" id="inpMetaJobs" class="form-input"></div>
                <div class="form-group"><label class="form-label">Actual Budget</label><input type="number" id="inpMetaActual" class="form-input"></div>
                <div class="form-group"><label class="form-label">Planned Budget</label><input type="number" id="inpMetaPlanned" class="form-input"></div>
                <div class="form-group"><button class="btn-nav btn-primary" onclick="saveMetricRow()">Save Metrics</button></div>
            </div>
        </div>

        <div id="adminTabUsers" class="tab-content">
            <div id="userList">Loading requests...</div>
        </div>

        <div id="adminTabAI" class="tab-content">
            <div style="background:rgba(217,70,239,0.05); padding:20px; border-radius:10px; border:1px solid rgba(217,70,239,0.2); display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <h4 style="margin:0 0 5px 0; color:var(--accent);">Generate Annual Summary</h4>
                    <p style="margin:0; font-size:12px; color:var(--text-muted);">Uses Gemini 2.0 to analyze current data and write an executive summary.</p>
                </div>
                <button id="btnGenSummary" class="btn-nav btn-primary" onclick="generateAndSaveSummary()">✨ Generate Report</button>
            </div>
        </div>
    </div>

    <div style="display:flex; justify-content:flex-end; margin-bottom:20px; gap:10px;">
        <button class="btn-nav" onclick="openReportWindow()" style="background:#fff; color:#000; font-weight:700;">
            <span class="material-icons" style="font-size:16px;">description</span> Open Full Report
        </button>
        <select id="quarterFilter" class="pill-select" onchange="applyFilters()">
            <option value="all">All Year</option>
            <option value="q1">Q1</option>
            <option value="q2">Q2</option>
            <option value="q3">Q3</option>
            <option value="q4">Q4</option>
        </select>
        <select id="currencySelectorCard" class="pill-select" onchange="applyFilters()">
            <option value="IQD">IQD (د.ع)</option>
            <option value="USD">USD ($)</option>
        </select>
    </div>

    <div class="grid grid-3">
        <div class="card">
            <div class="card-header"><div class="card-title">Total Activities</div><span class="material-icons" style="color:var(--accent); font-size:16px;">event</span></div>
            <div id="kpiActivities" class="kpi-big">...</div>
            <div id="kpiActivitiesDelta" class="kpi-delta"></div>
            <div style="font-size:11px; color:var(--accent); margin-top:6px;"><span id="kpiZainRate">0%</span> Zain Led</div>
        </div>
        <div class="card">
            <div class="card-header"><div class="card-title">Participants</div><span class="material-icons" style="color:var(--success); font-size:16px;">groups</span></div>
            <div id="kpiAudience" class="kpi-big">...</div>
            <div id="kpiAudienceDelta" class="kpi-delta"></div>
        </div>
        <div class="card">
            <div class="card-header"><div class="card-title">Cities Covered</div><span class="material-icons" style="color:#38bdf8; font-size:16px;">public</span></div>
            <div id="kpiCities" class="kpi-big">...</div>
            <div id="kpiCitiesDelta" class="kpi-delta"></div>
        </div>
    </div>

    <div class="grid grid-4">
        <div class="card" style="grid-column: span 2;">
            <div class="card-header"><div class="card-title">Budget Analysis</div><span class="material-icons" style="color:var(--warning); font-size:16px;">payments</span></div>
            <div class="budget-sub-label">Total Spent (Logistics)</div>
            <div id="kpiBudget" class="kpi-big" style="font-size:28px;">...</div>
            <div id="kpiBudgetDelta" class="kpi-delta" style="margin-bottom:15px;"></div>
            
            <div class="budget-grid">
                <div><div class="budget-sub-label">Actual Budget</div><div id="kpiBudgetActual" class="budget-sub-value">...</div></div>
                <div><div class="budget-sub-label">Planned Budget</div><div id="kpiBudgetPlanned" class="budget-sub-value">...</div></div>
            </div>
            <div class="budget-progress-bg"><div id="budgetProgressBar" class="budget-progress-fill"></div></div>
            <div style="display:flex; justify-content:space-between; margin-top:5px; font-size:10px; color:var(--text-muted);">
                <span id="budgetProgressText">0% Spent</span>
                <span id="budgetPlanComparison">...</span>
            </div>
        </div>

        <div class="card" style="grid-column: span 2;">
            <div class="card-header"><div class="card-title">Jobs Created</div><span class="material-icons" style="color:var(--success); font-size:16px;">work</span></div>
            <div id="kpiJobs" class="kpi-big">...</div>
            <div style="font-size:11px; color:var(--text-muted);">Annual estimate independent of activities.</div>
        </div>
    </div>

    <div id="rowSocial" class="grid grid-4">
        <div class="card"><div class="card-title">Social Reach</div><div id="kpiSocialReach" class="kpi-big" style="font-size:24px;">...</div></div>
        <div class="card"><div class="card-title">Engagement</div><div id="kpiSocialEngagement" class="kpi-big" style="font-size:24px;">...</div></div>
        <div class="card"><div class="card-title">Interaction</div><div id="kpiSocialInteraction" class="kpi-big" style="font-size:24px;">...</div></div>
        <div class="card"><div class="card-title">Impressions</div><div id="kpiSocialImpression" class="kpi-big" style="font-size:24px;">...</div></div>
    </div>

    <div class="grid grid-2">
        <div class="card">
            <div class="card-header">
                <div class="card-title">Activities Timeline</div>
                <select id="actChartFilter" class="pill-select" onchange="updateActivitiesChart()"></select>
            </div>
            <div class="chart-box"><canvas id="activitiesChart"></canvas></div>
        </div>
        <div class="card">
            <div class="card-header">
                <div class="card-title">SIM Distribution</div>
                <select id="simYearFilter" class="pill-select" onchange="updateSimChart()"><option value="all">All Years</option></select>
            </div>
            <div class="donut-layout">
                <div class="donut-chart"><canvas id="simChart"></canvas></div>
                <div id="simLegend" class="donut-legend"></div>
            </div>
        </div>
    </div>

    <div class="grid">
        <div class="card">
            <div class="card-header">
                <div class="card-title">Gender Distribution</div>
                <select id="genderYearFilter" class="pill-select" onchange="updateGenderChart()"><option value="all">All Years</option></select>
            </div>
            <div class="donut-layout" style="justify-content: center;">
                <div class="donut-chart" style="max-width: 300px;"><canvas id="genderChart"></canvas></div>
                <div id="genderLegend" class="donut-legend"></div>
            </div>
        </div>
    </div>

    <div id="trendChartsRow" class="grid grid-2">
        <div class="card">
            <div class="card-header"><div class="card-title">Female Participation Trend</div></div>
            <div class="chart-box"><canvas id="genderLineChart"></canvas></div>
        </div>
        <div class="card">
            <div class="card-header"><div class="card-title">Activity Growth Trend</div></div>
            <div class="chart-box"><canvas id="activitiesTrendChart"></canvas></div>
        </div>
    </div>

    <div style="display:none;" id="aiSummaryText"></div>

  </div> <div id="toast">Notification</div>

<script>
  // ⚠️ 1. CONFIGURATION: PASTE KEYS HERE
  const supabaseUrl = 'https://xeohzbdgjgusavfonfkf.supabase.co'; 
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhlb2h6YmRnamd1c2F2Zm9uZmtmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5NjU5NzAsImV4cCI6MjA4MTU0MTk3MH0.5gO_0YgVdk9OFfrJuUrewhierc2wE7lVUst9vYd_DH4';
  const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

  // Constants
  const COLS_LOGISTICS = { name: "Activity Name", start_date: "Start Date", city: "City", audience: "Total Audience", budget: "Total Budget", status: "Status", year: "Year", is_zain: "is_zain_implemented" };
  const COLS_SOCIAL = { year: "Year", reach: "Reach", engagement: "Engagement", interaction: "Interaction", impression: "Impression" };
  const IQD_RATE = 1320;

  // State
  let isSignUp = false;
  let userRole = 'pending';
  let allLogistics = [], currentLogistics = [], comparisonLogistics = [], yearlyMetricsArray = [], rawSocial = [], rawRegistration = [];
  let simChartInstance = null, activitiesChartInstance = null, genderChartInstance = null, genderLineChartInstance = null, activitiesTrendChartInstance = null;

  // --- AUTH SYSTEM ---
  function toggleAuthMode() {
      isSignUp = !isSignUp;
      document.getElementById('authTitle').innerText = isSignUp ? "Request Access" : "Sign In";
      document.getElementById('mainAuthBtn').innerText = isSignUp ? "Submit Request" : "Sign In";
      document.getElementById('toggleAuthText').innerText = isSignUp ? "Already have an account? Sign In" : "No account? Request Access";
      document.getElementById('authMsg').innerText = "";
  }

  async function handleLogin() {
      const email = document.getElementById('email').value;
      const pass = document.getElementById('password').value;
      const msg = document.getElementById('authMsg');
      
      msg.style.color = "#fff"; msg.innerText = "Verifying...";

      if(isSignUp) {
          const { data, error } = await supabaseClient.auth.signUp({ email, password: pass });
          if(error) { msg.style.color = "var(--danger)"; msg.innerText = error.message; }
          else { msg.style.color = "var(--success)"; msg.innerText = "Account created. Please wait for Admin approval."; }
      } else {
          const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password: pass });
          if(error) { msg.style.color = "var(--danger)"; msg.innerText = "Invalid credentials."; }
          else { checkUserRole(data.user.id); }
      }
  }

  async function checkUserRole(uid) {
      const { data, error } = await supabaseClient.from('profiles').select('role').eq('id', uid).single();
      if(error || !data) { document.getElementById('authMsg').innerText = "Profile not found. Contact Admin."; return; }

      if(data.role === 'pending') {
          document.getElementById('authMsg').style.color = "var(--warning)";
          document.getElementById('authMsg').innerText = "Your account is pending Admin approval.";
          await supabaseClient.auth.signOut();
      } else {
          userRole = data.role;
          document.getElementById('authScreen').style.display = 'none';
          document.getElementById('mainApp').style.display = 'block';
          document.getElementById('roleBadge').innerText = userRole.toUpperCase();
          document.getElementById('roleBadge').className = `status-badge s-${userRole}`;
          
          if(userRole === 'admin') {
              document.getElementById('btnAdminPanel').style.display = 'flex';
              fetchUsersList();
          }
          fetchAllData();
      }
  }

  async function handleLogout() { await supabaseClient.auth.signOut(); location.reload(); }

  // --- ADMIN SYSTEM ---
  function toggleAdminPanel() {
      const p = document.getElementById('adminPanel');
      p.style.display = p.style.display === 'none' ? 'block' : 'none';
  }
  function showAdminTab(tab, btn) {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      btn.classList.add('active');
      if(tab === 'data') document.getElementById('adminTabData').classList.add('active');
      if(tab === 'metrics') document.getElementById('adminTabMetrics').classList.add('active');
      if(tab === 'users') document.getElementById('adminTabUsers').classList.add('active');
      if(tab === 'ai') document.getElementById('adminTabAI').classList.add('active');
  }

  async function fetchUsersList() {
      const { data, error } = await supabaseClient.from('profiles').select('*').order('created_at', {ascending: false});
      if(data) {
          let html = '';
          data.forEach(user => {
              if(user.role === 'admin') return; 
              html += `<div class="user-row"><div><div style="font-size:13px; font-weight:600; color:#fff;">${user.email}</div><div class="status-badge s-${user.role}" style="display:inline-block; margin-top:4px;">${user.role}</div></div><div>${user.role === 'pending' ? `<button class="btn-action btn-approve" onclick="updateUserRole('${user.id}','viewer')">Approve</button>` : ''}${user.role === 'viewer' ? `<button class="btn-action btn-reject" onclick="updateUserRole('${user.id}','pending')">Revoke</button>` : ''}</div></div>`;
          });
          document.getElementById('userList').innerHTML = html || '<div style="color:#666; font-size:12px;">No pending requests.</div>';
      }
  }
  async function updateUserRole(uid, newRole) { const { error } = await supabaseClient.from('profiles').update({ role: newRole }).eq('id', uid); if(!error) { showToast("User Updated"); fetchUsersList(); } }

  // Admin Data Entry
  async function saveActivity() {
      const name = document.getElementById("inpName").value; const date = document.getElementById("inpDate").value;
      if (!name || !date) return alert("Name and Date required");
      const row = { [COLS_LOGISTICS.name]: name, [COLS_LOGISTICS.start_date]: date, [COLS_LOGISTICS.city]: document.getElementById("inpCity").value, [COLS_LOGISTICS.audience]: document.getElementById("inpAudience").value, [COLS_LOGISTICS.budget]: document.getElementById("inpBudget").value, [COLS_LOGISTICS.status]: document.getElementById("inpStatus").value, [COLS_LOGISTICS.is_zain]: document.getElementById("inpZainImplemented").checked, "Year": new Date(date).getFullYear() };
      const { error } = await supabaseClient.from('logistics_all').insert([row]);
      if(error) alert(error.message); else { showToast("Saved!"); fetchAllData(); }
  }
  async function saveMetricRow() {
      const y = document.getElementById("inpMetaYear").value; const j = document.getElementById("inpMetaJobs").value; const a = document.getElementById("inpMetaActual").value; const p = document.getElementById("inpMetaPlanned").value;
      const { error } = await supabaseClient.from('yearly_metrics').upsert({ year: y, jobs_created: j, actual_budget: a, planned_budget: p });
      if(error) alert(error.message); else { showToast("Metrics Saved!"); fetchAllData(); }
  }

  // --- DATA LOADING ---
  async function fetchAllData() {
      try {
          const selectedYear = parseInt(document.getElementById("viewYear").value) || 2025;
          const prevYear = selectedYear - 1;

          const { data: allLogs } = await supabaseClient.from('logistics_all').select('*');
          allLogistics = allLogs || [];
          currentLogistics = allLogistics.filter(row => row.Year == selectedYear);
          comparisonLogistics = allLogistics.filter(row => row.Year == prevYear);

          const { data: metrics } = await supabaseClient.from('yearly_metrics').select('*');
          yearlyMetricsArray = metrics || [];

          if(rawSocial.length === 0) {
              const { data: soc } = await supabaseClient.from('social_media').select('*').range(0,5000);
              rawSocial = soc || [];
              const d1 = await fetchAllRows('registration', '2025');
              const d2 = await fetchAllRows('the_station_database', '2023');
              const d3 = await fetchAllRows('makers_of_baghdad_database', '2025');
              rawRegistration = [...d1, ...d2, ...d3];
              populateYearFilters();
          }

          // Populate Activity Table in Admin
          const tbody = document.getElementById("tableBody"); tbody.innerHTML = "";
          currentLogistics.forEach(r => { tbody.innerHTML += `<tr><td>${r[COLS_LOGISTICS.start_date]}</td><td>${r[COLS_LOGISTICS.name]}</td><td>${r[COLS_LOGISTICS.city]}</td><td>${r[COLS_LOGISTICS.audience]}</td><td><button onclick="deleteRow(${r.id})">Del</button></td></tr>`; });

          applyFilters();
          updateActivitiesChart();
          updateSimChart();
          updateGenderChart();
          renderGenderLineChart();
          renderActivitiesTrendChart();

          // Load Summary Text
          const mRow = yearlyMetricsArray.find(r => r.year == selectedYear);
          document.getElementById("aiSummaryText").textContent = mRow?.executive_summary || "";

      } catch (err) { console.error("Data Error:", err); }
  }

  // --- DASHBOARD LOGIC ---
  function applyFilters() {
    const qFilter = document.getElementById("quarterFilter").value;
    const isAll = (qFilter === "all");
    
    document.getElementById("trendChartsRow").style.display = isAll ? "grid" : "none";
    document.getElementById("rowSocial").style.display = isAll ? "grid" : "none";

    const mCurr = computeMetrics(currentLogistics, qFilter);
    const mPrev = (comparisonLogistics.length > 0) ? computeMetrics(comparisonLogistics, qFilter) : { activities:0, audience:0, budget:0, cities:0 };
    
    document.getElementById("kpiActivities").textContent = mCurr.activities.toLocaleString();
    document.getElementById("kpiAudience").textContent = mCurr.audience.toLocaleString();
    document.getElementById("kpiCities").textContent = mCurr.cities.toLocaleString();
    document.getElementById("kpiZainRate").textContent = (mCurr.activities > 0 ? ((mCurr.zainLed / mCurr.activities) * 100).toFixed(1) : 0) + "%";

    const currency = document.getElementById("currencySelectorCard").value;
    document.getElementById("kpiBudget").textContent = formatMoney(mCurr.budget, currency);

    // Budget & Jobs
    const selectedYear = parseInt(document.getElementById("viewYear").value) || 2025;
    const mRow = yearlyMetricsArray.find(r => r.year == selectedYear) || { jobs_created:0, actual_budget:0, planned_budget:0 };
    document.getElementById("kpiJobs").textContent = parseInt(mRow.jobs_created).toLocaleString();
    
    const actual = parseInt(mRow.actual_budget) || 0;
    const planned = parseInt(mRow.planned_budget) || 0;
    document.getElementById("kpiBudgetActual").textContent = formatMoney(actual, currency);
    document.getElementById("kpiBudgetPlanned").textContent = formatMoney(planned, currency);
    
    let pct = actual > 0 ? Math.min((mCurr.budget / actual) * 100, 100) : 0;
    document.getElementById("budgetProgressBar").style.width = pct + "%";
    document.getElementById("budgetProgressText").textContent = pct.toFixed(1) + "% of Actual";

    // Deltas
    setDelta("kpiActivitiesDelta", mCurr.activities, mPrev.activities);
    setDelta("kpiAudienceDelta", mCurr.audience, mPrev.audience);
    setDelta("kpiBudgetDelta", mCurr.budget, mPrev.budget);
    setDelta("kpiCitiesDelta", mCurr.cities, mPrev.cities);

    updateSocialKPIs(selectedYear);
  }

  function computeMetrics(data, q) {
    let act=0, aud=0, bud=0, zain=0; const cities=new Set(); const y=parseInt(document.getElementById("viewYear").value);
    data.forEach(r => {
      if(q!=="all" && getQuarter(parseCustomDate(r[COLS_LOGISTICS.start_date], y))!==q) return;
      act++; aud+=toNumberSmart(r[COLS_LOGISTICS.audience]); bud+=toNumberSmart(r[COLS_LOGISTICS.budget]);
      if(r[COLS_LOGISTICS.is_zain]) zain++; cities.add(r[COLS_LOGISTICS.city]);
    });
    return { activities:act, audience:aud, budget:bud, cities:cities.size, zainLed:zain };
  }

  function updateSocialKPIs(y) {
      let r=0, e=0, i=0, imp=0;
      rawSocial.forEach(row => { if(String(row[COLS_SOCIAL.year]) == y) { r+=toNumberSmart(row[COLS_SOCIAL.reach]); e+=toNumberSmart(row[COLS_SOCIAL.engagement]); i+=toNumberSmart(row[COLS_SOCIAL.interaction]); imp+=toNumberSmart(row[COLS_SOCIAL.impression]); } });
      document.getElementById("kpiSocialReach").textContent = r.toLocaleString(); document.getElementById("kpiSocialEngagement").textContent = e.toLocaleString(); document.getElementById("kpiSocialInteraction").textContent = i.toLocaleString(); document.getElementById("kpiSocialImpression").textContent = imp.toLocaleString();
  }

  // --- CHARTS ---
  function updateActivitiesChart() {
      const filter = document.getElementById("actChartFilter").value; const m = Array(12).fill(0);
      (filter==="all" ? allLogistics : allLogistics.filter(r=>r.Year==filter)).forEach(r => { const d=parseCustomDate(r[COLS_LOGISTICS.start_date], r.Year); if(d) m[d.getMonth()]++; });
      if(activitiesChartInstance) activitiesChartInstance.destroy();
      activitiesChartInstance = new Chart(document.getElementById("activitiesChart"), { type: "bar", data: { labels: ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"], datasets:[{ label: filter, data: m, backgroundColor:"#d946ef", borderRadius:4 }] }, options: { maintainAspectRatio: false, plugins:{legend:{display:false}}, scales:{y:{grid:{color:'#333'}},x:{grid:{display:false}}} } });
  }
  function updateSimChart() {
      const y = document.getElementById("simYearFilter").value; let z=0, a=0, k=0;
      rawRegistration.forEach(r => { if(y!=="all" && r._derivedYear!=y) return; const p=String(getSmartValue(r, ["Phone","Mobile"])).replace(/\D/g,"").slice(-10); if(p.startsWith("78")||p.startsWith("79")) z++; else if(p.startsWith("77")) a++; else if(p.startsWith("75")) k++; });
      const t=z+a+k; document.getElementById("simLegend").innerHTML = `<div style="color:#d946ef">Zain: ${((z/t)*100).toFixed(1)}%</div><div style="color:#ef4444">Asia: ${((a/t)*100).toFixed(1)}%</div><div style="color:#3b82f6">Korek: ${((k/t)*100).toFixed(1)}%</div>`;
      if(simChartInstance) simChartInstance.destroy();
      simChartInstance = new Chart(document.getElementById("simChart"), { type: "doughnut", data: { labels: ["Zain","Asiacell","Korek"], datasets:[{ data:[z,a,k], backgroundColor:["#d946ef","#ef4444","#3b82f6"], borderWidth:0, cutout:'70%' }] }, options: { maintainAspectRatio: false, plugins:{legend:{display:false}} } });
  }
  function updateGenderChart() {
      const y = document.getElementById("genderYearFilter").value; let m=0, f=0;
      rawRegistration.forEach(r => { if(y!=="all" && r._derivedYear!=y) return; const g=String(getSmartValue(r, ["Gender","Sex"])).toLowerCase(); if(g.includes("f")||g.includes("female")) f++; else m++; });
      const t=m+f; document.getElementById("genderLegend").innerHTML = `<div style="color:#f472b6">Fem: ${((f/t)*100).toFixed(1)}%</div><div style="color:#38bdf8">Male: ${((m/t)*100).toFixed(1)}%</div>`;
      if(genderChartInstance) genderChartInstance.destroy();
      genderChartInstance = new Chart(document.getElementById("genderChart"), { type: "doughnut", data: { labels: ["Male","Female"], datasets:[{ data:[m,f], backgroundColor:["#38bdf8","#f472b6"], borderWidth:0, cutout:'70%' }] }, options: { maintainAspectRatio: false, plugins:{legend:{display:false}} } });
  }
  function renderGenderLineChart() {
      const s={}; rawRegistration.forEach(r=>{ const y=r._derivedYear; if(!s[y])s[y]={m:0,f:0}; const g=String(getSmartValue(r,["Gender","Sex"])).toLowerCase(); if(g.includes("f"))s[y].f++; else s[y].m++; });
      const yrs=Object.keys(s).sort(); const d=yrs.map(y=>(s[y].f/(s[y].f+s[y].m))*100);
      if(genderLineChartInstance) genderLineChartInstance.destroy();
      genderLineChartInstance = new Chart(document.getElementById("genderLineChart"), { type: 'line', data: { labels: yrs, datasets: [{ label: 'Female %', data: d, borderColor: '#f472b6', backgroundColor: 'rgba(244,114,182,0.2)', fill:true }] }, options: { maintainAspectRatio: false, plugins:{legend:{display:false}}, scales:{y:{grid:{color:'#333'}},x:{grid:{display:false}}} } });
  }
  function renderActivitiesTrendChart() {
      const s={}; allLogistics.forEach(r=>{ const y=r.Year; if(y) s[y]=(s[y]||0)+1; }); const yrs=Object.keys(s).sort(); const d=yrs.map(y=>s[y]);
      if(activitiesTrendChartInstance) activitiesTrendChartInstance.destroy();
      activitiesTrendChartInstance = new Chart(document.getElementById("activitiesTrendChart"), { type: 'line', data: { labels: yrs, datasets: [{ label: 'Activities', data: d, borderColor: '#d946ef', backgroundColor: 'rgba(217,70,239,0.1)', fill:true }] }, options: { maintainAspectRatio: false, plugins:{legend:{display:false}}, scales:{y:{grid:{color:'#333'}},x:{grid:{display:false}}} } });
  }

  // --- AI & UTILS ---
  async function generateAndSaveSummary() {
    const year = document.getElementById("viewYear").value; const btn = document.getElementById("btnGenSummary");
    let apiKey = localStorage.getItem("gemini_api_key"); if (!apiKey) { apiKey = prompt("API Key:"); if(!apiKey)return; localStorage.setItem("gemini_api_key", apiKey); }
    btn.innerText = "Generating..."; btn.disabled = true;
    try {
        const act=currentLogistics.length; const aud=currentLogistics.reduce((a,r)=>a+toNumberSmart(r[COLS_LOGISTICS.audience]),0);
        const prompt = `Act as Head of Innovation at Zain Iraq. Write summary for ${year} CER (Corporate Entrepreneurship). Data: ${act} activities, ${aud} people. Focus on ROI.`;
        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
        const data = await res.json(); const txt = data.candidates[0].content.parts[0].text;
        await supabaseClient.from('yearly_metrics').update({ executive_summary: txt }).eq('year', year);
        showToast("Done!"); fetchAllData();
    } catch(e) { alert(e); } finally { btn.innerText = "✨ Generate Report"; btn.disabled = false; }
  }
  function openReportWindow() { const t=document.getElementById("aiSummaryText").textContent; const w=window.open("","_blank"); w.document.write(`<html><body style="font-family:sans-serif;padding:40px;"><h1>CER Report</h1><p>${t}</p><button onclick="window.print()">Print</button></body></html>`); }
  function setDelta(id,c,p) { const el=document.getElementById(id); if(!p){el.innerText="-";return;} const d=((c-p)/p)*100; el.innerText=`${d>0?"▲":"▼"} ${Math.abs(d).toFixed(1)}%`; el.className=`kpi-delta ${d>0?"delta-up":"delta-down"}`; }
  function formatMoney(v,c) { return c==="IQD" ? v.toLocaleString()+" د.ع" : "$"+(v/IQD_RATE).toLocaleString(undefined,{maximumFractionDigits:0}); }
  function toNumberSmart(v) { return Number(String(v).replace(/,/g,""))||0; }
  function parseCustomDate(v,y) { const d=new Date(v); return isNaN(d)?new Date(`${v} ${y}`):d; }
  function getQuarter(d) { const m=d.getMonth(); return m<3?"q1":m<6?"q2":m<9?"q3":"q4"; }
  function showToast(m) { const t=document.getElementById("toast"); t.innerText=m; t.className="show"; setTimeout(()=>t.className="",3000); }
  function populateYearFilters() { const s=document.getElementById("simYearFilter"), g=document.getElementById("genderYearFilter"), a=document.getElementById("actChartFilter"); const yrs=new Set(rawRegistration.map(r=>r._derivedYear)); yrs.forEach(y=>{ s.add(new Option(y,y)); g.add(new Option(y,y)); }); const ay=new Set(allLogistics.map(r=>r.Year)); ay.forEach(y=>a.add(new Option(y,y))); }
  async function fetchAllRows(t,dy) { let all=[], p=0; while(true){ const {data}=await supabaseClient.from(t).select('*').range(p*5000,(p+1)*5000-1); if(!data?.length)break; all=all.concat(data.map(r=>({...r, _derivedYear:String(getSmartValue(r,["Year"])||dy)}))); p++; } return all; }
  function getSmartValue(r,k) { for(let n of k) if(r[n]) return r[n]; return ""; }

  const style = document.createElement('style'); style.innerHTML = `@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }`; document.head.appendChild(style);
</script>
</body>
</html>
