<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CER Impact Dashboard | Secure</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  
  <style>
    /* --- THEME VARIABLES --- */
    :root { --bg-main: #040011; --bg-card: #0c071d; --bg-card-soft: #120a2a; --border-subtle: #231a3c; --accent: #d946ef; --accent-soft: #9333ea; --text-main: #f9fafb; --text-muted: #9ca3af; --text-soft: #6b7280; --success: #4ade80; --warning: #facc15; --danger: #f97373; --chip-bg: rgba(255,255,255,0.06); }
    * { box-sizing: border-box; }
    body { margin: 0; padding: 0; background: radial-gradient(circle at top left, #321b5d 0, #040011 45%, #02000a 100%); color: var(--text-main); font-family: system-ui, -apple-system, BlinkMacSystemFont, "Inter", Arial, sans-serif; min-height: 100vh; overflow-x: hidden; }
    .page { width: 95%; max-width: 1800px; margin: 0 auto; padding: 24px 16px 40px; }

    /* --- LOGIN SCREEN (New) --- */
    #authScreen { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; width: 100%; position: fixed; top: 0; left: 0; z-index: 2000; background: var(--bg-main); }
    .auth-box { background: var(--bg-card); padding: 40px; border-radius: 20px; border: 1px solid var(--border-subtle); width: 90%; max-width: 400px; text-align: center; box-shadow: 0 0 50px rgba(217,70,239,0.1); }
    .auth-logo { width: 60px; height: 60px; border-radius: 50%; background: var(--accent); margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; font-size: 32px; font-weight: bold; color: #fff; box-shadow: 0 0 20px var(--accent); }
    .auth-input { width: 100%; padding: 14px; margin-bottom: 12px; background: rgba(255,255,255,0.05); border: 1px solid var(--border-subtle); border-radius: 8px; color: #fff; outline: none; transition: 0.3s; }
    .auth-input:focus { border-color: var(--accent); background: rgba(255,255,255,0.1); }
    .auth-btn { width: 100%; padding: 14px; background: var(--accent); color: #fff; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.2s; font-size: 16px; margin-top: 10px; }
    .auth-btn:hover { background: var(--accent-soft); transform: translateY(-2px); }
    .auth-link { margin-top: 20px; font-size: 13px; color: var(--text-muted); cursor: pointer; text-decoration: underline; }
    
    /* --- DASHBOARD LAYOUT (Hidden by default) --- */
    #mainApp { display: none; }

    /* NAV & CONTROLS */
    .top-nav { display: flex; align-items: center; justify-content: space-between; gap: 12px; margin-bottom: 18px; flex-wrap: wrap; }
    .brand-area { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
    .brand-chip { display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; border-radius: 999px; background: var(--chip-bg); border: 1px solid rgba(255,255,255,0.08); font-size: 11px; letter-spacing: 0.04em; text-transform: uppercase; color: var(--text-soft); }
    .brand-dot { width: 7px; height: 7px; border-radius: 999px; background: var(--accent); box-shadow: 0 0 0 3px rgba(217,70,239,0.4); }
    .pill { padding: 6px 12px; border-radius: 999px; border: 1px solid rgba(148,163,184,0.4); font-size: 12px; color: #e5e7eb; display: inline-flex; align-items: center; gap: 6px; background: rgba(15,23,42,0.8); }
    select { background-color: transparent; border: none; color: #f9fafb; font-size: 12px; outline: none; padding: 2px 4px; cursor: pointer; font-weight: 500; }
    select option { background-color: #0c071d; color: #fff; padding: 10px; }
    
    .btn-admin { background: var(--accent); color: white; border: none; padding: 6px 16px; border-radius: 999px; font-size: 12px; cursor: pointer; font-weight: 600; transition: 0.2s; display: flex; align-items: center; gap: 6px; }
    .btn-admin:hover { background: var(--accent-soft); }
    .btn-admin.active { background: #fff; color: #000; }
    
    .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; }
    .s-pending { background: rgba(250,204,21,0.1); color: #facc15; }
    .s-viewer { background: rgba(56,189,248,0.1); color: #38bdf8; }
    .s-admin { background: rgba(217,70,239,0.1); color: var(--accent); }

    h1 { font-size: 26px; margin: 0 0 4px; }
    .subtitle { font-size: 13px; color: var(--text-muted); margin-bottom: 20px; }

    /* LAYOUT GRIDS */
    .grid { display: grid; gap: 16px; }
    .grid-4 { grid-template-columns: repeat(4, minmax(0, 1fr)); }
    .grid-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); } 
    .grid-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    @media (max-width: 1100px) { .grid-4, .grid-3 { grid-template-columns: repeat(2, minmax(0, 1fr)); } }
    @media (max-width: 700px) { .grid-4, .grid-3, .grid-2 { grid-template-columns: minmax(0, 1fr); } }

    /* CARD COMPONENTS */
    .card { background: linear-gradient(145deg, var(--bg-card) 0, var(--bg-card-soft) 100%); border-radius: 20px; padding: 16px 18px; border: 1px solid var(--border-subtle); box-shadow: 0 18px 40px rgba(0,0,0,0.45); transition: 0.3s; display: flex; flex-direction: column; }
    .card-header-row { display: flex; align-items: center; justify-content: space-between; gap: 8px; margin-bottom: 10px; width: 100%; }
    .card-label { font-size: 11px; letter-spacing: 0.16em; text-transform: uppercase; color: var(--text-soft); font-weight: 500; }
    .badge-soft { display: inline-flex; align-items: center; gap: 6px; padding: 3px 8px; border-radius: 999px; background: rgba(14,148,136,0.1); color: #6ee7b7; font-size: 10px; border: 1px solid rgba(16,185,129,0.4); white-space: nowrap; }
    .badge-soft-dot { width: 6px; height: 6px; border-radius: 999px; background: #22c55e; }
    .kpi-value { font-size: 32px; font-weight: 700; margin-bottom: 4px; }
    .kpi-delta { font-size: 11px; margin-bottom: 6px; }
    .delta-up { color: var(--success); }
    .delta-down { color: var(--danger); }
    .delta-neutral { color: var(--text-muted); }
    .kpi-note { font-size: 11px; color: var(--text-soft); line-height: 1.4; }
    
    .chart-wrapper { position: relative; width: 100%; height: 270px; }
    .chart-header { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 10px; gap: 8px; }
    .chart-title { font-size: 13px; font-weight: 500; }
    .card-filter { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; padding: 2px 8px; font-size: 11px; color: var(--text-muted); }

    /* DONUT & BUDGET CARDS */
    .donut-card-body { display: flex; align-items: center; justify-content: space-between; gap: 16px; height: 270px; overflow: hidden; }
    .donut-kpi-section { flex: 0 0 auto; text-align: center; min-width: 80px; display: flex; flex-direction: column; gap: 20px; justify-content: center; }
    .donut-big-number { font-size: 40px; font-weight: 800; color: var(--accent); line-height: 1; }
    .donut-label { font-size: 12px; color: var(--text-muted); margin-top: 4px; text-transform: uppercase; letter-spacing: 1px; }
    .donut-chart-container { flex: 1; height: 100%; position: relative; min-width: 0; }
    .donut-legend { flex: 0 0 160px; display: flex; flex-direction: column; justify-content: center; gap: 12px; }
    .legend-item { display: flex; align-items: center; justify-content: space-between; font-size: 12px; gap: 10px; }
    .legend-left { display: flex; align-items: center; gap: 8px; color: var(--text-main); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .legend-dot { width: 10px; height: 10px; border-radius: 3px; flex-shrink: 0; }
    .legend-right { text-align: right; min-width: 60px; }
    .legend-pct { display: block; font-weight: 700; color: #fff; }

    .budget-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 10px; }
    .budget-sub-label { font-size: 11px; color: var(--text-soft); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
    .budget-sub-value { font-size: 20px; font-weight: 600; color: #fff; }
    .budget-progress-bg { width: 100%; height: 6px; background: rgba(255,255,255,0.1); border-radius: 999px; margin-top: 8px; position: relative; overflow: hidden; }
    .budget-progress-fill { height: 100%; background: var(--success); border-radius: 999px; width: 0%; transition: width 1s ease; }
    .budget-progress-text { font-size: 10px; color: var(--text-soft); margin-top: 4px; display: flex; justify-content: space-between; }

    /* ADMIN PANEL */
    #adminPanel { display: none; background: var(--bg-card); padding: 24px; border-radius: 20px; border: 1px solid var(--border-subtle); margin-bottom: 30px; }
    .admin-tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid var(--border-subtle); padding-bottom: 10px; }
    .tab-btn { background: transparent; border: none; color: var(--text-soft); padding: 8px 16px; font-size: 13px; font-weight: 600; cursor: pointer; border-radius: 6px; transition: 0.2s; }
    .tab-btn.active { background: rgba(217, 70, 239, 0.1); color: var(--accent); }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    .form-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; align-items: start; }
    .full-width { grid-column: span 4; }
    @media (max-width: 800px) { .form-grid { grid-template-columns: 1fr; } .full-width { grid-column: auto; } }
    .form-group { width: 100%; }
    .form-label { font-size: 11px; color: var(--text-soft); margin-bottom: 4px; display: block; }
    .form-input { width: 100%; background: rgba(255,255,255,0.05); border: 1px solid var(--border-subtle); color: white; padding: 8px 12px; border-radius: 6px; outline: none; }
    .btn-save { background: var(--success); color: #000; border: none; padding: 10px 20px; border-radius: 6px; font-weight: 600; cursor: pointer; width: 100%; margin-top: 10px; }
    .btn-update { background: var(--warning); color: #000; } 
    .btn-cancel-edit { background: transparent; color: var(--text-muted); border: 1px solid var(--border-subtle); width: 100%; padding: 10px; border-radius: 6px; margin-top: 6px; cursor: pointer; display: none; }
    
    .data-table-wrapper { overflow-x: auto; background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border-subtle); max-height: 600px; overflow-y: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 13px; text-align: left; }
    th { background: rgba(255,255,255,0.03); color: var(--text-muted); padding: 12px 16px; border-bottom: 1px solid var(--border-subtle); font-weight: 500; white-space: nowrap; position: sticky; top: 0; backdrop-filter: blur(10px); z-index: 10; }
    td { padding: 12px 16px; border-bottom: 1px solid rgba(255,255,255,0.04); color: var(--text-main); white-space: nowrap; vertical-align: top; }
    
    .user-row { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(255,255,255,0.02); border-radius: 8px; margin-bottom: 8px; border: 1px solid var(--border-subtle); }
    .btn-action { padding: 4px 10px; border-radius: 6px; border: none; cursor: pointer; font-size: 11px; font-weight: 700; margin-left: 8px; }
    .btn-approve { background: var(--success); color: #052e16; }
    .btn-reject { background: var(--danger); color: #450a0a; }

    /* TOAST */
    #toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 8px; padding: 16px; position: fixed; z-index: 9999; left: 50%; bottom: 30px; transform: translateX(-50%); font-size: 14px; box-shadow: 0 4px 12px rgba(0,0,0,0.5); border: 1px solid var(--success); }
    #toast.show { visibility: visible; -webkit-animation: fadein 0.5s, fadeout 0.5s 2.5s; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
    @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} } @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
  </style>
</head>
<body>

  <div id="authScreen">
    <div class="auth-box">
        <div class="auth-logo">Z</div>
        <h2 id="authTitle" style="margin:0 0 10px 0;">Sign In</h2>
        <p id="authSub" style="color:var(--text-muted); margin-bottom:30px;">Corporate Entrepreneurship Responsibility</p>
        
        <input type="email" id="email" class="auth-input" placeholder="Email Address">
        <input type="password" id="password" class="auth-input" placeholder="Password">
        
        <button id="mainAuthBtn" class="auth-btn" onclick="handleLogin()">Sign In</button>
        <div id="authMsg" style="margin-top:20px; font-size:13px; min-height:20px;"></div>
        
        <div class="auth-link" onclick="toggleAuthMode()" id="toggleAuthText">No account? Request Access</div>
    </div>
  </div>

  <div id="mainApp" class="page">
    <div class="top-nav">
      <div class="brand-area">
        <div class="brand-chip"><span class="brand-dot"></span><span>CER · Zain Iraq</span></div>
        <div id="roleBadge" class="status-badge s-viewer">Viewer</div>
        
        <button id="btnToggle" class="btn-admin" onclick="toggleAdminMode()" style="display:none;">
          <span class="material-icons">settings</span> Manage Data
        </button>
      </div>
      <div class="top-controls">
        <button class="btn-admin" onclick="handleLogout()" style="background:rgba(255,255,255,0.1);">Sign Out</button>
        <div class="pill">
          Logistics Year:
          <select id="viewYear" onchange="handleYearChange()">
            <option value="2026">2026</option>
            <option value="2025" selected>2025</option>
            <option value="2024">2024</option>
            <option value="2023">2023</option>
            <option value="2022">2022</option>
            <option value="2021">2021</option>
          </select>
        </div>
      </div>
    </div>

    <h1>CER Impact Dashboard</h1>
    <div class="subtitle">Live view of <span id="titleYear">2025</span> activities.</div>
    <div id="globalError" class="error-text"></div>

    <div id="adminPanel">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <h3 style="margin:0; color:#fff;">Admin Panel</h3>
        <span style="font-size:11px; color:var(--text-soft);">Authorized Access</span>
      </div>

      <div class="admin-tabs">
        <button class="tab-btn active" onclick="switchTab('activities')">Activities Log</button>
        <button class="tab-btn" onclick="switchTab('metrics')">Yearly Metrics</button>
        <button class="tab-btn" onclick="switchTab('users')">User Approvals</button>
        <button class="tab-btn" onclick="switchTab('ai')">AI Report</button>
      </div>

      <div id="tabActivities" class="tab-content active">
        <div class="admin-controls" id="entryForm">
            <input type="hidden" id="editId" value="">
            <div class="form-grid">
                <div class="form-group"><label class="form-label">Activity Name</label><input type="text" id="inpName" class="form-input" placeholder="Name"></div>
                <div class="form-group"><label class="form-label">Date</label><input type="date" id="inpDate" class="form-input"></div>
                <div class="form-group"><label class="form-label">City</label><input type="text" id="inpCity" class="form-input" placeholder="City"></div>
                <div class="form-group"><label class="form-label">Status</label><select id="inpStatus" class="form-input"><option value="Completed">Completed</option><option value="Planned">Planned</option></select></div>
                <div class="form-group"><label class="form-label">Audience</label><input type="number" id="inpAudience" class="form-input" placeholder="0"></div>
                <div class="form-group"><label class="form-label">Budget Spent (IQD)</label><input type="number" id="inpBudget" class="form-input" placeholder="0"></div>
                <div class="form-group"><label style="margin-top:10px; display:block;"><input type="checkbox" id="inpZainImplemented"> Zain Implemented?</label></div>

                <div class="form-group full-width">
                  <button class="btn-ai" onclick="autoGenerateDesc()" style="float:right;">✨ Auto-Generate</button>
                  <label class="form-label">Description</label>
                  <textarea id="inpDesc" class="form-input" placeholder="Enter brief details..."></textarea>
                  <button id="btnSave" class="btn-save" onclick="saveActivity()">Add Row to DB</button>
                  <button id="btnCancelEdit" class="btn-cancel-edit" onclick="cancelEdit()">Cancel Editing</button>
                </div>
            </div>
        </div>
        <div class="data-table-wrapper">
            <table id="dataTable">
              <thead><tr><th>Zain?</th><th>Date</th><th>Activity Name</th><th>City</th><th>Audience</th><th>Actions</th></tr></thead>
              <tbody id="tableBody"></tbody>
            </table>
        </div>
      </div>

      <div id="tabMetrics" class="tab-content">
        <div class="form-grid">
            <div class="form-group"><label class="form-label">Year</label><input type="number" id="inpMetaYear" class="form-input" placeholder="2025"></div>
            <div class="form-group"><label class="form-label">Jobs Created</label><input type="number" id="inpMetaJobs" class="form-input" placeholder="0"></div>
            <div class="form-group"><label class="form-label">Actual Budget (IQD)</label><input type="number" id="inpMetaActual" class="form-input" placeholder="0"></div>
            <div class="form-group"><label class="form-label">Planned Budget (IQD)</label><input type="number" id="inpMetaPlanned" class="form-input" placeholder="0"></div>
            <button class="btn-save" style="margin-top:20px;" onclick="saveMetricRow()">Save Metric</button>
        </div>
        <div class="data-table-wrapper" style="margin-top:10px;">
            <table id="metricsTable"><thead><tr><th>Year</th><th>Jobs</th><th>Actual</th><th>Planned</th><th>Edit</th></tr></thead><tbody id="metricsTableBody"></tbody></table>
        </div>
      </div>

      <div id="tabUsers" class="tab-content">
          <div id="userList">Loading requests...</div>
      </div>

      <div id="tabAI" class="tab-content">
          <div style="background:rgba(217,70,239,0.05); padding:20px; border-radius:10px; border:1px solid rgba(217,70,239,0.2); display:flex; justify-content:space-between; align-items:center;">
              <div>
                  <h4 style="margin:0 0 5px 0; color:var(--accent);">Generate Annual Summary</h4>
                  <p style="margin:0; font-size:12px; color:var(--text-muted);">Uses Gemini 2.0 to analyze current data.</p>
              </div>
              <button id="btnGenSummary" class="btn-save" style="width:auto;" onclick="generateAndSaveSummary()">✨ Generate Report</button>
          </div>
      </div>
    </div>

    <div id="dashboardView">
      <div style="display:flex; justify-content:flex-end; gap:10px; margin-bottom:16px;">
         <div class="pill">Quarter: <select id="quarterFilter" onchange="applyFilters()"><option value="all">All Year</option><option value="q1">Q1</option><option value="q2">Q2</option><option value="q3">Q3</option><option value="q4">Q4</option></select></div>
      </div>

      <div class="grid grid-3" style="margin-bottom: 20px;">
        <div class="card">
            <div class="card-header-row"><div class="card-label">Total Activities</div><div class="badge-soft"><span class="badge-soft-dot"></span><span>Actual</span></div></div>
            <div id="kpiActivities" class="kpi-value">...</div>
            <div id="kpiActivitiesDelta" class="kpi-delta delta-neutral"></div>
            <div style="font-size:12px; color:#d946ef; margin-top:4px;"><span id="kpiZainRate">0%</span> Zain Led</div>
        </div>
        <div class="card"><div class="card-header-row"><div class="card-label">Participants</div><div class="badge-soft"><span class="badge-soft-dot"></span><span>vs Prev</span></div></div><div id="kpiAudience" class="kpi-value">...</div><div id="kpiAudienceDelta" class="kpi-delta delta-neutral"></div></div>
        <div class="card"><div class="card-header-row"><div class="card-label">Cities Covered</div><div class="badge-soft"><span class="badge-soft-dot"></span><span>Footprint</span></div></div><div id="kpiCities" class="kpi-value">...</div><div id="kpiCitiesDelta" class="kpi-delta delta-neutral"></div></div>
      </div>

      <div class="grid grid-4" style="margin-bottom: 20px;">
        <div id="cardBudget" class="card" style="grid-column: span 2;">
            <div class="card-header-row">
                <div class="card-label">Budget Analysis</div>
                <select id="currencySelectorCard" onchange="applyFilters()" class="card-filter">
                    <option value="IQD" selected>IQD (د.ع)</option>
                    <option value="USD">USD ($)</option>
                </select>
            </div>
            <div style="margin-bottom:12px;">
                <div class="budget-sub-label">Total Spent (Logistics)</div>
                <div id="kpiBudget" class="kpi-value" style="font-size:28px;">...</div>
                <div id="kpiBudgetDelta" class="kpi-delta delta-neutral"></div>
            </div>
            <div class="budget-grid">
                <div><div class="budget-sub-label">Actual Budget</div><div id="kpiBudgetActual" class="budget-sub-value">...</div></div>
                <div><div class="budget-sub-label">Planned Budget</div><div id="kpiBudgetPlanned" class="budget-sub-value">...</div></div>
            </div>
            <div class="budget-progress-bg"><div id="budgetProgressBar" class="budget-progress-fill"></div></div>
            <div class="budget-progress-text"><span id="budgetProgressText">0% of Actual</span><span id="budgetPlanComparison">...</span></div>
        </div>

        <div id="cardJobs" class="card" style="grid-column: span 2;">
            <div class="card-header-row"><div class="card-label">Jobs Created</div><div class="badge-soft"><span class="badge-soft-dot"></span><span>Impact</span></div></div>
            <div id="kpiJobs" class="kpi-value">...</div>
            <div class="kpi-note">Annual estimate (independent of activities).</div>
        </div>
      </div>
      
      <div id="rowSocial" class="grid grid-4" style="margin-bottom: 20px;">
        <div class="card"><div class="card-header-row"><div class="card-label">Social Reach</div></div><div id="kpiSocialReach" class="kpi-value">...</div></div>
        <div class="card"><div class="card-header-row"><div class="card-label">Social Engagement</div></div><div id="kpiSocialEngagement" class="kpi-value">...</div></div>
        <div class="card"><div class="card-header-row"><div class="card-label">Social Interaction</div></div><div id="kpiSocialInteraction" class="kpi-value">...</div></div>
        <div class="card"><div class="card-header-row"><div class="card-label">Social Impression</div></div><div id="kpiSocialImpression" class="kpi-value">...</div></div>
      </div>

      <div id="rowCharts" class="grid grid-2">
        <div class="card">
            <div class="chart-header">
                <div><div class="chart-title">Activities per Month</div></div>
                <select id="actChartFilter" onchange="updateActivitiesChart()" class="card-filter"></select>
            </div>
            <div class="chart-wrapper"><canvas id="activitiesChart"></canvas></div>
        </div>
        <div class="card">
            <div class="card-header-row"><div class="chart-title">SIM Distribution</div><select id="simYearFilter" onchange="updateSimChart()" class="card-filter"><option value="all">All Years</option></select></div>
            <div class="donut-card-body">
                <div class="donut-kpi-section"><div id="kpiSimShare" class="donut-big-number">0%</div><div class="donut-label">Zain Share</div></div>
                <div class="donut-chart-container"><canvas id="simChart"></canvas></div><div id="simLegend" class="donut-legend"></div>
            </div>
        </div>
      </div>

      <div id="rowCharts2" class="grid" style="margin-top: 16px;">
        <div class="card">
            <div class="card-header-row"><div class="chart-title">Gender Distribution</div><select id="genderYearFilter" onchange="updateGenderChart()" class="card-filter"><option value="all">All Years</option></select></div>
            <div class="donut-card-body">
                <div class="donut-kpi-section">
                    <div><div id="kpiMaleShare" class="donut-big-number" style="color:#38bdf8; font-size:32px;">0%</div><div class="donut-label">Male</div></div>
                    <div><div id="kpiFemaleShare" class="donut-big-number" style="color:#f472b6; font-size:32px;">0%</div><div class="donut-label">Female</div></div>
                </div>
                <div class="donut-chart-container"><canvas id="genderChart"></canvas></div><div id="genderLegend" class="donut-legend"></div>
            </div>
        </div>
      </div>
      
      <div id="trendChartsRow" class="grid grid-2" style="margin-top:16px;">
          <div class="card">
              <div class="chart-header"><div><div class="chart-title">Female Participation Trend</div></div></div>
              <div class="chart-wrapper"><canvas id="genderLineChart"></canvas></div>
          </div>
          <div class="card">
              <div class="chart-header"><div><div class="chart-title">Activity Growth (Yearly)</div></div></div>
              <div class="chart-wrapper"><canvas id="activitiesTrendChart"></canvas></div>
          </div>
      </div>
    </div>
  </div>

  <div id="toast">Saved Successfully!</div>

<script>
  // ⚠️ PASTE YOUR KEYS HERE (Preserved from your previous file)
  const supabaseUrl = 'https://xeohzbdgjgusavfonfkf.supabase.co'; 
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhlb2h6YmRnamd1c2F2Zm9uZmtmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5NjU5NzAsImV4cCI6MjA4MTU0MTk3MH0.5gO_0YgVdk9OFfrJuUrewhierc2wE7lVUst9vYd_DH4';
  
  const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

  // Constants
  const COLS_LOGISTICS = { name: "Activity Name", start_date: "Start Date", city: "City", audience: "Total Audience", budget: "Total Budget", status: "Status", year: "Year", description: "Description", is_zain: "is_zain_implemented" };
  const COLS_SOCIAL = { year: "Year", reach: "Reach", engagement: "Engagement", interaction: "Interaction", impression: "Impression" };
  const IQD_RATE = 1320;

  // Global State
  let isSignUp = false;
  let userRole = 'pending';
  let allLogistics = []; 
  let currentLogistics = []; 
  let comparisonLogistics = []; 
  let yearlyMetricsArray = []; 
  let rawSocial = [];
  let rawRegistration = [];
  
  // Charts Instances
  let simChartInstance = null;
  let genderChartInstance = null;
  let activitiesChartInstance = null;
  let genderLineChartInstance = null;
  let activitiesTrendChartInstance = null;

  // --- AUTH SYSTEM ---
  function toggleAuthMode() {
      isSignUp = !isSignUp;
      document.getElementById('authTitle').innerText = isSignUp ? "Request Access" : "Sign In";
      document.getElementById('mainAuthBtn').innerText = isSignUp ? "Submit Request" : "Sign In";
      document.getElementById('toggleAuthText').innerText = isSignUp ? "Already have an account? Sign In" : "No account? Request Access";
      document.getElementById('authMsg').innerText = "";
  }

  async function handleLogin() {
      const email = document.getElementById('email').value;
      const pass = document.getElementById('password').value;
      const msg = document.getElementById('authMsg');
      
      msg.style.color = "#fff"; msg.innerText = "Verifying...";

      if(isSignUp) {
          const { data, error } = await supabaseClient.auth.signUp({ email, password: pass });
          if(error) { msg.style.color = "var(--danger)"; msg.innerText = error.message; }
          else { msg.style.color = "var(--success)"; msg.innerText = "Account created. Please wait for Admin approval."; }
      } else {
          const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password: pass });
          if(error) { msg.style.color = "var(--danger)"; msg.innerText = "Invalid credentials."; }
          else { checkUserRole(data.user.id); }
      }
  }

  async function checkUserRole(uid) {
      const { data, error } = await supabaseClient.from('profiles').select('role').eq('id', uid).single();
      
      if(error || !data) {
          document.getElementById('authMsg').innerText = "Profile not found. Contact Admin.";
          return;
      }

      if(data.role === 'pending') {
          document.getElementById('authMsg').style.color = "var(--warning)";
          document.getElementById('authMsg').innerText = "Your account is pending Admin approval.";
          await supabaseClient.auth.signOut();
      } else {
          // Access Granted
          userRole = data.role;
          document.getElementById('authScreen').style.display = 'none';
          document.getElementById('mainApp').style.display = 'block';
          
          document.getElementById('roleBadge').innerText = userRole.toUpperCase();
          document.getElementById('roleBadge').className = `status-badge s-${userRole}`;
          
          if(userRole === 'admin') {
              document.getElementById('btnToggle').style.display = 'flex'; // Show manage button for admin
              fetchUsersList();
          }
          
          fetchAllData();
      }
  }

  async function handleLogout() {
      await supabaseClient.auth.signOut();
      location.reload();
  }

  // --- ADMIN SYSTEM ---
  function toggleAdminMode() {
      const dash = document.getElementById("dashboardView");
      const admin = document.getElementById("adminPanel");
      const btn = document.getElementById("btnToggle");
      
      if(!userRole === 'admin') return;

      if (dash.style.display === "none") {
          dash.style.display = "block";
          admin.style.display = "none";
          btn.innerHTML = '<span class="material-icons">settings</span> Manage Data';
          btn.classList.remove("active");
          fetchAllData();
      } else {
          dash.style.display = "none";
          admin.style.display = "block";
          btn.innerHTML = '<span class="material-icons">dashboard</span> View Dashboard';
          btn.classList.add("active");
          fetchAllData();
      }
  }

  function switchTab(tab) {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      
      if(tab === 'activities') { document.querySelector('.tab-btn:nth-child(1)').classList.add('active'); document.getElementById('tabActivities').classList.add('active'); }
      else if(tab === 'metrics') { document.querySelector('.tab-btn:nth-child(2)').classList.add('active'); document.getElementById('tabMetrics').classList.add('active'); }
      else if(tab === 'users') { document.querySelector('.tab-btn:nth-child(3)').classList.add('active'); document.getElementById('tabUsers').classList.add('active'); fetchUsersList(); }
      else { document.querySelector('.tab-btn:nth-child(4)').classList.add('active'); document.getElementById('tabAI').classList.add('active'); }
  }

  // --- USER MANAGEMENT ---
  async function fetchUsersList() {
      const { data, error } = await supabaseClient.from('profiles').select('*').order('created_at', {ascending: false});
      if(data) {
          let html = '';
          data.forEach(user => {
              if(user.role === 'admin') return; 
              html += `
              <div class="user-row">
                  <div>
                      <div style="font-size:13px; font-weight:600; color:#fff;">${user.email}</div>
                      <div class="status-badge s-${user.role}" style="display:inline-block; margin-top:4px;">${user.role}</div>
                  </div>
                  <div>
                      ${user.role === 'pending' ? `<button class="btn-action btn-approve" onclick="updateUserRole('${user.id}','viewer')">Approve</button>` : ''}
                      ${user.role === 'viewer' ? `<button class="btn-action btn-reject" onclick="updateUserRole('${user.id}','pending')">Revoke</button>` : ''}
                  </div>
              </div>`;
          });
          document.getElementById('userList').innerHTML = html || '<div style="color:#666; font-size:12px;">No pending requests.</div>';
      }
  }

  async function updateUserRole(uid, newRole) {
      const { error } = await supabaseClient.from('profiles').update({ role: newRole }).eq('id', uid);
      if(!error) { showToast("User Updated"); fetchUsersList(); }
  }

  // --- DATA LOADING & CHARTS ---
  async function fetchAllData() {
      try {
          const selectedYear = parseInt(document.getElementById("viewYear").value) || 2025;
          const prevYear = selectedYear - 1;
          document.getElementById("titleYear").textContent = selectedYear;

          // Logistics
          const { data: allLogs, error: err1 } = await supabaseClient.from('logistics_all').select('*');
          allLogistics = allLogs || [];
          currentLogistics = allLogistics.filter(row => row.Year == selectedYear);
          comparisonLogistics = allLogistics.filter(row => row.Year == prevYear);

          // Metrics & Social
          const { data: metrics } = await supabaseClient.from('yearly_metrics').select('*');
          yearlyMetricsArray = metrics || [];

          if(rawSocial.length === 0) {
              const { data: soc } = await supabaseClient.from('social_media').select('*').range(0,5000);
              rawSocial = soc || [];
              const d1 = await fetchAllRows('registration', '2025');
              const d2 = await fetchAllRows('the_station_database', '2023');
              const d3 = await fetchAllRows('makers_of_baghdad_database', '2025');
              rawRegistration = [...d1, ...d2, ...d3];
              populateYearFilters();
          }

          renderActivityTable();
          renderMetricsTable();
          renderKPIsAndCharts(selectedYear);

      } catch (err) { console.error("Error:", err); }
  }

  function renderKPIsAndCharts(selectedYear) {
      const prevYear = selectedYear - 1;
      const tSoc = { reach: 0, engagement: 0, interaction: 0, impression: 0 };
      
      rawSocial.forEach(row => { 
          if (String(row[COLS_SOCIAL.year]).trim() == selectedYear) { 
              tSoc.reach += toNumberSmart(row[COLS_SOCIAL.reach]); 
              tSoc.engagement += toNumberSmart(row[COLS_SOCIAL.engagement]); 
              tSoc.interaction += toNumberSmart(row[COLS_SOCIAL.interaction]); 
              tSoc.impression += toNumberSmart(row[COLS_SOCIAL.impression]); 
          }
      });
      document.getElementById("kpiSocialReach").textContent = tSoc.reach.toLocaleString();
      document.getElementById("kpiSocialEngagement").textContent = tSoc.engagement.toLocaleString();
      document.getElementById("kpiSocialInteraction").textContent = tSoc.interaction.toLocaleString();
      document.getElementById("kpiSocialImpression").textContent = tSoc.impression.toLocaleString();

      const metricsRow = yearlyMetricsArray.find(r => r.year == selectedYear); 
      const summaryText = metricsRow?.executive_summary || ""; 
      if(summaryText) {
          document.getElementById("summaryCard").style.display = "block";
          document.getElementById("aiSummaryText").textContent = summaryText;
      } else {
          document.getElementById("summaryCard").style.display = "none";
      }

      updateActivitiesChart(); applyFilters(); updateSimChart(); updateGenderChart(); renderGenderLineChart(); renderActivitiesTrendChart();
  }

  function applyFilters() {
    const qFilter = document.getElementById("quarterFilter").value; 
    const isAll = (qFilter === "all");
    
    document.getElementById("rowSocial").style.display = isAll ? "grid" : "none"; 
    document.getElementById("rowCharts").style.display = isAll ? "grid" : "none"; 
    document.getElementById("rowCharts2").style.display = isAll ? "grid" : "none"; 
    document.getElementById("cardJobs").style.display = isAll ? "block" : "none"; 
    document.getElementById("cardBudget").style.gridColumn = isAll ? "span 2" : "span 4";
    document.getElementById("trendChartsRow").style.display = isAll ? "grid" : "none";

    const mCurr = computeMetrics(currentLogistics, qFilter);
    const mPrev = (comparisonLogistics.length > 0) ? computeMetrics(comparisonLogistics, qFilter) : { activities:0, audience:0, budget:0, cities:0 };
    
    document.getElementById("kpiActivities").textContent = mCurr.activities.toLocaleString(); 
    document.getElementById("kpiAudience").textContent = mCurr.audience.toLocaleString(); 
    document.getElementById("kpiCities").textContent = mCurr.cities.toLocaleString();
    const zainRate = mCurr.activities > 0 ? ((mCurr.zainLed / mCurr.activities) * 100).toFixed(1) : 0; 
    document.getElementById("kpiZainRate").textContent = zainRate + "%";
    
    const currency = document.getElementById("currencySelectorCard").value; 
    const spentVal = mCurr.budget; 
    document.getElementById("kpiBudget").textContent = formatMoney(spentVal, currency);
    
    const selectedYear = parseInt(document.getElementById("viewYear").value) || 2025; 
    const metricsRow = yearlyMetricsArray.find(r => r.year == selectedYear) || { jobs_created:0, actual_budget:0, planned_budget:0 }; 
    document.getElementById("kpiJobs").textContent = parseInt(metricsRow.jobs_created).toLocaleString();
    
    const actual = parseInt(metricsRow.actual_budget) || 0; 
    const planned = parseInt(metricsRow.planned_budget) || 0;
    document.getElementById("kpiBudgetActual").textContent = formatMoney(actual, currency); 
    document.getElementById("kpiBudgetPlanned").textContent = formatMoney(planned, currency);
    
    let pct = actual > 0 ? Math.min((spentVal / actual) * 100, 100) : 0; 
    document.getElementById("budgetProgressBar").style.width = pct + "%"; 
    document.getElementById("budgetProgressText").textContent = pct.toFixed(1) + "% of Actual";
    
    if(planned > 0) { 
        const diff = ((actual - planned) / planned) * 100; 
        const sign = diff > 0 ? "+" : ""; 
        const color = diff > 0 ? "#f97373" : "#4ade80"; 
        document.getElementById("budgetPlanComparison").textContent = `${sign}${diff.toFixed(1)}% vs Plan`; 
        document.getElementById("budgetPlanComparison").style.color = color; 
    } else { document.getElementById("budgetPlanComparison").textContent = ""; }

    setDelta("kpiActivitiesDelta", mCurr.activities, mPrev.activities); 
    setDelta("kpiAudienceDelta", mCurr.audience, mPrev.audience); 
    setDelta("kpiBudgetDelta", mCurr.budget, mPrev.budget); 
    setDelta("kpiCitiesDelta", mCurr.cities, mPrev.cities);
  }

  function computeMetrics(data, quarterFilter) {
    let activities = 0, totalAudience = 0, totalBudget = 0, zainLed = 0; const citySet = new Set(); const selectedYear = parseInt(document.getElementById("viewYear").value) || 2025;
    data.forEach(row => {
      const status = String(row[COLS_LOGISTICS.status] || "").toLowerCase();
      if (status.includes("cancel") || status.includes("postpon")) return;
      if (quarterFilter !== "all") { const dObj = parseCustomDate(row[COLS_LOGISTICS.start_date], selectedYear); if (!dObj || getQuarter(dObj) !== quarterFilter) return; }
      const city = String(row[COLS_LOGISTICS.city] || "").trim().toLowerCase(); const isOnline = city.includes("online");
      activities++; if(!isOnline) totalAudience += toNumberSmart(row[COLS_LOGISTICS.audience]); totalBudget += toNumberSmart(row[COLS_LOGISTICS.budget]); if (row[COLS_LOGISTICS.is_zain] === true) zainLed++; if (city && city !== "city" && !isOnline) citySet.add(city);
    }); 
    return { activities, audience: totalAudience, budget: totalBudget, cities: citySet.size, zainLed };
  }

  // --- CHART RENDERERS ---
  function updateActivitiesChart() {
      const filter = document.getElementById("actChartFilter").value; 
      const mCounts = Array(12).fill(0);
      let dataset = (filter === "all") ? allLogistics : allLogistics.filter(row => row.Year == filter);
      dataset.forEach(row => { const d = parseCustomDate(row[COLS_LOGISTICS.start_date], row.Year); if(d) mCounts[d.getMonth()]++; });
      if (activitiesChartInstance) activitiesChartInstance.destroy();
      activitiesChartInstance = new Chart(document.getElementById("activitiesChart"), { type: "bar", data: { labels: ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"], datasets:[{ label: filter, data: mCounts, backgroundColor:"#d946ef", borderRadius:4 }] }, options: { maintainAspectRatio: false, plugins: { legend: { display:false } }, scales:{ y:{ grid:{ color:"#333"} }, x:{ grid:{ display:false } } } } });
  }
  function updateSimChart() {
    const yearFilter = document.getElementById("simYearFilter").value; let zain=0, asiacell=0, korek=0;
    rawRegistration.forEach(row => { if (yearFilter !== "all" && row._derivedYear !== yearFilter) return; const p = String(getSmartValue(row, ["Phone", "Mobile"])).replace(/\D/g,"").slice(-10); if(p.startsWith("78")||p.startsWith("79")) zain++; else if(p.startsWith("77")) asiacell++; else if(p.startsWith("75")) korek++; });
    const totalS = zain + asiacell + korek; document.getElementById("kpiSimShare").textContent = (totalS > 0 ? ((zain/totalS)*100).toFixed(1) : 0) + "%";
    document.getElementById("simLegend").innerHTML = `<div style="color:#d946ef">Zain: ${zain}</div><div style="color:#ef4444">Asia: ${asiacell}</div><div style="color:#3b82f6">Korek: ${korek}</div>`;
    if (simChartInstance) simChartInstance.destroy(); 
    simChartInstance = new Chart(document.getElementById("simChart"), { type: "doughnut", data: { labels: ["Zain","Asiacell","Korek"], datasets:[{ data:[zain, asiacell, korek], backgroundColor:["#d946ef", "#ef4444", "#3b82f6"], borderWidth:0, cutout: '70%' }] }, options: { maintainAspectRatio: false, plugins: { legend: { display: false } } } });
  }
  function updateGenderChart() {
    const yearFilter = document.getElementById("genderYearFilter").value; let male=0, female=0;
    rawRegistration.forEach(row => { if (yearFilter !== "all" && row._derivedYear !== yearFilter) return; const g = String(getSmartValue(row, ["Gender", "Sex"])).toLowerCase(); if (g.includes("f")) female++; else male++; });
    document.getElementById("kpiFemaleShare").textContent = (male+female > 0 ? ((female/(male+female))*100).toFixed(1) : 0) + "%";
    if (genderChartInstance) genderChartInstance.destroy(); 
    genderChartInstance = new Chart(document.getElementById("genderChart"), { type: "doughnut", data: { labels: ["Male","Female"], datasets:[{ data:[male, female], backgroundColor:["#38bdf8", "#f472b6"], borderWidth:0, cutout: '70%' }] }, options: { maintainAspectRatio: false, plugins: { legend: { display: false } } } });
  }
  function renderGenderLineChart() {
      const yearStats = {}; rawRegistration.forEach(row => { const y = row._derivedYear; if(!yearStats[y]) yearStats[y] = { m:0, f:0 }; const g = String(getSmartValue(row, ["Gender", "Sex"])).toLowerCase(); if (g.includes("f")) yearStats[y].f++; else yearStats[y].m++; });
      const years = Object.keys(yearStats).sort(); const percentages = years.map(y => { const t = yearStats[y].m + yearStats[y].f; return t > 0 ? ((yearStats[y].f / t) * 100).toFixed(1) : 0; });
      if (genderLineChartInstance) genderLineChartInstance.destroy();
      genderLineChartInstance = new Chart(document.getElementById("genderLineChart"), { type: 'line', data: { labels: years, datasets: [{ label: 'Female %', data: percentages, borderColor: '#f472b6', backgroundColor: 'rgba(244, 114, 182, 0.2)', fill: true }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, max: 100, grid: { color: '#333' } }, x: { grid: { display: false } } } } });
  }
  function renderActivitiesTrendChart() {
      const yearCounts = {}; allLogistics.forEach(row => { const y = row.Year; if(y) yearCounts[y] = (yearCounts[y] || 0) + 1; });
      const years = Object.keys(yearCounts).sort(); const counts = years.map(y => yearCounts[y]);
      if (activitiesTrendChartInstance) activitiesTrendChartInstance.destroy();
      activitiesTrendChartInstance = new Chart(document.getElementById("activitiesTrendChart"), { type: 'line', data: { labels: years, datasets: [{ label: 'Activities', data: counts, borderColor: '#d946ef', backgroundColor: 'rgba(217, 70, 239, 0.1)', fill: true }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: '#333' } }, x: { grid: { display: false } } } } });
  }

  // --- DATA ENTRY HELPERS ---
  function autoGenerateDesc() {
    const name = document.getElementById("inpName").value; const city = document.getElementById("inpCity").value; const dateStr = document.getElementById("inpDate").value; const aud = document.getElementById("inpAudience").value; const isZain = document.getElementById("inpZainImplemented").checked;
    if (!name || !dateStr) return alert("Name/Date required");
    const audienceNum = parseInt(aud) || 0; let scaleText = audienceNum > 100 ? `engaging ${audienceNum} attendees` : `with ${audienceNum} participants`; let contextText = isZain ? "Directly implemented by Zain Iraq." : "Supported through collaboration."; document.getElementById("inpDesc").value = `The ${name} was held in ${city} on ${dateStr}, ${scaleText}. ${contextText}`;
  }
  async function saveActivity() { const editId = document.getElementById("editId").value; const name = document.getElementById("inpName").value; const date = document.getElementById("inpDate").value; if (!name || !date) return alert("Name/Date required"); const rowData = { [COLS_LOGISTICS.name]: name, [COLS_LOGISTICS.start_date]: date, [COLS_LOGISTICS.city]: document.getElementById("inpCity").value, [COLS_LOGISTICS.audience]: document.getElementById("inpAudience").value, [COLS_LOGISTICS.budget]: document.getElementById("inpBudget").value, [COLS_LOGISTICS.status]: document.getElementById("inpStatus").value, [COLS_LOGISTICS.description]: document.getElementById("inpDesc").value, [COLS_LOGISTICS.is_zain]: document.getElementById("inpZainImplemented").checked, "Year": new Date(date).getFullYear() }; try { if (editId) { await supabaseClient.from('logistics_all').update(rowData).eq('id', editId); } else { await supabaseClient.from('logistics_all').insert([rowData]); } cancelEdit(); showToast("Saved!"); fetchAllData(); } catch (err) { alert(err.message); } }
  async function deleteActivity(id) { if(confirm("Delete?")) { await supabaseClient.from('logistics_all').delete().eq('id', id); fetchAllData(); } }
  function startEdit(id) { const row = allLogistics.find(r => r.id === id); if(row) { document.getElementById("editId").value = id; document.getElementById("inpName").value = row[COLS_LOGISTICS.name]; document.getElementById("inpDate").value = row[COLS_LOGISTICS.start_date]; document.getElementById("inpCity").value = row[COLS_LOGISTICS.city]; document.getElementById("inpStatus").value = row[COLS_LOGISTICS.status]; document.getElementById("inpAudience").value = row[COLS_LOGISTICS.audience]; document.getElementById("inpBudget").value = row[COLS_LOGISTICS.budget]; document.getElementById("inpDesc").value = row[COLS_LOGISTICS.description]; document.getElementById("inpZainImplemented").checked = row[COLS_LOGISTICS.is_zain]; document.getElementById("btnSave").innerText = "Update"; document.getElementById("btnCancelEdit").style.display = "block"; } }
  function cancelEdit() { document.getElementById("editId").value = ""; document.getElementById("inpName").value = ""; document.getElementById("inpDesc").value = ""; document.getElementById("btnSave").innerText = "Add Row"; document.getElementById("btnCancelEdit").style.display = "none"; }
  async function saveMetricRow() { const y=document.getElementById("inpMetaYear").value; const j=document.getElementById("inpMetaJobs").value; const a=document.getElementById("inpMetaActual").value; const p=document.getElementById("inpMetaPlanned").value; await supabaseClient.from('yearly_metrics').upsert({ year: y, jobs_created: j, actual_budget: a, planned_budget: p }); showToast("Saved"); fetchAllData(); }
  function renderActivityTable() { const tbody = document.getElementById("tableBody"); tbody.innerHTML = ""; [...currentLogistics].sort((a,b)=>new Date(b[COLS_LOGISTICS.start_date])-new Date(a[COLS_LOGISTICS.start_date])).forEach(row => { tbody.innerHTML += `<tr><td><input type="checkbox" ${row[COLS_LOGISTICS.is_zain]?"checked":""} disabled></td><td>${row[COLS_LOGISTICS.start_date]}</td><td>${row[COLS_LOGISTICS.name]}</td><td>${row[COLS_LOGISTICS.city]}</td><td>${row[COLS_LOGISTICS.audience]}</td><td><button class="btn-icon edit" onclick="startEdit(${row.id})"><span class="material-icons">edit</span></button><button class="btn-icon del" onclick="deleteActivity(${row.id})"><span class="material-icons">delete</span></button></td></tr>`; }); }
  function renderMetricsTable() { const tbody = document.getElementById("metricsTableBody"); tbody.innerHTML=""; [...yearlyMetricsArray].sort((a,b)=>b.year-a.year).forEach(row=>{ tbody.innerHTML+=`<tr><td>${row.year}</td><td>${row.jobs_created}</td><td>${Number(row.actual_budget).toLocaleString()}</td><td>${Number(row.planned_budget).toLocaleString()}</td><td><button class="btn-icon edit" onclick="document.getElementById('inpMetaYear').value='${row.year}'"><span class="material-icons">edit</span></button></td></tr>`; }); }

  // AI Generator
  async function generateAndSaveSummary() {
    const year = document.getElementById("viewYear").value;
    let apiKey = localStorage.getItem("gemini_api_key");
    if (!apiKey) { apiKey = prompt("Please enter Gemini API Key:"); if (!apiKey) return; localStorage.setItem("gemini_api_key", apiKey); }
    const btn = document.getElementById("btnGenSummary");
    btn.innerText = "Generating..."; btn.disabled = true;
    try {
        const actCount = currentLogistics.length; 
        const totalAud = currentLogistics.reduce((acc, r) => acc + toNumberSmart(r[COLS_LOGISTICS.audience]||0), 0);
        const prompt = `Act as Head of Innovation at Zain Iraq. Write a powerful summary for ${year} CER (Corporate Entrepreneurship). Data: ${actCount} activities, ${totalAud} participants. Focus on ROI.`;
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
        const data = await response.json(); 
        const aiText = data.candidates[0].content.parts[0].text;
        await supabaseClient.from('yearly_metrics').update({ executive_summary: aiText }).eq('year', year);
        showToast("Report Updated!"); fetchAllData();
    } catch (err) { alert(err.message); } finally { btn.innerText = "✨ Generate Report"; btn.disabled = false; }
  }

  // Utils
  function setDelta(id, curr, prev) { const el = document.getElementById(id); if(!prev) { el.textContent="-"; return; } const d = ((curr - prev) / prev) * 100; el.textContent = `${d > 0 ? "▲" : "▼"} ${Math.abs(d).toFixed(1)}% vs Prev`; el.className = `kpi-delta ${d > 0 ? "delta-up" : "delta-down"}`; }
  function formatMoney(amount, currency) { if (!amount) amount = 0; if (currency === "IQD") return amount.toLocaleString() + " د.ع"; else { return "$" + (amount / IQD_RATE).toLocaleString(undefined, {maximumFractionDigits: 0}); } }
  function handleYearChange() { fetchAllData(); }
  function showToast(msg) { const x = document.getElementById("toast"); x.textContent = msg; x.className = "show"; setTimeout(() => { x.className = ""; }, 3000); }
  function toNumberSmart(v) { return Number(String(v).replace(/,/g, "")) || 0; }
  function parseCustomDate(val, targetYear) { if (!val) return null; let text = String(val).trim(); if (/^\d{1,2}-[a-zA-Z]{3}$/.test(text)) text = `${text}-${targetYear}`; let d = new Date(text); if (isNaN(d.getTime())) d = new Date(`${text} ${targetYear}`); return isNaN(d.getTime()) ? null : d; }
  function getQuarter(dateObj) { const m = dateObj.getMonth(); return m < 3 ? "q1" : m < 6 ? "q2" : m < 9 ? "q3" : "q4"; }
  async function fetchAllRows(table, defaultYear) { let allData = []; let page = 0; while (true) { const { data } = await supabaseClient.from(table).select('*').range(page * 5000, (page + 1) * 5000 - 1); if (!data || data.length === 0) break; allData = allData.concat(data.map(row => ({ ...row, _derivedYear: String(getSmartValue(row, ["Year"]) || defaultYear) }))); page++; } return allData; }
  function getSmartValue(row, possibleNames) { for (let name of possibleNames) if (row[name] !== undefined) return row[name]; return ""; }
  function populateYearFilters() { const uniqueYears = new Set(rawRegistration.map(r=>r._derivedYear)); const s=document.getElementById("simYearFilter"); const g=document.getElementById("genderYearFilter"); const a=document.getElementById("actChartFilter"); s.innerHTML='<option value="all">All Years</option>'; g.innerHTML='<option value="all">All Years</option>'; a.innerHTML='<option value="all">All Years</option>'; uniqueYears.forEach(y => { s.add(new Option(y,y)); g.add(new Option(y,y)); a.add(new Option(y,y)); }); }

  const style = document.createElement('style'); style.innerHTML = `@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }`; document.head.appendChild(style);
</script>
</body>
</html>
