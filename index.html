<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CER Impact Dashboard (Final Polish)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  
  <style>
    /* --- MAIN STYLES --- */
    :root { --bg-main: #040011; --bg-card: #0c071d; --bg-card-soft: #120a2a; --border-subtle: #231a3c; --accent: #d946ef; --accent-soft: #9333ea; --text-main: #f9fafb; --text-muted: #9ca3af; --text-soft: #6b7280; --success: #4ade80; --warning: #facc15; --danger: #f97373; --chip-bg: rgba(255,255,255,0.06); }
    * { box-sizing: border-box; }
    body { margin: 0; padding: 0; background: radial-gradient(circle at top left, #321b5d 0, #040011 45%, #02000a 100%); color: var(--text-main); font-family: system-ui, -apple-system, BlinkMacSystemFont, "Inter", Arial, sans-serif; overflow-x: hidden; }
    
    .page { width: 95%; max-width: 1800px; margin: 0 auto; padding: 24px 16px 40px; }
    
    .top-nav { display: flex; align-items: center; justify-content: space-between; gap: 12px; margin-bottom: 18px; }
    .brand-area { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
    .brand-chip { display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; border-radius: 999px; background: var(--chip-bg); border: 1px solid rgba(255,255,255,0.08); font-size: 11px; letter-spacing: 0.04em; text-transform: uppercase; color: var(--text-soft); }
    .brand-dot { width: 7px; height: 7px; border-radius: 999px; background: var(--accent); box-shadow: 0 0 0 3px rgba(217,70,239,0.4); }
    
    .top-controls { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; justify-content: flex-end; }
    .pill { padding: 6px 12px; border-radius: 999px; border: 1px solid rgba(148,163,184,0.4); font-size: 12px; color: #e5e7eb; display: inline-flex; align-items: center; gap: 6px; background: rgba(15,23,42,0.8); }
    
    select { background-color: transparent; border: none; color: #f9fafb; font-size: 12px; outline: none; padding: 2px 4px; cursor: pointer; font-weight: 500; }
    select option { background-color: #0c071d; color: #fff; padding: 10px; }
    
    .btn-admin { background: var(--accent); color: white; border: none; padding: 6px 16px; border-radius: 999px; font-size: 12px; cursor: pointer; font-weight: 600; transition: 0.2s; display: flex; align-items: center; gap: 6px; }
    .btn-admin:hover { background: var(--accent-soft); }
    .btn-admin.active { background: #fff; color: #000; }

    h1 { font-size: 26px; margin: 0 0 4px; }
    .subtitle { font-size: 13px; color: var(--text-muted); margin-bottom: 20px; }

    .grid { display: grid; gap: 16px; }
    .grid-4 { grid-template-columns: repeat(4, minmax(0, 1fr)); }
    .grid-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); } 
    .grid-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    @media (max-width: 1100px) { .grid-4, .grid-3 { grid-template-columns: repeat(2, minmax(0, 1fr)); } }
    @media (max-width: 700px) { .grid-4, .grid-3, .grid-2 { grid-template-columns: minmax(0, 1fr); } }

    .card { background: linear-gradient(145deg, var(--bg-card) 0, var(--bg-card-soft) 100%); border-radius: 20px; padding: 16px 18px; border: 1px solid var(--border-subtle); box-shadow: 0 18px 40px rgba(0,0,0,0.45); transition: 0.3s; display: flex; flex-direction: column; }
    .card-header-row { display: flex; align-items: center; justify-content: space-between; gap: 8px; margin-bottom: 10px; width: 100%; }
    .card-label { font-size: 11px; letter-spacing: 0.16em; text-transform: uppercase; color: var(--text-soft); font-weight: 500; }
    .badge-soft { display: inline-flex; align-items: center; gap: 6px; padding: 3px 8px; border-radius: 999px; background: rgba(14,148,136,0.1); color: #6ee7b7; font-size: 10px; border: 1px solid rgba(16,185,129,0.4); white-space: nowrap; }
    .badge-soft-dot { width: 6px; height: 6px; border-radius: 999px; background: #22c55e; }
    .badge-soft.red { background: rgba(248,113,113,0.08); color: #fecaca; border-color: rgba(248,113,113,0.4); }
    .badge-soft.red .badge-soft-dot { background: #f87171; }
    .kpi-value { font-size: 32px; font-weight: 700; margin-bottom: 4px; }
    .kpi-delta { font-size: 11px; margin-bottom: 6px; }
    .delta-up { color: var(--success); }
    .delta-down { color: var(--danger); }
    .delta-neutral { color: var(--text-muted); }
    .kpi-note { font-size: 11px; color: var(--text-soft); line-height: 1.4; }
    
    .chart-wrapper { position: relative; width: 100%; height: 270px; }
    .chart-header { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 10px; gap: 8px; }
    .chart-title { font-size: 13px; font-weight: 500; }
    .error-text { font-size: 12px; color: var(--danger); margin-bottom: 12px; white-space: pre-wrap; }

    /* --- DONUT CARD STYLES --- */
    .donut-card-body {
        display: flex; 
        align-items: center; 
        justify-content: space-between; 
        gap: 16px; 
        height: 270px;
        overflow: hidden; 
    }
    
    /* LEFT: Big Number Section */
    .donut-kpi-section {
        flex: 0 0 auto; 
        text-align: center;
        min-width: 80px;
        display: flex;
        flex-direction: column;
        gap: 20px; /* Space between Male and Female blocks */
        justify-content: center;
    }
    .donut-big-number { font-size: 40px; font-weight: 800; color: var(--accent); line-height: 1; }
    .donut-label { font-size: 12px; color: var(--text-muted); margin-top: 4px; text-transform: uppercase; letter-spacing: 1px; }
    
    /* MIDDLE: Chart */
    .donut-chart-container {
        flex: 1; 
        height: 100%; 
        position: relative;
        min-width: 0; 
    }
    
    /* RIGHT: Legend */
    .donut-legend {
        flex: 0 0 160px; 
        display: flex; 
        flex-direction: column; 
        justify-content: center; 
        gap: 12px;
    }
    .legend-item { display: flex; align-items: center; justify-content: space-between; font-size: 12px; gap: 10px; }
    .legend-left { display: flex; align-items: center; gap: 8px; color: var(--text-main); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .legend-dot { width: 10px; height: 10px; border-radius: 3px; flex-shrink: 0; }
    .legend-right { text-align: right; min-width: 60px; }
    .legend-pct { display: block; font-weight: 700; color: #fff; }
    .legend-count { display: block; font-size: 10px; color: var(--text-soft); }
    
    .card-filter { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; padding: 2px 8px; font-size: 11px; color: var(--text-muted); }

    /* ADMIN */
    #adminPanel { display: none; }
    .admin-controls { background: var(--bg-card); padding: 20px; border-radius: 12px; border: 1px solid var(--border-subtle); margin-bottom: 20px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; align-items: start; }
    .full-width { grid-column: span 4; }
    @media (max-width: 800px) { .admin-controls { grid-template-columns: 1fr; } .full-width { grid-column: auto; } }
    .form-group { width: 100%; }
    .form-label { font-size: 11px; color: var(--text-soft); margin-bottom: 4px; display: block; }
    .form-input { width: 100%; background: rgba(255,255,255,0.05); border: 1px solid var(--border-subtle); color: white; padding: 8px 12px; border-radius: 6px; outline: none; }
    .form-input:focus { border-color: var(--accent); }
    textarea.form-input { min-height: 60px; resize: vertical; font-family: inherit; }
    .btn-save { background: var(--success); color: #000; border: none; padding: 10px 20px; border-radius: 6px; font-weight: 600; cursor: pointer; width: 100%; margin-top: 10px; }
    .btn-update { background: var(--warning); color: #000; } 
    .btn-cancel-edit { background: transparent; color: var(--text-muted); border: 1px solid var(--border-subtle); width: 100%; padding: 10px; border-radius: 6px; margin-top: 6px; cursor: pointer; display: none; }
    .btn-ai { background: linear-gradient(135deg, #6366f1, #d946ef); color: white; border: none; padding: 4px 10px; border-radius: 4px; font-size: 10px; cursor: pointer; float: right; margin-bottom: 4px; font-weight: 600; display: flex; align-items: center; gap:4px; }
    .btn-ai:hover { opacity: 0.9; }
    .report-box { background: rgba(14,165,233,0.1); border: 1px solid rgba(14,165,233,0.3); padding: 16px; border-radius: 12px; margin-bottom: 20px; display: flex; gap: 16px; align-items: flex-end; flex-wrap: wrap; }
    .btn-download { background: #0ea5e9; color: white; border: none; padding: 8px 16px; border-radius: 6px; font-weight: 600; cursor: pointer; height: 35px; display: flex; align-items: center; gap: 6px; }
    .btn-download:hover { background: #0284c7; }
    .data-table-wrapper { overflow-x: auto; background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border-subtle); max-height: 600px; overflow-y: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 13px; text-align: left; }
    th { background: rgba(255,255,255,0.03); color: var(--text-muted); padding: 12px 16px; border-bottom: 1px solid var(--border-subtle); font-weight: 500; white-space: nowrap; position: sticky; top: 0; backdrop-filter: blur(10px); }
    td { padding: 12px 16px; border-bottom: 1px solid rgba(255,255,255,0.04); color: var(--text-main); white-space: nowrap; vertical-align: top; }
    tr:last-child td { border-bottom: none; }
    tr:hover td { background: rgba(255,255,255,0.02); }
    .desc-cell { white-space: normal; min-width: 250px; max-width: 400px; color: var(--text-soft); font-size: 12px; line-height: 1.4; }
    .btn-icon { background: transparent; border: none; color: var(--text-soft); cursor: pointer; padding: 4px; border-radius: 4px; }
    .btn-icon:hover { background: rgba(255,255,255,0.1); color: white; }
    .btn-icon.del:hover { color: var(--danger); background: rgba(249,115,115,0.1); }
    .btn-icon.edit:hover { color: var(--warning); background: rgba(250,204,21,0.1); }
    .material-icons { font-size: 18px; vertical-align: middle; }
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(4px); display: none; align-items: center; justify-content: center; z-index: 9999; }
    .modal-box { background: var(--bg-card); border: 1px solid var(--border-subtle); padding: 24px; border-radius: 16px; width: 90%; max-width: 320px; }
    .login-title { text-align: center; margin-bottom: 20px; }
    .modal-actions { display: flex; justify-content: center; gap: 10px; margin-top: 20px; }
    .btn-cancel { background: transparent; color: var(--text-soft); border: none; cursor: pointer; }
  </style>
</head>
<body>
  <div class="page">
    <div class="top-nav">
      <div class="brand-area">
        <div class="brand-chip"><span class="brand-dot"></span><span>CER · Zain Iraq</span></div>
        <button id="btnToggle" class="btn-admin" onclick="toggleAdminMode()">
          <span class="material-icons">settings</span> Manage Data
        </button>
      </div>
      <div class="top-controls">
        <div class="pill">
          Logistics Year:
          <select id="viewYear" onchange="handleYearChange()">
            <option value="2026">2026</option>
            <option value="2025" selected>2025</option>
            <option value="2024">2024</option>
            <option value="2023">2023</option>
            <option value="2022">2022</option>
            <option value="2021">2021</option>
            <option value="2020">2020</option>
            <option value="2019">2019</option>
          </select>
        </div>
        <div class="update-text">Status: <span class="update-bold">Live</span></div>
      </div>
    </div>

    <h1>CER Impact Dashboard</h1>
    <div class="subtitle">Live view of <span id="titleYear">2025</span> activities.</div>
    <div id="globalError" class="error-text"></div>

    <div id="dashboardView">
      <div style="display:flex; justify-content:flex-end; gap:10px; margin-bottom:16px;">
         <div class="pill">Quarter: <select id="quarterFilter" onchange="applyFilters()"><option value="all">All Year</option><option value="q1">Q1</option><option value="q2">Q2</option><option value="q3">Q3</option><option value="q4">Q4</option></select></div>
      </div>

      <div class="grid grid-3" style="margin-bottom: 20px;">
        <div class="card"><div class="card-header-row"><div class="card-label">Total Activities</div><div class="badge-soft"><span class="badge-soft-dot"></span><span>Actual</span></div></div><div id="kpiActivities" class="kpi-value">...</div><div id="kpiActivitiesDelta" class="kpi-delta delta-neutral"></div></div>
        <div class="card"><div class="card-header-row"><div class="card-label">Participants</div><div id="audienceDeltaBadge" class="badge-soft"><span class="badge-soft-dot"></span><span id="audienceDeltaBadgeText">vs Prev</span></div></div><div id="kpiAudience" class="kpi-value">...</div><div id="kpiAudienceDelta" class="kpi-delta delta-neutral"></div></div>
        <div class="card"><div class="card-header-row"><div class="card-label">Cities Covered</div><div class="badge-soft"><span class="badge-soft-dot"></span><span>Footprint</span></div></div><div id="kpiCities" class="kpi-value">...</div><div id="kpiCitiesDelta" class="kpi-delta delta-neutral"></div></div>
      </div>

      <div class="grid grid-4" style="margin-bottom: 20px;">
        <div id="cardBudget" class="card" style="grid-column: span 2;"><div class="card-header-row"><div class="card-label">Budget Spent</div></div><div id="kpiBudget" class="kpi-value">...</div><div id="kpiBudgetDelta" class="kpi-delta delta-neutral"></div></div>
        <div id="cardJobs" class="card" style="grid-column: span 2;"><div class="card-header-row"><div class="card-label">Jobs Created</div><div class="badge-soft"><span class="badge-soft-dot"></span><span>Impact</span></div></div><div class="kpi-value">220</div><div class="kpi-note">Annual Estimate</div></div>
      </div>
      
      <div id="rowSocial" class="grid grid-4" style="margin-bottom: 20px;">
        <div class="card"><div class="card-header-row"><div class="card-label">Social Reach</div></div><div id="kpiSocialReach" class="kpi-value">...</div><div id="kpiSocialReachDelta" class="kpi-delta delta-neutral"></div></div>
        <div class="card"><div class="card-header-row"><div class="card-label">Social Engagement</div></div><div id="kpiSocialEngagement" class="kpi-value">...</div><div id="kpiSocialEngagementDelta" class="kpi-delta delta-neutral"></div></div>
        <div class="card"><div class="card-header-row"><div class="card-label">Social Interaction</div></div><div id="kpiSocialInteraction" class="kpi-value">...</div><div id="kpiSocialInteractionDelta" class="kpi-delta delta-neutral"></div></div>
        <div class="card"><div class="card-header-row"><div class="card-label">Social Impression</div></div><div id="kpiSocialImpression" class="kpi-value">...</div><div id="kpiSocialImpressionDelta" class="kpi-delta delta-neutral"></div></div>
      </div>

      <div id="rowCharts" class="grid grid-2">
        <div class="card"><div class="chart-header"><div><div class="chart-title">Activities per Month</div></div></div><div class="chart-wrapper"><canvas id="activitiesChart"></canvas></div></div>
        
        <div class="card">
            <div class="card-header-row">
                <div class="chart-title">SIM Distribution</div>
                <select id="simYearFilter" onchange="updateSimChart()" class="card-filter"><option value="all">All Years</option></select>
            </div>
            <div class="donut-card-body">
                <div class="donut-kpi-section">
                    <div id="kpiSimShare" class="donut-big-number">0%</div>
                    <div class="donut-label">Zain Share</div>
                </div>
                <div class="donut-chart-container"><canvas id="simChart"></canvas></div>
                <div id="simLegend" class="donut-legend"></div>
            </div>
        </div>
      </div>

      <div id="rowCharts2" class="grid" style="margin-top: 16px;">
        <div class="card">
            <div class="card-header-row">
                <div class="chart-title">Gender Distribution</div>
                <select id="genderYearFilter" onchange="updateGenderChart()" class="card-filter"><option value="all">All Years</option></select>
            </div>
            <div class="donut-card-body">
                <div class="donut-kpi-section">
                    <div>
                        <div id="kpiMaleShare" class="donut-big-number" style="color:#38bdf8; font-size:32px;">0%</div>
                        <div class="donut-label">Male</div>
                    </div>
                    <div>
                        <div id="kpiFemaleShare" class="donut-big-number" style="color:#f472b6; font-size:32px;">0%</div>
                        <div class="donut-label">Female</div>
                    </div>
                </div>
                
                <div class="donut-chart-container"><canvas id="genderChart"></canvas></div>
                <div id="genderLegend" class="donut-legend"></div>
            </div>
        </div>
      </div>
    </div>

    <div id="adminPanel">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <h3 style="margin:0; color:#fff;">Manage Data (<span id="adminYearLabel">2025</span>)</h3>
        <span style="font-size:11px; color:var(--text-soft);">Editing enabled</span>
      </div>

      <div class="report-box">
        <div style="flex:1; color:#7dd3fc; font-size:13px; display:flex; align-items:center; gap:6px;">
            <span class="material-icons">description</span> <strong>Generate Excel Report</strong>
        </div>
        <div class="form-group" style="width:auto;"><label class="form-label">Start Date</label><input type="date" id="reportStart" class="form-input"></div>
        <div class="form-group" style="width:auto;"><label class="form-label">End Date</label><input type="date" id="reportEnd" class="form-input"></div>
        <button class="btn-download" onclick="downloadReport()">Download .CSV</button>
      </div>
      
      <div class="admin-controls" id="entryForm">
        <input type="hidden" id="editId" value="">
        <div class="form-group"><label class="form-label">Activity Name</label><input type="text" id="inpName" class="form-input" placeholder="Name"></div>
        <div class="form-group"><label class="form-label">Date</label><input type="date" id="inpDate" class="form-input"></div>
        <div class="form-group"><label class="form-label">City</label><input type="text" id="inpCity" class="form-input" placeholder="City"></div>
        <div class="form-group"><label class="form-label">Status</label><select id="inpStatus" class="form-input"><option value="Completed">Completed</option><option value="Planned">Planned</option></select></div>
        <div class="form-group"><label class="form-label">Audience</label><input type="number" id="inpAudience" class="form-input" placeholder="0"></div>
        <div class="form-group"><label class="form-label">Budget</label><input type="number" id="inpBudget" class="form-input" placeholder="0"></div>
        <div class="form-group full-width">
          <button class="btn-ai" onclick="autoGenerateDesc()">✨ Auto-Generate</button>
          <label class="form-label">Description (Optional)</label>
          <textarea id="inpDesc" class="form-input" placeholder="Enter brief details about the activity..."></textarea>
          <button id="btnSave" class="btn-save" onclick="saveActivity()">Add Row to DB</button>
          <button id="btnCancelEdit" class="btn-cancel-edit" onclick="cancelEdit()">Cancel Editing</button>
        </div>
      </div>

      <div class="data-table-wrapper">
        <table id="dataTable">
          <thead><tr><th>Date</th><th>Activity Name</th><th>City</th><th>Audience</th><th>Description</th><th style="width:70px;">Actions</th></tr></thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>

  </div>

  <div id="loginModal" class="modal-overlay">
    <div class="modal-box" style="max-width: 320px;">
      <h3 class="login-title">Admin Login</h3>
      <div class="form-group"><input type="password" id="adminPassInput" class="form-input" placeholder="Enter Password"></div>
      <div class="modal-actions" style="justify-content: center;">
        <button class="btn-cancel" onclick="closeLogin()">Cancel</button>
        <button class="btn-save" onclick="checkLogin()">Login</button>
      </div>
    </div>
  </div>

<script>
  // ⚠️ PASTE KEYS
  const supabaseUrl = 'https://xeohzbdgjgusavfonfkf.supabase.co'; 
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhlb2h6YmRnamd1c2F2Zm9uZmtmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5NjU5NzAsImV4cCI6MjA4MTU0MTk3MH0.5gO_0YgVdk9OFfrJuUrewhierc2wE7lVUst9vYd_DH4';  
  const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

  const COLS_LOGISTICS = { name: "Activity Name", start_date: "Start Date", city: "City", audience: "Total Audience", budget: "Total Budget", status: "Status", year: "Year", description: "Description" };
  const COLS_SOCIAL = { year: "Year", reach: "Reach", engagement: "Engagement", interaction: "Interaction", impression: "Impression" };

  let isAdmin = false; 
  let currentLogistics = []; 
  let comparisonLogistics = [];
  let rawSocial = [];
  let rawRegistration = [];
  let simChartInstance = null;
  let genderChartInstance = null;
  let activitiesChartInstance = null;

  // --- HELPERS ---
  function calculateDelta(curr, prev) {
      const selectedYear = parseInt(document.getElementById("viewYear").value) || 2025;
      const prevYear = selectedYear - 1;
      if (!prev || prev === 0) return { t: "—", c: "kpi-delta delta-neutral" };
      const d = ((curr - prev) / prev) * 100;
      const a = d > 0 ? "▲" : d < 0 ? "▼" : "";
      const cl = d > 0 ? "delta-up" : d < 0 ? "delta-down" : "delta-neutral";
      return { t: `${a} ${Math.abs(d).toFixed(1)}% vs ${prevYear}`, c: `kpi-delta ${cl}` };
  }

  // --- REPORT GENERATOR ---
  function downloadReport() {
      const startStr = document.getElementById("reportStart").value; const endStr = document.getElementById("reportEnd").value;
      if (!startStr || !endStr) { alert("Please select both Start and End dates."); return; }
      const start = new Date(startStr); const end = new Date(endStr); end.setHours(23,59,59); 
      const filtered = currentLogistics.filter(row => { const d = new Date(row[COLS_LOGISTICS.start_date]); return d >= start && d <= end; });
      if (filtered.length === 0) { alert("No activities found in this date range."); return; }
      let csv = "Date,Activity Name,City,Audience,Budget,Status,Description\n";
      filtered.forEach(row => {
          const cleanDesc = (row[COLS_LOGISTICS.description] || "").replace(/(\r\n|\n|\r)/gm, " ").replace(/"/g, '""');
          const line = [`"${row[COLS_LOGISTICS.start_date]}"`,`"${row[COLS_LOGISTICS.name]}"`,`"${row[COLS_LOGISTICS.city]}"`,`"${row[COLS_LOGISTICS.audience]}"`,`"${row[COLS_LOGISTICS.budget]}"`,`"${row[COLS_LOGISTICS.status]}"`,`"${cleanDesc}"`].join(",");
          csv += line + "\n";
      });
      const blob = new Blob([csv], { type: 'text/csv' }); const url = window.URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `Report_${startStr}_to_${endStr}.csv`; a.click(); window.URL.revokeObjectURL(url);
  }

  // --- AI WRITER ---
  function autoGenerateDesc() {
    const name = document.getElementById("inpName").value; const city = document.getElementById("inpCity").value; const date = document.getElementById("inpDate").value; const aud = document.getElementById("inpAudience").value; const stat = document.getElementById("inpStatus").value;
    if (!name || !city || !date) { alert("Please fill in Name, City, and Date first!"); return; }
    const templates = [
        `The ${name} was successfully ${stat.toLowerCase()} in ${city} on ${date}. This initiative engaged ${aud || 'various'} participants, focusing on innovation and skill development within the community.`,
        `On ${date}, the team conducted the ${name} in ${city}. With a turnout of ${aud || 0}, the event aimed to foster growth and support local talent under the CER program.`,
        `Zain Iraq is proud to have supported the ${name} in ${city}. Held on ${date}, this activity reached ${aud || 0} individuals, reinforcing our commitment to youth empowerment.`
    ];
    document.getElementById("inpDesc").value = templates[Math.floor(Math.random() * templates.length)];
  }

  // --- EDITING & ADMIN ---
  function startEdit(id) {
    const row = currentLogistics.find(r => r.id === id); if (!row) return;
    document.getElementById("editId").value = id; document.getElementById("inpName").value = row[COLS_LOGISTICS.name]; document.getElementById("inpDate").value = row[COLS_LOGISTICS.start_date]; document.getElementById("inpCity").value = row[COLS_LOGISTICS.city]; document.getElementById("inpStatus").value = row[COLS_LOGISTICS.status] || "Completed"; document.getElementById("inpAudience").value = row[COLS_LOGISTICS.audience]; document.getElementById("inpBudget").value = row[COLS_LOGISTICS.budget]; document.getElementById("inpDesc").value = row[COLS_LOGISTICS.description] || "";
    const btnSave = document.getElementById("btnSave"); btnSave.textContent = "Update Activity"; btnSave.classList.remove("btn-save"); btnSave.classList.add("btn-update");
    document.getElementById("btnCancelEdit").style.display = "block"; document.getElementById("entryForm").scrollIntoView({behavior: "smooth"});
  }
  function cancelEdit() {
    document.getElementById("editId").value = ""; document.getElementById("inpName").value = ""; document.getElementById("inpDate").value = ""; document.getElementById("inpCity").value = ""; document.getElementById("inpAudience").value = ""; document.getElementById("inpBudget").value = ""; document.getElementById("inpDesc").value = "";
    const btnSave = document.getElementById("btnSave"); btnSave.textContent = "Add Row to DB"; btnSave.classList.remove("btn-update"); btnSave.classList.add("btn-save"); document.getElementById("btnCancelEdit").style.display = "none";
  }
  function toggleAdminMode() {
    if (!isAdmin) { openLogin(); } else {
      const dash = document.getElementById("dashboardView"); const admin = document.getElementById("adminPanel"); const btn = document.getElementById("btnToggle");
      if (dash.style.display === "none") { dash.style.display = "block"; admin.style.display = "none"; btn.innerHTML = '<span class="material-icons">settings</span> Manage Data'; btn.classList.remove("active"); loadData(); } 
      else { dash.style.display = "none"; admin.style.display = "block"; btn.innerHTML = '<span class="material-icons">dashboard</span> View Dashboard'; btn.classList.add("active"); renderTable(); }
    }
  }
  function renderTable() {
    const tbody = document.getElementById("tableBody"); tbody.innerHTML = "";
    const sorted = [...currentLogistics].sort((a,b) => new Date(b[COLS_LOGISTICS.start_date]) - new Date(a[COLS_LOGISTICS.start_date]));
    sorted.forEach(row => {
      const tr = document.createElement("tr"); let desc = row[COLS_LOGISTICS.description] || "";
      tr.innerHTML = `<td>${row[COLS_LOGISTICS.start_date]}</td><td><strong>${row[COLS_LOGISTICS.name]}</strong></td><td>${row[COLS_LOGISTICS.city]}</td><td>${Number(row[COLS_LOGISTICS.audience]).toLocaleString()}</td><td class="desc-cell">${desc}</td><td style="text-align:center; white-space:nowrap;"><button class="btn-icon edit" onclick="startEdit(${row.id})" title="Edit"><span class="material-icons">edit</span></button><button class="btn-icon del" onclick="deleteActivity(${row.id})" title="Delete"><span class="material-icons">delete</span></button></td>`; tbody.appendChild(tr);
    });
  }
  async function saveActivity() {
    const editId = document.getElementById("editId").value; const name = document.getElementById("inpName").value; const date = document.getElementById("inpDate").value; const city = document.getElementById("inpCity").value; const aud = document.getElementById("inpAudience").value; const bud = document.getElementById("inpBudget").value; const stat = document.getElementById("inpStatus").value; const desc = document.getElementById("inpDesc").value;
    if (!name || !date) { alert("Name and Date are required!"); return; }
    const rowData = { [COLS_LOGISTICS.name]: name, [COLS_LOGISTICS.start_date]: date, [COLS_LOGISTICS.city]: city, [COLS_LOGISTICS.audience]: aud, [COLS_LOGISTICS.budget]: bud, [COLS_LOGISTICS.status]: stat, [COLS_LOGISTICS.description]: desc };
    try {
      if (editId) { const { error } = await supabaseClient.from('logistics_all').update(rowData).eq('id', editId); if (error) throw error; alert("Updated successfully!"); } 
      else { const { error } = await supabaseClient.from('logistics_all').insert([rowData]); if (error) throw error; alert("Added successfully!"); }
      cancelEdit(); await loadData(); renderTable();
    } catch (err) { console.error(err); alert("Error saving: " + err.message); }
  }
  async function deleteActivity(id) { if(!confirm("Are you sure?")) return; try { const { error } = await supabaseClient.from('logistics_all').delete().eq('id', id); if(error) throw error; await loadData(); renderTable(); } catch(err) { alert("Error deleting: " + err.message); } }
  function openLogin() { document.getElementById("loginModal").style.display = "flex"; document.getElementById("adminPassInput").value = ""; document.getElementById("adminPassInput").focus(); }
  function closeLogin() { document.getElementById("loginModal").style.display = "none"; }
  function checkLogin() { if (document.getElementById("adminPassInput").value === "Zain2026") { isAdmin = true; closeLogin(); toggleAdminMode(); } else { alert("Incorrect password"); } }
  document.getElementById("adminPassInput").addEventListener("keypress", function(event) { if (event.key === "Enter") checkLogin(); });
  function handleYearChange() { loadData().then(() => { document.getElementById("adminYearLabel").textContent = document.getElementById("viewYear").value; if (document.getElementById("adminPanel").style.display === "block") renderTable(); }); }

  // --- DATA & RENDER ---
  async function loadData() {
    try {
      const selectedYear = parseInt(document.getElementById("viewYear").value) || 2025;
      const prevYear = selectedYear - 1;
      document.getElementById("titleYear").textContent = selectedYear;

      const { data: curr, error: e1 } = await supabaseClient.from('logistics_all').select('*').eq('Year', selectedYear);
      if (e1) throw e1; currentLogistics = curr || [];
      document.getElementById("reportStart").value = `${selectedYear}-01-01`; document.getElementById("reportEnd").value = `${selectedYear}-12-31`;

      const { data: prev } = await supabaseClient.from('logistics_all').select('*').eq('Year', prevYear);
      comparisonLogistics = prev || [];

      const { data: soc } = await supabaseClient.from('social_media').select('*').range(0,5000);
      rawSocial = soc || [];
      const d1 = await fetchAllRows('registration', '2025');
      const d2 = await fetchAllRows('the_station_database', '2023');
      const d3 = await fetchAllRows('makers_of_baghdad_database', '2025');
      rawRegistration = [...d1, ...d2, ...d3];

      populateYearFilters(); 
      renderKPIsAndCharts(selectedYear);
    } catch (err) { document.getElementById("globalError").textContent = "Error: " + err.message; console.error(err); }
  }

  function renderKPIsAndCharts(selectedYear) {
      const prevYear = selectedYear - 1;
      const tSoc = { reach: 0, engagement: 0, interaction: 0, impression: 0 };
      const tSocPrev = { reach: 0, engagement: 0, interaction: 0, impression: 0 };
      
      rawSocial.forEach(row => { 
        const y = String(row[COLS_SOCIAL.year]).trim();
        if (y == selectedYear) { 
           tSoc.reach += toNumberSmart(row[COLS_SOCIAL.reach]); tSoc.engagement += toNumberSmart(row[COLS_SOCIAL.engagement]); tSoc.interaction += toNumberSmart(row[COLS_SOCIAL.interaction]); tSoc.impression += toNumberSmart(row[COLS_SOCIAL.impression]); 
        } else if (y == prevYear) {
           tSocPrev.reach += toNumberSmart(row[COLS_SOCIAL.reach]); tSocPrev.engagement += toNumberSmart(row[COLS_SOCIAL.engagement]); tSocPrev.interaction += toNumberSmart(row[COLS_SOCIAL.interaction]); tSocPrev.impression += toNumberSmart(row[COLS_SOCIAL.impression]);
        }
      });
      document.getElementById("kpiSocialReach").textContent = tSoc.reach.toLocaleString(); document.getElementById("kpiSocialEngagement").textContent = tSoc.engagement.toLocaleString(); document.getElementById("kpiSocialInteraction").textContent = tSoc.interaction.toLocaleString(); document.getElementById("kpiSocialImpression").textContent = tSoc.impression.toLocaleString();
      const dReach = calculateDelta(tSoc.reach, tSocPrev.reach); document.getElementById("kpiSocialReachDelta").textContent = dReach.t; document.getElementById("kpiSocialReachDelta").className = dReach.c;
      const dEng = calculateDelta(tSoc.engagement, tSocPrev.engagement); document.getElementById("kpiSocialEngagementDelta").textContent = dEng.t; document.getElementById("kpiSocialEngagementDelta").className = dEng.c;
      const dInt = calculateDelta(tSoc.interaction, tSocPrev.interaction); document.getElementById("kpiSocialInteractionDelta").textContent = dInt.t; document.getElementById("kpiSocialInteractionDelta").className = dInt.c;
      const dImp = calculateDelta(tSoc.impression, tSocPrev.impression); document.getElementById("kpiSocialImpressionDelta").textContent = dImp.t; document.getElementById("kpiSocialImpressionDelta").className = dImp.c;

      const mCounts = Array(12).fill(0);
      currentLogistics.forEach(row => { const d = parseCustomDate(row[COLS_LOGISTICS.start_date], selectedYear); if(d && d.getFullYear() === selectedYear) mCounts[d.getMonth()]++; });
      if (activitiesChartInstance) activitiesChartInstance.destroy();
      activitiesChartInstance = new Chart(document.getElementById("activitiesChart"), { type: "bar", data: { labels: ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"], datasets:[{ label:`Activities (${selectedYear})`, data:mCounts, backgroundColor:"#d946ef", borderRadius:4 }] }, options: { maintainAspectRatio: false, plugins: { legend: { display:false } }, scales:{ y:{ grid:{ color:"#333"} }, x:{ grid:{ display:false } } } } });
      applyFilters(); 
      updateSimChart(); // Init SIM
      updateGenderChart(); // Init Gender
  }
  
  function applyFilters() {
    const qFilter = document.getElementById("quarterFilter").value; const isAll = (qFilter === "all");
    const displayMode = isAll ? "grid" : "none"; const blockMode = isAll ? "block" : "none";
    
    document.getElementById("rowSocial").style.display = displayMode; 
    document.getElementById("rowCharts").style.display = displayMode; 
    document.getElementById("rowCharts2").style.display = isAll ? "block" : "none"; 
    
    document.getElementById("cardJobs").style.display = blockMode; 
    document.getElementById("cardBudget").style.gridColumn = isAll ? "span 2" : "span 4";

    const mCurr = computeMetrics(currentLogistics, qFilter); const mPrev = (comparisonLogistics.length > 0) ? computeMetrics(comparisonLogistics, qFilter) : { activities:0, audience:0, budget:0, cities:0 };
    document.getElementById("kpiActivities").textContent = mCurr.activities.toLocaleString(); document.getElementById("kpiAudience").textContent = mCurr.audience.toLocaleString(); document.getElementById("kpiBudget").textContent = mCurr.budget.toLocaleString(); document.getElementById("kpiCities").textContent = mCurr.cities.toLocaleString();
    const dAct = calculateDelta(mCurr.activities, mPrev.activities); document.getElementById("kpiActivitiesDelta").textContent = dAct.t; document.getElementById("kpiActivitiesDelta").className = dAct.c;
    const dAud = calculateDelta(mCurr.audience, mPrev.audience); document.getElementById("kpiAudienceDelta").textContent = dAud.t; document.getElementById("kpiAudienceDelta").className = dAud.c;
    const dBud = calculateDelta(mCurr.budget, mPrev.budget); document.getElementById("kpiBudgetDelta").textContent = dBud.t; document.getElementById("kpiBudgetDelta").className = dBud.c;
    const dCit = calculateDelta(mCurr.cities, mPrev.cities); document.getElementById("kpiCitiesDelta").textContent = dCit.t; document.getElementById("kpiCitiesDelta").className = dCit.c;
    const selectedYear = parseInt(document.getElementById("viewYear").value) || 2025; document.getElementById("audienceDeltaBadgeText").textContent = "vs " + (selectedYear - 1);
  }
  
  function computeMetrics(data, quarterFilter) {
    let activities = 0, totalAudience = 0, totalBudget = 0; const citySet = new Set(); const selectedYear = parseInt(document.getElementById("viewYear").value) || 2025;
    data.forEach(row => {
      const status = String(row[COLS_LOGISTICS.status] || "").toLowerCase(); const name = String(row[COLS_LOGISTICS.name] || "").toLowerCase();
      if (name.length < 2 || name.includes("total")) return; if (status.includes("cancel") || status.includes("postpon")) return;
      if (quarterFilter !== "all") { const dObj = parseCustomDate(row[COLS_LOGISTICS.start_date], selectedYear); if (!dObj || getQuarter(dObj) !== quarterFilter) return; }
      activities++; totalAudience += toNumberSmart(row[COLS_LOGISTICS.audience]); totalBudget += toNumberSmart(row[COLS_LOGISTICS.budget]);
      const city = String(row[COLS_LOGISTICS.city] || "").trim().toLowerCase(); const isOnline = city.includes("online") || city.includes("virtual") || city.includes("zoom"); if (city && city !== "city" && city !== "null" && !isOnline) citySet.add(city);
    }); return { activities, audience: totalAudience, budget: totalBudget, cities: citySet.size };
  }

  // --- SPLIT CHARTS: SIM ---
  function updateSimChart() {
    const yearFilter = document.getElementById("simYearFilter").value; 
    let zain=0, asiacell=0, korek=0;
    
    rawRegistration.forEach(row => { 
        if (yearFilter !== "all" && row._derivedYear !== yearFilter) return; 
        const phoneVal = getSmartValue(row, ["Phone", "Mobile", "Number", "phone_number"]); 
        let p = String(phoneVal).replace(/\D/g,""); 
        if(p.startsWith("00964")) p=p.slice(5); else if(p.startsWith("964")) p=p.slice(3); 
        if(p.length===11 && p.startsWith("0")) p=p.slice(1); 
        if(p.length===10 && p.startsWith("7")) { 
            if(p.startsWith("78")||p.startsWith("79")) zain++; 
            else if(p.startsWith("77")) asiacell++; 
            else if(p.startsWith("75")) korek++; 
        } 
    });
    
    const totalS = zain + asiacell + korek;
    const zPct = totalS > 0 ? ((zain/totalS)*100).toFixed(1) : 0;
    document.getElementById("kpiSimShare").textContent = zPct + "%";
    
    const colorsS = { Zain: "#d946ef", Asiacell: "#ef4444", Korek: "#3b82f6" };
    const legendDataS = [{ label: "Zain", val: zain, col: colorsS.Zain }, { label: "Asiacell", val: asiacell, col: colorsS.Asiacell }, { label: "Korek", val: korek, col: colorsS.Korek }];
    let legendHTMLS = "";
    legendDataS.forEach(d => { const pct = totalS > 0 ? ((d.val/totalS)*100).toFixed(1) + "%" : "0%"; legendHTMLS += `<div class="legend-item"><div class="legend-left"><span class="legend-dot" style="background:${d.col}"></span> ${d.label}</div><div class="legend-right"><span class="legend-pct">${pct}</span><span class="legend-count">${d.val.toLocaleString()}</span></div></div>`; });
    document.getElementById("simLegend").innerHTML = legendHTMLS;

    if (simChartInstance) simChartInstance.destroy(); 
    simChartInstance = new Chart(document.getElementById("simChart"), { type: "doughnut", data: { labels: ["Zain","Asiacell","Korek"], datasets:[{ data:[zain, asiacell, korek], backgroundColor:[colorsS.Zain, colorsS.Asiacell, colorsS.Korek], borderWidth:0, cutout: '70%' }] }, options: { maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { enabled: true } } } });
  }

  // --- SPLIT CHARTS: GENDER ---
  function updateGenderChart() {
    const yearFilter = document.getElementById("genderYearFilter").value;
    let male=0, female=0;

    rawRegistration.forEach(row => { 
        if (yearFilter !== "all" && row._derivedYear !== yearFilter) return;
        const genderVal = getSmartValue(row, ["Gender", "Sex"]); 
        const g = String(genderVal).toLowerCase().trim(); 
        if (g.includes("female") || g === "f" || g.includes("انثى") || g.includes("woman")) female++; 
        else if (g.includes("male") || g === "m" || g.includes("ذكر") || g.includes("man")) male++; 
    });

    const totalG = male + female;
    const fPct = totalG > 0 ? ((female/totalG)*100).toFixed(1) : 0;
    const mPct = totalG > 0 ? ((male/totalG)*100).toFixed(1) : 0;
    
    // Dual Highlight
    document.getElementById("kpiFemaleShare").textContent = fPct + "%";
    document.getElementById("kpiMaleShare").textContent = mPct + "%";

    const colorsG = { Male: "#38bdf8", Female: "#f472b6" };
    const legendDataG = [{ label: "Male", val: male, col: colorsG.Male }, { label: "Female", val: female, col: colorsG.Female }];
    let legendHTMLG = "";
    legendDataG.forEach(d => { const pct = totalG > 0 ? ((d.val/totalG)*100).toFixed(1) + "%" : "0%"; legendHTMLG += `<div class="legend-item"><div class="legend-left"><span class="legend-dot" style="background:${d.col}"></span> ${d.label}</div><div class="legend-right"><span class="legend-pct">${pct}</span><span class="legend-count">${d.val.toLocaleString()}</span></div></div>`; });
    document.getElementById("genderLegend").innerHTML = legendHTMLG;

    if (genderChartInstance) genderChartInstance.destroy(); 
    genderChartInstance = new Chart(document.getElementById("genderChart"), { type: "doughnut", data: { labels: ["Male","Female"], datasets:[{ data:[male, female], backgroundColor:[colorsG.Male, colorsG.Female], borderWidth:0, cutout: '70%' }] }, options: { maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { enabled: true } } } });
  }

  function populateYearFilters() { 
      const uniqueYears = new Set(); 
      rawRegistration.forEach(r => { if(r._derivedYear) uniqueYears.add(r._derivedYear); }); 
      
      // Populate SIM Filter
      const simSelect = document.getElementById("simYearFilter"); 
      simSelect.innerHTML = '<option value="all" selected>All Years</option>'; 
      
      // Populate Gender Filter
      const genSelect = document.getElementById("genderYearFilter");
      genSelect.innerHTML = '<option value="all" selected>All Years</option>';

      Array.from(uniqueYears).sort().forEach(y => { 
          const opt1 = document.createElement("option"); opt1.value = y; opt1.textContent = y; simSelect.appendChild(opt1);
          const opt2 = document.createElement("option"); opt2.value = y; opt2.textContent = y; genSelect.appendChild(opt2);
      }); 
  }

  async function fetchAllRows(table, defaultYear) { let allData = []; let page = 0; const pageSize = 5000; while (true) { try { const { data, error } = await supabaseClient.from(table).select('*').range(page * pageSize, (page + 1) * pageSize - 1); if (error) throw error; if (!data || data.length === 0) break; const tagged = data.map(row => { let y = getSmartValue(row, ["Year", "year"]); if (!y) y = defaultYear; return { ...row, _derivedYear: String(y) }; }); allData = allData.concat(tagged); if (data.length < pageSize) break; page++; } catch (err) { console.warn(`Skipping table '${table}':`, err.message); break; } } return allData; }
  function getSmartValue(row, possibleNames) { if (!row) return ""; const keys = Object.keys(row); for (let name of possibleNames) if (row[name] !== undefined) return row[name]; for (let key of keys) { const lowerKey = key.toLowerCase(); for (let name of possibleNames) if (lowerKey === name.toLowerCase()) return row[key]; } return ""; }
  function toNumberSmart(v) { if (!v) return 0; let s = String(v).trim().replace(/,/g, ""); const m = s.match(/^(-?\d+(\.\d+)?)([kKmMbB])$/); if (m) { const num = Number(m[1]); const mult = m[3].toLowerCase() === "k" ? 1000 : m[3].toLowerCase() === "m" ? 1000000 : 1; return num * mult; } return Number(s) || 0; }
  function parseCustomDate(val, targetYear) { if (!val) return null; let text = String(val).trim(); if (/^\d{1,2}-[a-zA-Z]{3}$/.test(text)) text = `${text}-${targetYear}`; let d = new Date(text); if (isNaN(d.getTime()) || d.getFullYear() === 2001) d = new Date(`${text} ${targetYear}`); if (isNaN(d.getTime())) return null; return d; }
  function getQuarter(dateObj) { if (!dateObj) return null; const m = dateObj.getMonth(); if (m < 3) return "q1"; if (m < 6) return "q2"; if (m < 9) return "q3"; return "q4"; }

  loadData();
</script>
</body>
</html>
