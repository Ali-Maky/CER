<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CER Impact Dashboard (Live)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg-main: #040011;
      --bg-card: #0c071d;
      --bg-card-soft: #120a2a;
      --border-subtle: #231a3c;
      --accent: #d946ef;
      --accent-soft: #9333ea;
      --text-main: #f9fafb;
      --text-muted: #9ca3af;
      --text-soft: #6b7280;
      --success: #4ade80;
      --danger: #f97373;
      --chip-bg: rgba(255,255,255,0.06);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 0;
      background: radial-gradient(circle at top left, #321b5d 0, #040011 45%, #02000a 100%);
      color: var(--text-main);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Inter", Arial, sans-serif;
    }
    .page {
      max-width: 1280px;
      margin: 0 auto;
      padding: 24px 16px 40px;
    }

    /* TOP NAV */
    .top-nav {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 18px;
    }
    .brand-area {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    .brand-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: var(--chip-bg);
      border: 1px solid rgba(255,255,255,0.08);
      font-size: 11px;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: var(--text-soft);
    }
    .brand-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 0 3px rgba(217,70,239,0.4);
    }
    .nav-tabs {
      display: inline-flex;
      background: rgba(15,23,42,0.7);
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.25);
      overflow: hidden;
    }
    .nav-tab {
      padding: 6px 16px;
      font-size: 12px;
      cursor: default;
      color: var(--text-soft);
      border-right: 1px solid rgba(148,163,184,0.25);
    }
    .nav-tab:last-child { border-right: none; }
    .nav-tab.active {
      background: var(--accent-soft);
      color: #fff;
    }

    .top-controls {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }
    .pill {
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.4);
      font-size: 12px;
      color: #e5e7eb;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(15,23,42,0.8);
    }
    select {
      background: transparent;
      border: none;
      color: #f9fafb;
      font-size: 12px;
      outline: none;
      padding: 1px 0;
    }
    .update-text {
      font-size: 11px;
      color: var(--text-soft);
    }
    .update-bold {
      color: var(--text-muted);
      font-weight: 500;
    }

    /* TITLE */
    h1 {
      font-size: 26px;
      margin: 0 0 4px;
    }
    .subtitle {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 20px;
    }

    /* GRID + CARDS */
    .grid {
      display: grid;
      gap: 16px;
    }
    .grid-4 { grid-template-columns: repeat(4, minmax(0, 1fr)); }
    .grid-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    @media (max-width: 1100px) {
      .grid-4 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    @media (max-width: 700px) {
      .grid-4, .grid-2 { grid-template-columns: minmax(0, 1fr); }
    }

    .card {
      background: linear-gradient(145deg, var(--bg-card) 0, var(--bg-card-soft) 100%);
      border-radius: 20px;
      padding: 16px 18px;
      border: 1px solid var(--border-subtle);
      box-shadow: 0 18px 40px rgba(0,0,0,0.45);
    }
    .card-header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 10px;
    }
    .card-label {
      font-size: 11px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: var(--text-soft);
      font-weight: 500;
    }
    .badge-soft {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(14,148,136,0.1);
      color: #6ee7b7;
      font-size: 10px;
      border: 1px solid rgba(16,185,129,0.4);
      white-space: nowrap;
    }
    .badge-soft-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #22c55e;
    }
    .badge-soft.red {
      background: rgba(248,113,113,0.08);
      color: #fecaca;
      border-color: rgba(248,113,113,0.4);
    }
    .badge-soft.red .badge-soft-dot { background: #f87171; }

    .kpi-value {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 4px;
    }
    .kpi-delta {
      font-size: 11px;
      margin-bottom: 6px;
    }
    .delta-up { color: var(--success); }
    .delta-down { color: var(--danger); }
    .delta-neutral { color: var(--text-muted); }

    .kpi-note {
      font-size: 11px;
      color: var(--text-soft);
      line-height: 1.4;
    }

    .sim-big-line {
      font-size: 24px;
      font-weight: 700;
      margin-top: 4px;
    }

    /* CHART AREA */
    .chart-wrapper {
      position: relative;
      width: 100%;
      height: 270px;
    }
    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 10px;
      gap: 8px;
    }
    .chart-title {
      font-size: 13px;
      font-weight: 500;
    }
    .chart-subtitle {
      font-size: 11px;
      color: var(--text-soft);
    }
    .chart-pill {
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.4);
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--text-soft);
    }

    /* ERROR */
    .error-text {
      font-size: 12px;
      color: var(--danger);
      margin-bottom: 12px;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="top-nav">
      <div class="brand-area">
        <div class="brand-chip">
          <span class="brand-dot"></span>
          <span>CER · Zain Iraq</span>
        </div>
        <div class="nav-tabs">
          <div class="nav-tab active">Management View</div>
          <div class="nav-tab">Activities &amp; Reach</div>
        </div>
      </div>
      <div class="top-controls">
        <div class="pill">
          Year:
          <select id="yearSelect">
            <option value="2025" selected>2025</option>
          </select>
        </div>
        <div class="update-text">
          Last update: <span class="update-bold">from CER Master Sheet</span>
        </div>
      </div>
    </div>

    <h1>CER Impact Dashboard</h1>
    <div class="subtitle">
      Live view of 2025 activities, audience reach, national coverage, SIM distribution, budget, and social media impact.
    </div>

    <div id="globalError" class="error-text"></div>

    <div class="grid grid-4" style="margin-bottom: 20px;">
      <div class="card">
        <div class="card-header-row">
          <div class="card-label">Total Activities (2025)</div>
          <div class="badge-soft">
            <span class="badge-soft-dot"></span>
            <span>On-track vs. plan</span>
          </div>
        </div>
        <div id="kpiActivities" class="kpi-value">Loading...</div>
        <div id="kpiActivitiesDelta" class="kpi-delta delta-neutral"></div>
        <div class="kpi-note">
          All activities across hubs, universities, and partners logged in “Logistics 2025”.
        </div>
      </div>

      <div class="card">
        <div class="card-header-row">
          <div class="card-label">Total Audience / Participants</div>
          <div id="audienceDeltaBadge" class="badge-soft">
            <span class="badge-soft-dot"></span>
            <span id="audienceDeltaBadgeText">vs 2024</span>
          </div>
        </div>
        <div id="kpiAudience" class="kpi-value">Loading...</div>
        <div id="kpiAudienceDelta" class="kpi-delta delta-neutral"></div>
        <div class="kpi-note">
          Sum of “Total Audience” field per activity – workshops, hackathons, trainings, and events.
        </div>
      </div>

      <div class="card">
        <div class="card-header-row">
          <div class="card-label">Cities Covered</div>
          <div class="badge-soft">
            <span class="badge-soft-dot"></span>
            <span>National footprint</span>
          </div>
        </div>
        <div id="kpiCities" class="kpi-value">Loading...</div>
        <div id="kpiCitiesDelta" class="kpi-delta delta-neutral"></div>
        <div class="kpi-note">
          Baghdad, Mosul, Basra, Najaf and other locations reached through CER initiatives.
        </div>
      </div>

      <div class="card">
        <div class="card-header-row">
          <div class="card-label">SIM Card Distribution (Zain vs Others)</div>
          <div class="badge-soft red">
            <span class="badge-soft-dot"></span>
            <span>Based on participant SIMs</span>
          </div>
        </div>
        <div class="sim-big-line">
          <span id="kpiSimShare">Loading...</span>
          <span style="font-size: 16px; margin-left: 4px;">Zain</span>
        </div>
        <div class="kpi-note" style="margin-top: 6px;">
          Derived from phone prefixes in Registration, The Station DB, and Makers of Baghdad DB (78 vs 77/75).
        </div>
      </div>
    </div>

    <div class="grid grid-4" style="margin-bottom: 20px;">
      
      <div class="card" style="grid-column: span 2;">
        <div class="card-header-row">
          <div class="card-label">Total Budget (2025)</div>
        </div>
        <div id="kpiBudget" class="kpi-value">Loading...</div>
        <div id="kpiBudgetDelta" class="kpi-delta delta-neutral"></div>
        <div class="kpi-note">
          Total budget spent in 2025.
        </div>
      </div>

      <div class="card">
        <div class="card-header-row">
          <div class="card-label">Jobs Created (2025)</div>
          <div class="badge-soft">
             <span class="badge-soft-dot"></span>
             <span>Economic Impact</span>
          </div>
        </div>
        <div class="kpi-value">220</div>
        <div class="kpi-note">
          Direct and indirect employment opportunities generated through 2025 programs.
        </div>
      </div>

    </div>

    <div class="grid grid-4" style="margin-bottom: 20px;">
      <div class="card">
        <div class="card-header-row">
          <div class="card-label">Social Reach (2025)</div>
        </div>
        <div id="kpiSocialReach" class="kpi-value">Loading...</div>
        <div id="kpiSocialReachDelta" class="kpi-delta delta-neutral"></div>
        <div class="kpi-note">
          Sum of “Reach” in the “Social Media” sheet (all 2025-related posts).
        </div>
      </div>

      <div class="card">
        <div class="card-header-row">
          <div class="card-label">Social Engagement (2025)</div>
        </div>
        <div id="kpiSocialEngagement" class="kpi-value">Loading...</div>
        <div id="kpiSocialEngagementDelta" class="kpi-delta delta-neutral"></div>
        <div class="kpi-note">
          Sum of “Engagment/Engagement” in the “Social Media” sheet.
        </div>
      </div>

      <div class="card">
        <div class="card-header-row">
          <div class="card-label">Social Interaction (2025)</div>
        </div>
        <div id="kpiSocialInteraction" class="kpi-value">Loading...</div>
        <div id="kpiSocialInteractionDelta" class="kpi-delta delta-neutral"></div>
        <div class="kpi-note">
          Sum of “Interaction” in the “Social Media” sheet.
        </div>
      </div>

      <div class="card">
        <div class="card-header-row">
          <div class="card-label">Social Impression (2025)</div>
        </div>
        <div id="kpiSocialImpression" class="kpi-value">Loading...</div>
        <div id="kpiSocialImpressionDelta" class="kpi-delta delta-neutral"></div>
        <div class="kpi-note">
          Sum of “Impression” in the “Social Media” sheet.
        </div>
      </div>
    </div>

    <div class="grid grid-2">
      <div class="card">
        <div class="chart-header">
          <div>
            <div class="chart-title">Activities per Month (2025)</div>
            <div class="chart-subtitle">
              Based on “Start Date” in Logistics 2025.
            </div>
          </div>
          <div class="chart-pill">Trend · 2025 YTD</div>
        </div>
        <div class="chart-wrapper">
          <canvas id="activitiesChart"></canvas>
        </div>
      </div>

      <div class="card">
        <div class="chart-header">
          <div>
            <div class="chart-title">SIM Distribution – Zain vs Asiacell + Korek</div>
            <div class="chart-subtitle">
              Share of SIMs used by registered participants.
            </div>
          </div>
        </div>
        <div class="chart-wrapper">
          <canvas id="simChart"></canvas>
        </div>
      </div>
    </div>

    <div class="grid" style="margin-top: 18px;">
      <div class="card">
        <div class="chart-header">
          <div>
            <div class="chart-title">Gender Distribution – Male vs Female</div>
            <div class="chart-subtitle">
              Based on gender fields in Registration, The Station DB, and Makers of Baghdad DB.
            </div>
          </div>
        </div>
        <div class="chart-wrapper">
          <canvas id="genderChart"></canvas>
        </div>
      </div>
    </div>

  </div>

<script>
  // ⚠️ PASTE YOUR GOOGLE APPS SCRIPT URL HERE
  const API_URL = "https://script.google.com/macros/s/AKfycbzp0q6-Q5_ufHJqWI-SuNGddEBI-OtOtkKdhGflNMnP9rV9pAK1BWDK30qIQ5jQvtwIgA/exec";

  // Static comparison text
  const STATIC_COMPARE_2024 = {
    activities: "▲ 11.4% vs 2024",
    audience:   "▼ 48.8% vs 2024",
    budget:     "▲ 45.5% vs 2024",
    cities:     "▲ 100% vs 2024"
  };

  const yearSelect        = document.getElementById("yearSelect");
  const elActivities      = document.getElementById("kpiActivities");
  const elAudience        = document.getElementById("kpiAudience");
  const elCities          = document.getElementById("kpiCities");
  const elSimShare        = document.getElementById("kpiSimShare");
  const elBudget          = document.getElementById("kpiBudget");
  
  const elActivitiesDelta = document.getElementById("kpiActivitiesDelta");
  const elAudienceDelta   = document.getElementById("kpiAudienceDelta");
  const elCitiesDelta     = document.getElementById("kpiCitiesDelta");
  const elBudgetDelta     = document.getElementById("kpiBudgetDelta");
  const elAudienceDeltaBadge = document.getElementById("audienceDeltaBadge");
  const elAudienceDeltaBadgeText = document.getElementById("audienceDeltaBadgeText");
  const elGlobalErr       = document.getElementById("globalError");

  // Social KPI elements
  const elSocialReach        = document.getElementById("kpiSocialReach");
  const elSocialReachDelta   = document.getElementById("kpiSocialReachDelta");
  const elSocialEngagement   = document.getElementById("kpiSocialEngagement");
  const elSocialEngagementDelta = document.getElementById("kpiSocialEngagementDelta");
  const elSocialInteraction  = document.getElementById("kpiSocialInteraction");
  const elSocialInteractionDelta = document.getElementById("kpiSocialInteractionDelta");
  const elSocialImpression   = document.getElementById("kpiSocialImpression");
  const elSocialImpressionDelta = document.getElementById("kpiSocialImpressionDelta");

  let globalData = null;
  let activitiesChart = null;
  let simChart = null;
  let genderChart = null;

  function showError(msg) {
    console.error(msg);
    elGlobalErr.textContent = "Error: " + msg;
  }

  // ---------- UTILITIES ----------
  function toNumberSmart(v) {
    if (v === null || v === undefined || v === "") return 0;
    let s = String(v).trim().replace(/,/g, ""); 
    const m = s.match(/^(-?\d+(\.\d+)?)([kKmMbB])$/);
    if (m) {
      const num = Number(m[1]);
      const suf = m[3].toLowerCase();
      const mult = suf === "k" ? 1000 : suf === "m" ? 1000000 : 1;
      return isNaN(num) ? 0 : num * mult;
    }
    const n = Number(s);
    return isNaN(n) ? 0 : n;
  }

  function parseCustomDate(text, fallbackYear) {
    if (!text) return null;
    if (text instanceof Date && !isNaN(text.getTime())) return text;
    text = String(text).trim();
    const m = text.match(/^([A-Za-z]+)\s+(\d{1,2})$/);
    if (m) {
      const monthName = m[1].toLowerCase();
      const day = Number(m[2]);
      const monthMap = {
        january: 0, february: 1, march: 2, april: 3,
        may: 4, june: 5, july: 6, august: 7,
        september: 8, october: 9, november: 10, december: 11
      };
      if (monthMap.hasOwnProperty(monthName)) {
        const year = fallbackYear || new Date().getFullYear();
        return new Date(year, monthMap[monthName], day);
      }
    }
    const d = new Date(text);
    if (!isNaN(d.getTime())) return d;
    return null;
  }

  function parseMonthFromCell(value, fallbackYear) {
    const d = parseCustomDate(value, fallbackYear);
    return d ? d.getMonth() : null;
  }

  // ---------- 1. RELAXED ACTIVITY COUNTER ----------
  function isCountedActivityFixed(row) {
    if (!row || row.length < 2) return false;
    
    // Col B (Index 1) = Activity Name
    // Col O (Index 14) = Status
    const activityName = String(row[1] || "").trim();
    const status = String(row[14] || "").trim().toLowerCase();

    // 1. MUST have a name (longer than 1 char)
    if (activityName.length < 2) return false;

    // 2. Filter out Headers and Summaries
    const lowerName = activityName.toLowerCase();
    if (lowerName === "activity name" || lowerName.includes("total") || lowerName.includes("grand total")) return false;

    // 3. Filter out Month Header Rows
    const months = ["january","february","march","april","may","june", "july","august","september","october","november","december"];
    if (months.includes(lowerName)) return false;

    // 4. Status Check: Exclude Cancelled/Postponed
    if (status.includes("cancel") || status.includes("postpon")) return false;
    
    return true; 
  }

  function computeYearMetrics2025(sheetData) {
    if (!sheetData || sheetData.length < 2) return { activities: 0, audience: 0, budget: 0, cities: 0 };
    
    // Indices: City=3 (D), Audience=11 (L), Budget=12 (M)
    const cityCol = 3, audienceCol = 11, budgetCol = 12;
    let activities = 0, totalAudience = 0, totalBudget = 0;
    const citySet = new Set();

    for (let i = 1; i < sheetData.length; i++) {
      const row = sheetData[i];
      if (!isCountedActivityFixed(row)) continue;

      activities++;
      const aud = Number(String(row[audienceCol] ?? "").replace(/,/g, "").trim());
      if (!isNaN(aud)) totalAudience += aud;
      
      const bStr = String(row[budgetCol] ?? "").replace(/,/g, "").trim();
      if (bStr !== "") {
        const bNum = Number(bStr);
        if (!isNaN(bNum)) totalBudget += bNum;
      }
      
      const city = String(row[cityCol] ?? "").trim();
      if (city && city.toLowerCase() !== "city") citySet.add(city.toLowerCase());
    }
    return { activities, audience: totalAudience, budget: totalBudget, cities: citySet.size };
  }

  // ---------- 2. SOCIAL MEDIA FIX (YEAR FILTER) ----------
  function computeSocialTotals(sheetData) {
    const t25 = { reach: 0, engagement: 0, interaction: 0, impression: 0 };
    const t24 = { reach: 0, engagement: 0, interaction: 0, impression: 0 };

    if (!sheetData || sheetData.length < 2) return { t25, t24 };

    // Find Headers
    let headerRowIndex = -1;
    let headers = [];
    for (let r = 0; r < Math.min(sheetData.length, 5); r++) {
      const rowStr = sheetData[r].join(" ").toLowerCase();
      if (rowStr.includes("reach") || rowStr.includes("date") || rowStr.includes("الوصول")) {
        headerRowIndex = r;
        headers = sheetData[r].map(h => String(h).toLowerCase().trim());
        break;
      }
    }
    if (headerRowIndex === -1) return { t25, t24 };

    // Find Columns
    const getIndex = (keys) => headers.findIndex(h => keys.some(k => h.includes(k)));
    const idxDate = getIndex(["date", "year", "time", "التاريخ"]);
    const idxReach = getIndex(["reach", "الوصول"]);
    const idxEngagement = getIndex(["engag", "التفاعل"]);
    const idxInteraction = getIndex(["interaction"]);
    const idxImpression = getIndex(["impress", "views", "الظهور"]);

    for (let i = headerRowIndex + 1; i < sheetData.length; i++) {
      const row = sheetData[i];
      if (!row) continue;

      const dateStr = String(row[idxDate] || "");
      const is2025 = dateStr.indexOf("2025") > -1;
      const is2024 = dateStr.indexOf("2024") > -1;

      const addTo = (obj) => {
        if (idxReach > -1) obj.reach += toNumberSmart(row[idxReach]);
        if (idxEngagement > -1) obj.engagement += toNumberSmart(row[idxEngagement]);
        if (idxInteraction > -1) obj.interaction += toNumberSmart(row[idxInteraction]);
        if (idxImpression > -1) obj.impression += toNumberSmart(row[idxImpression]);
      };

      if (is2025) addTo(t25);
      else if (is2024) addTo(t24);
    }
    return { t25, t24 };
  }

  // ---------- SIM & GENDER LOGIC ----------
  function extractPhonesFromSheet(sheetData, allowedCols) {
    const phones = [];
    for (let i = 1; i < sheetData.length; i++) {
      const row = sheetData[i];
      if (!row) continue;
      const colsToCheck = (allowedCols && allowedCols.length) ? allowedCols : row.map((_, idx) => idx);
      for (const c of colsToCheck) {
        const cell = row[c];
        if (!cell) continue;
        let digits = String(cell).replace(/\D/g, "");
        if (digits.length >= 8) phones.push(digits);
      }
    }
    return phones;
  }

  function normalizeIraqiMobile(rawDigits) {
    let p = rawDigits;
    if (p.startsWith("00964")) p = p.slice(5);
    else if (p.startsWith("964")) p = p.slice(3);
    if (p.length === 11 && p.startsWith("0")) p = p.slice(1);
    if (p.length > 10) p = p.slice(-10);
    if (!p.startsWith("7") || p.length !== 10) return null;
    return p;
  }

  function computeSimShareFromSheets(allSheetsConfig) {
    let total = 0, zain = 0, asiacell = 0, korek = 0;
    const allPhonesDigits = [];
    for (const cfg of allSheetsConfig) {
      allPhonesDigits.push(...extractPhonesFromSheet(cfg.data, cfg.cols));
    }
    for (const raw of allPhonesDigits) {
      const normalized = normalizeIraqiMobile(raw);
      if (!normalized) continue;
      const prefix2 = normalized.slice(0, 2);
      if (["75", "77", "78", "79"].includes(prefix2)) { 
        total++;
        if (prefix2 === "78" || prefix2 === "79") zain++; 
        else if (prefix2 === "77") asiacell++;
        else if (prefix2 === "75") korek++;
      }
    }
    return { total, zain, asiacell, korek };
  }

  function computeGenderShareFromSheets(allSheetsConfig) {
    let male = 0, female = 0;
    const maleValues = new Set(["m", "male", "ذكر", "رجال", "boy"]);
    const femaleValues = new Set(["f", "female", "انثى", "أنثى", "نساء", "girl"]);

    for (const cfg of allSheetsConfig) {
      const data = cfg.data || [];
      for (let i = 1; i < data.length; i++) {
        const row = data[i];
        if (!row) continue;
        for (let c = 0; c < row.length; c++) {
          const val = String(row[c] || "").toLowerCase().trim();
          if (maleValues.has(val)) { male++; break; }
          if (femaleValues.has(val)) { female++; break; }
        }
      }
    }
    return { total: male+female, male, female };
  }

  // ---------- MAIN UPDATE LOOP ----------
  function updateDashboard() {
    if (!globalData) return;

    const logistics2025 = globalData.logistics2025; 
    const station       = globalData.station || [];
    const makers        = globalData.makers || [];
    const registration  = globalData.registration || [];
    const social        = globalData.social || [];

    // Metrics
    const m25 = computeYearMetrics2025(logistics2025);
    elActivities.textContent = m25.activities.toLocaleString();
    elAudience.textContent   = m25.audience.toLocaleString();
    elBudget.textContent     = m25.budget.toLocaleString();
    elCities.textContent     = m25.cities.toLocaleString();

    // Deltas
    const items = [
      { el: elActivitiesDelta, text: STATIC_COMPARE_2024.activities },
      { el: elAudienceDelta,   text: STATIC_COMPARE_2024.audience },
      { el: elBudgetDelta,     text: STATIC_COMPARE_2024.budget },
      { el: elCitiesDelta,     text: STATIC_COMPARE_2024.cities }
    ];
    items.forEach(({el, text}) => {
      el.textContent = text;
      el.className = "kpi-delta " + (text.includes("▲") ? "delta-up" : text.includes("▼") ? "delta-down" : "delta-neutral");
    });
    elAudienceDeltaBadgeText.textContent = STATIC_COMPARE_2024.audience;
    elAudienceDeltaBadge.className = "badge-soft " + (STATIC_COMPARE_2024.audience.includes("▼") ? "red" : "");

    // SIM Share
    const simStats = computeSimShareFromSheets([
       { data: logistics2025, cols: [8] }, 
       { data: registration, cols: null },
       { data: station,      cols: null },
       { data: makers,       cols: null }
    ]);
    const totalSim = simStats.total || 1;
    const zainPct = ((simStats.zain / totalSim) * 100).toFixed(1);
    elSimShare.textContent = zainPct + "%";

    // Charts: Activities (STRICT 2025)
    const monthCounts = Array(12).fill(0);
    const startDateCol = 4; 
    for (let i = 1; i < logistics2025.length; i++) {
       const row = logistics2025[i];
       if (!isCountedActivityFixed(row)) continue;
       const cellValue = row[startDateCol];
       if (Object.prototype.toString.call(cellValue) === '[object Date]') {
         if (cellValue.getFullYear() !== 2025) continue;
       } else {
         if (String(cellValue || "").includes("2024")) continue;
       }
       let mi = parseMonthFromCell(cellValue, 2025);
       if (mi !== null && mi >= 0 && mi < 12) monthCounts[mi]++;
    }

    if (activitiesChart) activitiesChart.destroy();
    activitiesChart = new Chart(document.getElementById("activitiesChart").getContext("2d"), {
      type: "bar",
      data: {
        labels: ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],
        datasets: [{ label: "Activities (2025)", data: monthCounts, backgroundColor: "#d946ef", borderRadius: 6 }]
      },
      options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: "#e5e7eb" } } }, scales: { y: { beginAtZero: true, ticks: { color: "#e5e7eb" }, grid: { color: "#27272f" } }, x: { ticks: { color: "#e5e7eb" }, grid: { display: false } } } }
    });

    // Charts: SIM
    if (simChart) simChart.destroy();
    simChart = new Chart(document.getElementById("simChart").getContext("2d"), {
      type: "doughnut",
      data: {
        labels: ["Zain", "Asiacell", "Korek"],
        datasets: [{ 
          data: [simStats.zain, simStats.asiacell, simStats.korek], 
          // Colors: Zain (Purple), Asiacell (Red), Korek (Blue)
          backgroundColor: ["#d946ef", "#ef4444", "#3b82f6"], 
          borderWidth: 0 
        }]
      },
      options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: "#e5e7eb" } } } }
    });

    // Charts: Gender
    const genderStats = computeGenderShareFromSheets([
      { data: registration, cols: null }, { data: station, cols: null }, { data: makers, cols: null }
    ]);
    if (genderChart) genderChart.destroy();
    genderChart = new Chart(document.getElementById("genderChart").getContext("2d"), {
      type: "doughnut",
      data: {
        labels: ["Male", "Female"],
        datasets: [{ data: [genderStats.male, genderStats.female], backgroundColor: ["#38bdf8", "#f472b6"], borderWidth: 0 }]
      },
      options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: "#e5e7eb" } } } }
    });

    // Social Metrics
    const { t25, t24 } = computeSocialTotals(social);
    const getDelta = (curr, prev) => {
      if (!prev) return "—";
      const diff = ((curr - prev) / prev) * 100;
      const arrow = diff > 0 ? "▲" : diff < 0 ? "▼" : "";
      return `${arrow} ${Math.abs(diff).toFixed(1)}% vs 2024`;
    };

    elSocialReach.textContent = t25.reach.toLocaleString();
    elSocialReachDelta.textContent = getDelta(t25.reach, t24.reach);
    elSocialReachDelta.className = "kpi-delta " + (t25.reach >= t24.reach ? "delta-up" : "delta-down");

    elSocialEngagement.textContent = t25.engagement.toLocaleString();
    elSocialEngagementDelta.textContent = getDelta(t25.engagement, t24.engagement);
    elSocialEngagementDelta.className = "kpi-delta " + (t25.engagement >= t24.engagement ? "delta-up" : "delta-down");

    elSocialInteraction.textContent = t25.interaction.toLocaleString();
    elSocialInteractionDelta.textContent = getDelta(t25.interaction, t24.interaction);
    elSocialInteractionDelta.className = "kpi-delta " + (t25.interaction >= t24.interaction ? "delta-up" : "delta-down");

    elSocialImpression.textContent = t25.impression.toLocaleString();
    elSocialImpressionDelta.textContent = getDelta(t25.impression, t24.impression);
    elSocialImpressionDelta.className = "kpi-delta " + (t25.impression >= t24.impression ? "delta-up" : "delta-down");
  }

  async function loadData() {
    try {
      const res = await fetch(API_URL);
      if (!res.ok) throw new Error("HTTP " + res.status);
      
      const rawText = await res.text();
      let json;
      try { json = JSON.parse(rawText); } 
      catch (e) { throw new Error("Invalid JSON from Server"); }

      if (!json.logistics2025 || !json.registration) {
         showError("JSON missing keys. Got: " + Object.keys(json).join(", "));
         return;
      }

      globalData = json;
      updateDashboard();
      yearSelect.addEventListener("change", updateDashboard);

    } catch (err) {
      showError("Network or script error: " + err.message);
    }
  }

  loadData();
</script>
</body>
</html>

