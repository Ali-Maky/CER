<script>
  // ⚠️ PASTE KEYS
  const supabaseUrl = 'https://xeohzbdgjgusavfonfkf.supabase.co'; 
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhlb2h6YmRnamd1c2F2Zm9uZmtmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5NjU5NzAsImV4cCI6MjA4MTU0MTk3MH0.5gO_0YgVdk9OFfrJuUrewhierc2wE7lVUst9vYd_DH4';  
  const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

  const COLS_LOGISTICS = { name: "Activity Name", start_date: "Start Date", city: "City", audience: "Total Audience", budget: "Total Budget", status: "Status", year: "Year", description: "Description" };
  const COLS_SOCIAL = { year: "Year", reach: "Reach", engagement: "Engagement", interaction: "Interaction", impression: "Impression" };

  let isAdmin = false; 
  let currentLogistics = []; 
  let comparisonLogistics = [];
  let rawSocial = [];
  let rawRegistration = [];
  let simChartInstance = null;
  let genderChartInstance = null;
  let activitiesChartInstance = null;

  // --- HELPERS ---
  function calculateDelta(curr, prev) {
      const selectedYear = parseInt(document.getElementById("viewYear").value) || 2025;
      const prevYear = selectedYear - 1;
      if (!prev || prev === 0) return { t: "—", c: "kpi-delta delta-neutral" };
      const d = ((curr - prev) / prev) * 100;
      const a = d > 0 ? "▲" : d < 0 ? "▼" : "";
      const cl = d > 0 ? "delta-up" : d < 0 ? "delta-down" : "delta-neutral";
      return { t: `${a} ${Math.abs(d).toFixed(1)}% vs ${prevYear}`, c: `kpi-delta ${cl}` };
  }

  // --- REPORT GENERATOR ---
  function downloadReport() {
      const startStr = document.getElementById("reportStart").value; const endStr = document.getElementById("reportEnd").value;
      if (!startStr || !endStr) { alert("Please select both Start and End dates."); return; }
      const start = new Date(startStr); const end = new Date(endStr); end.setHours(23,59,59); 
      const filtered = currentLogistics.filter(row => { const d = new Date(row[COLS_LOGISTICS.start_date]); return d >= start && d <= end; });
      if (filtered.length === 0) { alert("No activities found in this date range."); return; }
      let csv = "Date,Activity Name,City,Audience,Budget,Status,Description\n";
      filtered.forEach(row => {
          const cleanDesc = (row[COLS_LOGISTICS.description] || "").replace(/(\r\n|\n|\r)/gm, " ").replace(/"/g, '""');
          const line = [`"${row[COLS_LOGISTICS.start_date]}"`,`"${row[COLS_LOGISTICS.name]}"`,`"${row[COLS_LOGISTICS.city]}"`,`"${row[COLS_LOGISTICS.audience]}"`,`"${row[COLS_LOGISTICS.budget]}"`,`"${row[COLS_LOGISTICS.status]}"`,`"${cleanDesc}"`].join(",");
          csv += line + "\n";
      });
      const blob = new Blob([csv], { type: 'text/csv' }); const url = window.URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `Report_${startStr}_to_${endStr}.csv`; a.click(); window.URL.revokeObjectURL(url);
  }

  // --- AI WRITER ---
  function autoGenerateDesc() {
    const name = document.getElementById("inpName").value; const city = document.getElementById("inpCity").value; const date = document.getElementById("inpDate").value; const aud = document.getElementById("inpAudience").value; const stat = document.getElementById("inpStatus").value;
    if (!name || !city || !date) { alert("Please fill in Name, City, and Date first!"); return; }
    const templates = [
        `The ${name} was successfully ${stat.toLowerCase()} in ${city} on ${date}. This initiative engaged ${aud || 'various'} participants, focusing on innovation and skill development within the community.`,
        `On ${date}, the team conducted the ${name} in ${city}. With a turnout of ${aud || 0}, the event aimed to foster growth and support local talent under the CER program.`,
        `Zain Iraq is proud to have supported the ${name} in ${city}. Held on ${date}, this activity reached ${aud || 0} individuals, reinforcing our commitment to youth empowerment.`
    ];
    document.getElementById("inpDesc").value = templates[Math.floor(Math.random() * templates.length)];
  }

  // --- EDITING & ADMIN ---
  function startEdit(id) {
    const row = currentLogistics.find(r => r.id === id); if (!row) return;
    document.getElementById("editId").value = id; document.getElementById("inpName").value = row[COLS_LOGISTICS.name]; document.getElementById("inpDate").value = row[COLS_LOGISTICS.start_date]; document.getElementById("inpCity").value = row[COLS_LOGISTICS.city]; document.getElementById("inpStatus").value = row[COLS_LOGISTICS.status] || "Completed"; document.getElementById("inpAudience").value = row[COLS_LOGISTICS.audience]; document.getElementById("inpBudget").value = row[COLS_LOGISTICS.budget]; document.getElementById("inpDesc").value = row[COLS_LOGISTICS.description] || "";
    const btnSave = document.getElementById("btnSave"); btnSave.textContent = "Update Activity"; btnSave.classList.remove("btn-save"); btnSave.classList.add("btn-update");
    document.getElementById("btnCancelEdit").style.display = "block"; document.getElementById("entryForm").scrollIntoView({behavior: "smooth"});
  }
  function cancelEdit() {
    document.getElementById("editId").value = ""; document.getElementById("inpName").value = ""; document.getElementById("inpDate").value = ""; document.getElementById("inpCity").value = ""; document.getElementById("inpAudience").value = ""; document.getElementById("inpBudget").value = ""; document.getElementById("inpDesc").value = "";
    const btnSave = document.getElementById("btnSave"); btnSave.textContent = "Add Row to DB"; btnSave.classList.remove("btn-update"); btnSave.classList.add("btn-save"); document.getElementById("btnCancelEdit").style.display = "none";
  }
  function toggleAdminMode() {
    if (!isAdmin) { openLogin(); } else {
      const dash = document.getElementById("dashboardView"); const admin = document.getElementById("adminPanel"); const btn = document.getElementById("btnToggle");
      if (dash.style.display === "none") { dash.style.display = "block"; admin.style.display = "none"; btn.innerHTML = '<span class="material-icons">settings</span> Manage Data'; btn.classList.remove("active"); loadData(); } 
      else { dash.style.display = "none"; admin.style.display = "block"; btn.innerHTML = '<span class="material-icons">dashboard</span> View Dashboard'; btn.classList.add("active"); renderTable(); }
    }
  }
  function renderTable() {
    const tbody = document.getElementById("tableBody"); tbody.innerHTML = "";
    const sorted = [...currentLogistics].sort((a,b) => new Date(b[COLS_LOGISTICS.start_date]) - new Date(a[COLS_LOGISTICS.start_date]));
    sorted.forEach(row => {
      const tr = document.createElement("tr"); let desc = row[COLS_LOGISTICS.description] || "";
      tr.innerHTML = `<td>${row[COLS_LOGISTICS.start_date]}</td><td><strong>${row[COLS_LOGISTICS.name]}</strong></td><td>${row[COLS_LOGISTICS.city]}</td><td>${Number(row[COLS_LOGISTICS.audience]).toLocaleString()}</td><td class="desc-cell">${desc}</td><td style="text-align:center; white-space:nowrap;"><button class="btn-icon edit" onclick="startEdit(${row.id})" title="Edit"><span class="material-icons">edit</span></button><button class="btn-icon del" onclick="deleteActivity(${row.id})" title="Delete"><span class="material-icons">delete</span></button></td>`; tbody.appendChild(tr);
    });
  }
  async function saveActivity() {
    const editId = document.getElementById("editId").value; const name = document.getElementById("inpName").value; const date = document.getElementById("inpDate").value; const city = document.getElementById("inpCity").value; const aud = document.getElementById("inpAudience").value; const bud = document.getElementById("inpBudget").value; const stat = document.getElementById("inpStatus").value; const desc = document.getElementById("inpDesc").value;
    if (!name || !date) { alert("Name and Date are required!"); return; }
    const rowData = { [COLS_LOGISTICS.name]: name, [COLS_LOGISTICS.start_date]: date, [COLS_LOGISTICS.city]: city, [COLS_LOGISTICS.audience]: aud, [COLS_LOGISTICS.budget]: bud, [COLS_LOGISTICS.status]: stat, [COLS_LOGISTICS.description]: desc };
    try {
      if (editId) { const { error } = await supabaseClient.from('logistics_all').update(rowData).eq('id', editId); if (error) throw error; alert("Updated successfully!"); } 
      else { const { error } = await supabaseClient.from('logistics_all').insert([rowData]); if (error) throw error; alert("Added successfully!"); }
      cancelEdit(); await loadData(); renderTable();
    } catch (err) { console.error(err); alert("Error saving: " + err.message); }
  }
  async function deleteActivity(id) { if(!confirm("Are you sure?")) return; try { const { error } = await supabaseClient.from('logistics_all').delete().eq('id', id); if(error) throw error; await loadData(); renderTable(); } catch(err) { alert("Error deleting: " + err.message); } }
  function openLogin() { document.getElementById("loginModal").style.display = "flex"; document.getElementById("adminPassInput").value = ""; document.getElementById("adminPassInput").focus(); }
  function closeLogin() { document.getElementById("loginModal").style.display = "none"; }
  function checkLogin() { if (document.getElementById("adminPassInput").value === "Zain2026") { isAdmin = true; closeLogin(); toggleAdminMode(); } else { alert("Incorrect password"); } }
  document.getElementById("adminPassInput").addEventListener("keypress", function(event) { if (event.key === "Enter") checkLogin(); });
  function handleYearChange() { loadData().then(() => { document.getElementById("adminYearLabel").textContent = document.getElementById("viewYear").value; if (document.getElementById("adminPanel").style.display === "block") renderTable(); }); }

  // --- DATA & RENDER ---
  async function loadData() {
    try {
      const selectedYear = parseInt(document.getElementById("viewYear").value) || 2025;
      const prevYear = selectedYear - 1;
      document.getElementById("titleYear").textContent = selectedYear;

      const { data: curr, error: e1 } = await supabaseClient.from('logistics_all').select('*').eq('Year', selectedYear);
      if (e1) throw e1; currentLogistics = curr || [];
      document.getElementById("reportStart").value = `${selectedYear}-01-01`; document.getElementById("reportEnd").value = `${selectedYear}-12-31`;

      const { data: prev } = await supabaseClient.from('logistics_all').select('*').eq('Year', prevYear);
      comparisonLogistics = prev || [];

      const { data: soc } = await supabaseClient.from('social_media').select('*').range(0,5000);
      rawSocial = soc || [];
      const d1 = await fetchAllRows('registration', '2025');
      const d2 = await fetchAllRows('the_station_database', '2023');
      const d3 = await fetchAllRows('makers_of_baghdad_database', '2025');
      rawRegistration = [...d1, ...d2, ...d3];

      populateSimYearFilter(); renderKPIsAndCharts(selectedYear);
    } catch (err) { document.getElementById("globalError").textContent = "Error: " + err.message; console.error(err); }
  }

  function renderKPIsAndCharts(selectedYear) {
      const prevYear = selectedYear - 1;
      const tSoc = { reach: 0, engagement: 0, interaction: 0, impression: 0 };
      const tSocPrev = { reach: 0, engagement: 0, interaction: 0, impression: 0 };
      
      rawSocial.forEach(row => { 
        const y = String(row[COLS_SOCIAL.year]).trim();
        if (y == selectedYear) { 
           tSoc.reach += toNumberSmart(row[COLS_SOCIAL.reach]); tSoc.engagement += toNumberSmart(row[COLS_SOCIAL.engagement]); tSoc.interaction += toNumberSmart(row[COLS_SOCIAL.interaction]); tSoc.impression += toNumberSmart(row[COLS_SOCIAL.impression]); 
        } else if (y == prevYear) {
           tSocPrev.reach += toNumberSmart(row[COLS_SOCIAL.reach]); tSocPrev.engagement += toNumberSmart(row[COLS_SOCIAL.engagement]); tSocPrev.interaction += toNumberSmart(row[COLS_SOCIAL.interaction]); tSocPrev.impression += toNumberSmart(row[COLS_SOCIAL.impression]);
        }
      });
      document.getElementById("kpiSocialReach").textContent = tSoc.reach.toLocaleString(); document.getElementById("kpiSocialEngagement").textContent = tSoc.engagement.toLocaleString(); document.getElementById("kpiSocialInteraction").textContent = tSoc.interaction.toLocaleString(); document.getElementById("kpiSocialImpression").textContent = tSoc.impression.toLocaleString();
      const dReach = calculateDelta(tSoc.reach, tSocPrev.reach); document.getElementById("kpiSocialReachDelta").textContent = dReach.t; document.getElementById("kpiSocialReachDelta").className = dReach.c;
      const dEng = calculateDelta(tSoc.engagement, tSocPrev.engagement); document.getElementById("kpiSocialEngagementDelta").textContent = dEng.t; document.getElementById("kpiSocialEngagementDelta").className = dEng.c;
      const dInt = calculateDelta(tSoc.interaction, tSocPrev.interaction); document.getElementById("kpiSocialInteractionDelta").textContent = dInt.t; document.getElementById("kpiSocialInteractionDelta").className = dInt.c;
      const dImp = calculateDelta(tSoc.impression, tSocPrev.impression); document.getElementById("kpiSocialImpressionDelta").textContent = dImp.t; document.getElementById("kpiSocialImpressionDelta").className = dImp.c;

      const mCounts = Array(12).fill(0);
      currentLogistics.forEach(row => { const d = parseCustomDate(row[COLS_LOGISTICS.start_date], selectedYear); if(d && d.getFullYear() === selectedYear) mCounts[d.getMonth()]++; });
      if (activitiesChartInstance) activitiesChartInstance.destroy();
      activitiesChartInstance = new Chart(document.getElementById("activitiesChart"), { type: "bar", data: { labels: ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"], datasets:[{ label:`Activities (${selectedYear})`, data:mCounts, backgroundColor:"#d946ef", borderRadius:4 }] }, options: { maintainAspectRatio: false, plugins: { legend: { display:false } }, scales:{ y:{ grid:{ color:"#333"} }, x:{ grid:{ display:false } } } } });
      applyFilters(); updateSimCharts();
  }
  
  function applyFilters() {
    const qFilter = document.getElementById("quarterFilter").value; const isAll = (qFilter === "all");
    const displayMode = isAll ? "grid" : "none"; const blockMode = isAll ? "block" : "none";
    
    document.getElementById("rowSocial").style.display = displayMode; 
    document.getElementById("rowCharts").style.display = displayMode; 
    document.getElementById("rowCharts2").style.display = isAll ? "block" : "none"; 
    
    // NOTE: cardSims was removed from HTML, so we don't toggle it here anymore.
    document.getElementById("cardJobs").style.display = blockMode; 
    document.getElementById("cardBudget").style.gridColumn = isAll ? "span 2" : "span 4";

    const mCurr = computeMetrics(currentLogistics, qFilter); const mPrev = (comparisonLogistics.length > 0) ? computeMetrics(comparisonLogistics, qFilter) : { activities:0, audience:0, budget:0, cities:0 };
    document.getElementById("kpiActivities").textContent = mCurr.activities.toLocaleString(); document.getElementById("kpiAudience").textContent = mCurr.audience.toLocaleString(); document.getElementById("kpiBudget").textContent = mCurr.budget.toLocaleString(); document.getElementById("kpiCities").textContent = mCurr.cities.toLocaleString();
    const dAct = calculateDelta(mCurr.activities, mPrev.activities); document.getElementById("kpiActivitiesDelta").textContent = dAct.t; document.getElementById("kpiActivitiesDelta").className = dAct.c;
    const dAud = calculateDelta(mCurr.audience, mPrev.audience); document.getElementById("kpiAudienceDelta").textContent = dAud.t; document.getElementById("kpiAudienceDelta").className = dAud.c;
    const dBud = calculateDelta(mCurr.budget, mPrev.budget); document.getElementById("kpiBudgetDelta").textContent = dBud.t; document.getElementById("kpiBudgetDelta").className = dBud.c;
    const dCit = calculateDelta(mCurr.cities, mPrev.cities); document.getElementById("kpiCitiesDelta").textContent = dCit.t; document.getElementById("kpiCitiesDelta").className = dCit.c;
    const selectedYear = parseInt(document.getElementById("viewYear").value) || 2025; document.getElementById("audienceDeltaBadgeText").textContent = "vs " + (selectedYear - 1);
  }
  
  function computeMetrics(data, quarterFilter) {
    let activities = 0, totalAudience = 0, totalBudget = 0; const citySet = new Set(); const selectedYear = parseInt(document.getElementById("viewYear").value) || 2025;
    data.forEach(row => {
      const status = String(row[COLS_LOGISTICS.status] || "").toLowerCase(); const name = String(row[COLS_LOGISTICS.name] || "").toLowerCase();
      if (name.length < 2 || name.includes("total")) return; if (status.includes("cancel") || status.includes("postpon")) return;
      if (quarterFilter !== "all") { const dObj = parseCustomDate(row[COLS_LOGISTICS.start_date], selectedYear); if (!dObj || getQuarter(dObj) !== quarterFilter) return; }
      activities++; totalAudience += toNumberSmart(row[COLS_LOGISTICS.audience]); totalBudget += toNumberSmart(row[COLS_LOGISTICS.budget]);
      const city = String(row[COLS_LOGISTICS.city] || "").trim().toLowerCase(); const isOnline = city.includes("online") || city.includes("virtual") || city.includes("zoom"); if (city && city !== "city" && city !== "null" && !isOnline) citySet.add(city);
    }); return { activities, audience: totalAudience, budget: totalBudget, cities: citySet.size };
  }
  function updateSimCharts() {
    const yearFilter = document.getElementById("simYearFilter").value; let zain=0, asiacell=0, korek=0, totalSim=0, male=0, female=0;
    rawRegistration.forEach(row => { if (yearFilter !== "all" && row._derivedYear !== yearFilter) return; const phoneVal = getSmartValue(row, ["Phone", "Mobile", "Number", "phone_number"]); let p = String(phoneVal).replace(/\D/g,""); if(p.startsWith("00964")) p=p.slice(5); else if(p.startsWith("964")) p=p.slice(3); if(p.length===11 && p.startsWith("0")) p=p.slice(1); if(p.length===10 && p.startsWith("7")) { totalSim++; if(p.startsWith("78")||p.startsWith("79")) zain++; else if(p.startsWith("77")) asiacell++; else if(p.startsWith("75")) korek++; } const genderVal = getSmartValue(row, ["Gender", "Sex"]); const g = String(genderVal).toLowerCase().trim(); if (g.includes("female") || g === "f" || g.includes("انثى") || g.includes("woman")) female++; else if (g.includes("male") || g === "m" || g.includes("ذكر") || g.includes("man")) male++; });
    
    // UPDATE NEW CARD UI
    const total = zain + asiacell + korek;
    const zPct = total > 0 ? ((zain/total)*100).toFixed(1) : 0;
    document.getElementById("kpiSimShare").textContent = zPct + "%";
    
    // Generate Custom Legend HTML
    const colors = { Zain: "#d946ef", Asiacell: "#ef4444", Korek: "#3b82f6" };
    const legendData = [
       { label: "Zain", val: zain, col: colors.Zain },
       { label: "Asiacell", val: asiacell, col: colors.Asiacell },
       { label: "Korek", val: korek, col: colors.Korek }
    ];
    let legendHTML = "";
    legendData.forEach(d => {
       const pct = total > 0 ? ((d.val/total)*100).toFixed(1) + "%" : "0%";
       legendHTML += `
         <div class="legend-item">
            <div class="legend-left"><span class="legend-dot" style="background:${d.col}"></span> ${d.label}</div>
            <div class="legend-right"><span class="legend-pct">${pct}</span><span class="legend-count">${d.val.toLocaleString()}</span></div>
         </div>
       `;
    });
    document.getElementById("simLegend").innerHTML = legendHTML;

    // Update Chart
    if (simChartInstance) simChartInstance.destroy(); simChartInstance = new Chart(document.getElementById("simChart"), { type: "doughnut", data: { labels: ["Zain","Asiacell","Korek"], datasets:[{ data:[zain, asiacell, korek], backgroundColor:[colors.Zain, colors.Asiacell, colors.Korek], borderWidth:0, cutout: '70%' }] }, options: { maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { enabled: true } } } });
    if (genderChartInstance) genderChartInstance.destroy(); genderChartInstance = new Chart(document.getElementById("genderChart"), { type: "doughnut", data: { labels: ["Male","Female"], datasets:[{ data:[male, female], backgroundColor:["#38bdf8","#f472b6"], borderWidth:0 }] }, options: { maintainAspectRatio: false, plugins: { legend: { labels: { color:"#ccc"} } } } });
  }
  function populateSimYearFilter() { const uniqueYears = new Set(); rawRegistration.forEach(r => { if(r._derivedYear) uniqueYears.add(r._derivedYear); }); const yearSelect = document.getElementById("simYearFilter"); yearSelect.innerHTML = '<option value="all" selected>All Years</option>'; Array.from(uniqueYears).sort().forEach(y => { const opt = document.createElement("option"); opt.value = y; opt.textContent = y; yearSelect.appendChild(opt); }); }
  async function fetchAllRows(table, defaultYear) { let allData = []; let page = 0; const pageSize = 5000; while (true) { try { const { data, error } = await supabaseClient.from(table).select('*').range(page * pageSize, (page + 1) * pageSize - 1); if (error) throw error; if (!data || data.length === 0) break; const tagged = data.map(row => { let y = getSmartValue(row, ["Year", "year"]); if (!y) y = defaultYear; return { ...row, _derivedYear: String(y) }; }); allData = allData.concat(tagged); if (data.length < pageSize) break; page++; } catch (err) { console.warn(`Skipping table '${table}':`, err.message); break; } } return allData; }
  function getSmartValue(row, possibleNames) { if (!row) return ""; const keys = Object.keys(row); for (let name of possibleNames) if (row[name] !== undefined) return row[name]; for (let key of keys) { const lowerKey = key.toLowerCase(); for (let name of possibleNames) if (lowerKey === name.toLowerCase()) return row[key]; } return ""; }
  function toNumberSmart(v) { if (!v) return 0; let s = String(v).trim().replace(/,/g, ""); const m = s.match(/^(-?\d+(\.\d+)?)([kKmMbB])$/); if (m) { const num = Number(m[1]); const mult = m[3].toLowerCase() === "k" ? 1000 : m[3].toLowerCase() === "m" ? 1000000 : 1; return num * mult; } return Number(s) || 0; }
  function parseCustomDate(val, targetYear) { if (!val) return null; let text = String(val).trim(); if (/^\d{1,2}-[a-zA-Z]{3}$/.test(text)) text = `${text}-${targetYear}`; let d = new Date(text); if (isNaN(d.getTime()) || d.getFullYear() === 2001) d = new Date(`${text} ${targetYear}`); if (isNaN(d.getTime())) return null; return d; }
  function getQuarter(dateObj) { if (!dateObj) return null; const m = dateObj.getMonth(); if (m < 3) return "q1"; if (m < 6) return "q2"; if (m < 9) return "q3"; return "q4"; }

  loadData();
</script>
